<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Costeo - GOODIES</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-name { color: #aaa; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; margin: 2px; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-purple { background: #9c27b0; color: white; }
        .btn-purple:hover { background: #7b1fa2; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .login-container { max-width: 400px; margin: 100px auto; background: #1e1e2f; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-container h2 { text-align: center; margin-bottom: 30px; color: #4CAF50; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 13px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #333; border-radius: 5px; background: #2a2a3e; color: #fff; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4CAF50; }
        .form-group input[type="checkbox"] { width: auto; margin-right: 10px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .app-container { display: none; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #1e1e2f; border-radius: 10px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .card h3 { margin-bottom: 20px; color: #4CAF50; }
        .card h4 { margin: 20px 0 10px; color: #2196F3; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .upload-area { border: 2px dashed #444; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 15px; }
        .upload-area:hover { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .upload-area.dragover { border-color: #4CAF50; background: rgba(76, 175, 80, 0.2); }
        .upload-area p { color: #888; margin-top: 10px; }
        .file-name { color: #4CAF50; margin-top: 10px; font-weight: bold; }
        .table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #2a2a3e; color: #4CAF50; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: rgba(76, 175, 80, 0.1); }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        .status-definitivo { background: #4CAF50; color: #fff; }
        .status-presupuesto { background: #ff9800; color: #000; }
        .actions { display: flex; gap: 3px; flex-wrap: wrap; }
        .message { padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none; }
        .message.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; color: #4CAF50; display: block; }
        .message.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; color: #f44336; display: block; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { border: 3px solid #333; border-top: 3px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: flex-start; z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: #1e1e2f; padding: 30px; border-radius: 10px; width: 95%; max-width: 1200px; margin: auto; }
        .modal-content.modal-fullsize { width: 98%; max-width: none; resize: both; overflow: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #4CAF50; }
        .modal-close { background: none; border: none; color: #888; font-size: 28px; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .detail-item { padding: 10px; background: #2a2a3e; border-radius: 5px; }
        .detail-label { color: #888; font-size: 12px; }
        .detail-value { color: #fff; font-size: 16px; font-weight: bold; }
        .detail-value.highlight { color: #4CAF50; }
        .filtros { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; padding: 15px; background: #2a2a3e; border-radius: 8px; }
        .filtros select { background: #1e1e2f; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; min-width: 150px; }
        .filtro-grupo { display: flex; flex-direction: column; gap: 5px; }
        .filtro-grupo label { color: #aaa; font-size: 13px; }
        .filtro-check { display: flex; align-items: center; gap: 8px; }
        .filtro-check input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .criterio-container { display: none; margin-left: 25px; }
        .criterio-container.show { display: block; }
        .acciones-masivas { display: flex; gap: 10px; margin-bottom: 15px; padding: 15px; background: #2a2a3e; border-radius: 8px; align-items: center; flex-wrap: wrap; }
        .acciones-masivas span { color: #aaa; font-size: 14px; }
        .acciones-masivas .contador { color: #4CAF50; font-weight: bold; }
        .checkbox-cell { width: 40px; text-align: center; }
        .checkbox-cell input { width: 18px; height: 18px; cursor: pointer; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #333; }
        .tab { padding: 10px 20px; background: transparent; border: none; color: #888; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: #fff; }
        .tab.active { color: #4CAF50; border-bottom-color: #4CAF50; }
        .modulo-tab:hover { background: #1a3a1a !important; color: #fff !important; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .articulos-tabla input, .gastos-tabla input, .gastos-tabla select { width: 100%; padding: 6px; border: 1px solid #444; border-radius: 4px; background: #1e1e2f; color: #fff; font-size: 12px; }
        .articulos-tabla input:focus, .gastos-tabla input:focus { border-color: #4CAF50; outline: none; }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="login-container" id="loginContainer">
        <h2>Sistema de Costeo</h2>
        <div class="message" id="loginMessage"></div>
        <form id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" value="lpardina@goodies.com.ar" required>
            </div>
            <div class="form-group">
                <label>Contrasena</label>
                <input type="password" id="password" value="admin123" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesion</button>
        </form>
    </div>
    <div class="app-container" id="appContainer">
        <div class="container">
            <header>
                <div class="logo">Sistema de Costeo</div>
                <div class="user-info">
                    <span class="user-name" id="userName"></span>
                    <button class="btn btn-danger" onclick="logout()">Cerrar Sesion</button>
                </div>
            </header>
            <!-- NAVEGACI√ìN DE M√ìDULOS -->
            <div style="display:flex;gap:0;margin-bottom:20px;background:#0d1117;border-radius:10px;overflow:hidden;border:1px solid #333;">
                <button class="modulo-tab active" id="btnModComex" onclick="cambiarModulo('comex')" style="flex:1;padding:12px 20px;border:none;background:#4CAF50;color:#fff;font-size:15px;font-weight:bold;cursor:pointer;transition:all 0.3s;">üì¶ COMEX</button>
                <button class="modulo-tab" id="btnModComercial" onclick="cambiarModulo('comercial')" style="flex:1;padding:12px 20px;border:none;background:transparent;color:#888;font-size:15px;font-weight:bold;cursor:pointer;transition:all 0.3s;">üí∞ COMERCIAL</button>
                <button class="modulo-tab" id="btnModContable" onclick="cambiarModulo('contable')" style="flex:1;padding:12px 20px;border:none;background:transparent;color:#888;font-size:15px;font-weight:bold;cursor:pointer;transition:all 0.3s;">üìä CONTABLE</button>
                <button class="modulo-tab" id="btnModAdmin" onclick="cambiarModulo('admin')" style="flex:1;padding:12px 20px;border:none;background:transparent;color:#888;font-size:15px;font-weight:bold;cursor:pointer;transition:all 0.3s;">‚öôÔ∏è ADMIN</button>
            </div>
            <!-- M√ìDULO COMEX (contenido existente) -->
            <div id="modComex">
            <div class="cards">
                <div class="card">
                    <h3>Importar / Cargar Legajo</h3>
                    <div class="message" id="importMessage"></div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="abrirCargaManual()" style="flex:1;">+ Carga Manual</button>
                        <button class="btn btn-secondary" onclick="toggleImportExcel()" style="flex:1;">Importar Excel</button>
                    </div>
                    <div id="importExcelArea" style="display:none;">
                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 48px;">üìÅ</div>
                            <p>Arrastra tu archivo Excel aqui</p>
                            <p class="file-name" id="fileName"></p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                        </div>
                        <button class="btn btn-primary" id="importBtn" onclick="importarExcel()" disabled style="width: 100%;">Importar</button>
                    </div>
                    <div class="loading" id="importLoading"><div class="spinner"></div><p>Procesando...</p></div>
                </div>
                <div class="card">
                    <h3>Resumen</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Total Costeos</div>
                            <div class="detail-value highlight" id="totalCosteos">0</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Presupuestos</div>
                            <div class="detail-value" id="costeosPresupuestos">0</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="cargarCosteos()" style="width: 100%; margin-top: 15px;">Actualizar Lista</button>
                </div>
                <div class="card">
                    <h3>üì¶ Cat√°logo Unificado</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Art√≠culos en cat√°logo</div>
                            <div class="detail-value highlight" id="totalMaestro">0</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:15px;">
                        <button class="btn btn-success" style="flex:1;" onclick="descargarCatalogo()">üì• Descargar Cat√°logo</button>
                        <label class="btn btn-primary" style="flex:1; cursor:pointer; text-align:center; margin:0;">
                            üì§ Subir Cat√°logo
                            <input type="file" accept=".xlsx,.xls" onchange="importarCatalogoMaestro(this)" style="display:none;">
                        </label>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>Listado de Costeos</h3>
                <div class="filtros">
                    <div class="filtro-grupo">
                        <label>Proveedor</label>
                        <input type="text" id="filtroProveedor" list="listaProveedores" placeholder="Escrib√≠ para buscar..." onkeyup="aplicarFiltros()" onchange="aplicarFiltros()" style="padding: 8px; border: 1px solid #444; border-radius: 5px; background: #1e1e2f; color: #fff; min-width: 200px;">
                        <datalist id="listaProveedores"></datalist>
                    </div>
                    <div class="filtro-grupo">
                        <label>Marca/Art√≠culo</label>
                        <input type="text" id="filtroMarca" placeholder="Buscar marca o art√≠culo..." onkeyup="aplicarFiltros()" style="padding: 8px; border: 1px solid #444; border-radius: 5px; background: #1e1e2f; color: #fff; min-width: 180px;">
                    </div>
                    <div class="filtro-grupo">
                        <label>Tipo</label>
                        <select id="filtroTipo" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="definitivo">Definitivo</option>
                            <option value="presupuesto">Presupuesto</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <div class="filtro-check">
                            <input type="checkbox" id="filtroUltimo" onchange="toggleCriterio(); aplicarFiltros();">
                            <label for="filtroUltimo">Solo ultima version</label>
                        </div>
                        <div class="criterio-container" id="criterioContainer">
                            <select id="filtroCriterio" onchange="aplicarFiltros()">
                                <option value="fecha_carga">Por fecha de carga</option>
                                <option value="fecha_factura">Por fecha de factura</option>
                                <option value="fecha_despacho">Por fecha de despacho</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
                </div>
                <div class="acciones-masivas" id="accionesMasivas" style="display: none;">
                    <span>Seleccionados: <span class="contador" id="contadorSeleccionados">0</span></span>
                </div>
                <div class="loading" id="tableLoading"><div class="spinner"></div><p>Cargando...</p></div>
                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>Nombre</th>
                                <th>Proveedor</th>
                                <th>Moneda</th>
                                <th>Unidades</th>
                                <th>Fecha Fact.</th>
                                <th>Fecha Desp.</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="costeosBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h3>√öltimo Costo por Art√≠culo</h3>
                <div class="filtros" style="margin-bottom: 15px;">
                    <div class="filtro-grupo">
                        <label>Buscar Art√≠culo</label>
                        <input type="text" id="buscarArticulo" placeholder="C√≥digo o nombre..." onkeyup="filtrarArticulos()" style="padding: 8px; border: 1px solid #444; border-radius: 5px; background: #1e1e2f; color: #fff; min-width: 250px;">
                    </div>
                    <div class="filtro-grupo">
                        <label>Proveedor</label>
                        <input type="text" id="filtroProveedorArticulo" list="listaProveedoresArticulo" placeholder="Escrib√≠ para buscar..." onkeyup="filtrarArticulos()" onchange="filtrarArticulos()" style="padding: 8px; border: 1px solid #444; border-radius: 5px; background: #1e1e2f; color: #fff; min-width: 200px;">
                        <datalist id="listaProveedoresArticulo"></datalist>
                    </div>
                    <button class="btn btn-secondary" onclick="cargarUltimosCostos()">Actualizar</button>
                    <button class="btn btn-success" onclick="exportarUltimosCostosXLSX()">üì• Exportar Excel</button>
                    <button class="btn btn-warning" onclick="exportarSeleccionadosXLSX()" style="display:none;" id="btnExportarSeleccion">Exportar Seleccionados (<span id="countSeleccion">0</span>)</button>
                    <button class="btn" onclick="limpiarFiltrosArticulos()" style="background:#666;">‚úï Limpiar Filtros</button>
                </div>
                <div class="loading" id="articulosLoading"><div class="spinner"></div><p>Cargando...</p></div>
                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="seleccionarTodosArt" onchange="toggleSeleccionTodos(this)"></th>
                                <th>C√≥digo</th>
                                <th>Proveedor</th>
                                <th>Nombre</th>
                                <th>Mon. FOB</th>
                                <th>Valor FOB</th>
                                <th>Costo Neto</th>
                                <th>Costo c/Imp</th>
                                <th>Costo Ant.</th>
                                <th>Dif %</th>
                                <th>Fecha Desp.</th>
                                <th>Costeo</th>
                                <th>TC</th>
                                <th>Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="articulosUltimoCostoBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- HISTORIAL DE REVALUACIONES -->
            <div class="card">
                <h3>Historial de Revaluaciones</h3>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="abrirModalRevaluar()">+ Nueva Revaluaci√≥n</button>
                </div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Motivo</th>
                                <th>TC USD</th>
                                <th>TC EUR</th>
                                <th>TC GBP</th>
                                <th>Art√≠culos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="historialRevaluacionesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div><!-- FIN M√ìDULO COMEX -->

    <!-- =============================================
         M√ìDULO COMERCIAL
         ============================================= -->
    <div id="modComercial" style="display:none;">
        <div class="cards">
            <!-- LISTAS DE PRECIOS -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üí∞ Listas de Precios</h3>
                <div style="display:flex;gap:10px;margin-bottom:15px;">
                    <button class="btn btn-primary" onclick="abrirNuevaLista()">+ Nueva Lista</button>
                    <button class="btn btn-secondary" onclick="cargarListasPorDefecto()">Cargar Listas por Defecto</button>
                </div>
                <div class="table-container" style="max-height:400px;overflow-y:auto;">
                    <table>
                        <thead><tr>
                            <th>Nombre</th><th>% Log√≠stico</th><th>% IIBB</th><th>% Financiero</th><th>% Comisi√≥n</th><th>% Margen Cliente</th><th>Activa</th><th>Acciones</th>
                        </tr></thead>
                        <tbody id="listasBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ACUERDOS COMERCIALES -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>ü§ù Acuerdos Comerciales (% Acuerdo por Lista + Categor√≠a)</h3>
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                    <select id="acuerdoListaSelect" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;">
                        <option value="">Seleccionar Lista...</option>
                    </select>
                    <select id="acuerdoCategoriaSelect" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;">
                        <option value="Frescos">Frescos</option>
                        <option value="Almac√©n">Almac√©n</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Otros">Otros</option>
                    </select>
                    <input type="number" id="acuerdoPct" placeholder="% Acuerdo" step="0.1" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:120px;">
                    <button class="btn btn-primary" onclick="agregarAcuerdo()">+ Agregar</button>
                </div>
                <div class="table-container" style="max-height:300px;overflow-y:auto;">
                    <table>
                        <thead><tr><th>Lista</th><th>Categor√≠a</th><th>% Acuerdo</th><th>Acciones</th></tr></thead>
                        <tbody id="acuerdosBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- C√ÅLCULO DE M√ÅRGENES -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üìä C√°lculo de M√°rgenes (Multi-Lista)</h3>
                <p style="color:#aaa;margin-bottom:15px;">Ingres√° el PVP de cada art√≠culo y calcul√° el margen para TODAS las listas simult√°neamente.</p>
                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="filtroMargenTexto" placeholder="üîç Buscar por c√≥digo o nombre..." oninput="filtrarArticulosPvp()" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px 12px;border-radius:5px;width:250px;">
                    <select id="filtroMargenProveedor" onchange="filtrarArticulosPvp()" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;">
                        <option value="">Todos los proveedores</option>
                    </select>
                </div>
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="cargarArticulosParaMargen()">üì¶ Cargar Art√≠culos del Cat√°logo</button>
                    <button class="btn btn-warning" onclick="descargarTemplatePvp()">üì• Descargar Template PVP</button>
                    <label class="btn btn-purple" style="cursor:pointer;">üì§ Subir Template PVP<input type="file" id="pvpExcelFile" accept=".xlsx,.xls" onchange="subirTemplatePvp()" style="display:none;"></label>
                    <button class="btn btn-primary" onclick="calcularMargenes()">üìä Calcular M√°rgenes</button>
                    <button class="btn btn-success" onclick="exportarMargenes()">üì• Exportar Excel</button>
                </div>
                <div class="table-container" style="max-height:300px;overflow-y:auto;">
                    <table>
                        <thead><tr>
                            <th>C√≥digo</th><th>Nombre</th><th>Proveedor</th><th>Costo Neto</th><th>PVP</th>
                        </tr></thead>
                        <tbody id="articulosPvpBody"></tbody>
                    </table>
                </div>
                <div id="resultadoMargenes" style="margin-top:20px;"></div>
            </div>

            <!-- SIMULADOR DE DESCUENTO -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üéØ Simulador de Descuento (Break-Even)</h3>
                <p style="color:#aaa;margin-bottom:15px;">Calcul√° el descuento m√°ximo que pod√©s ofrecer seg√∫n diferentes aumentos de volumen.</p>
                <div class="form-row" style="margin-bottom:15px;">
                    <div class="form-group">
                        <label>Art√≠culo</label>
                        <select id="simArticulo" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:100%;"></select>
                    </div>
                    <div class="form-group">
                        <label>Lista</label>
                        <select id="simLista" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:100%;"></select>
                    </div>
                    <div class="form-group">
                        <label>Precio Actual</label>
                        <input type="number" id="simPrecio" step="0.01" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:100%;">
                    </div>
                    <div class="form-group">
                        <label>Cantidad Actual</label>
                        <input type="number" id="simCantidad" step="1" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:100%;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="simularDescuento()">üéØ Simular</button>
                <div id="resultadoSimulador" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <!-- =============================================
         M√ìDULO CONTABLE
         ============================================= -->
    <div id="modContable" style="display:none;">
        <div class="cards">
            <!-- NUEVA VALUACI√ìN -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üìä Nueva Valuaci√≥n de Inventario</h3>
                <p style="color:#aaa;margin-bottom:15px;">Comparar costos contables (Centum) vs costos revaluados del sistema.</p>
                <div class="form-row" style="margin-bottom:15px;">
                    <div class="form-group">
                        <label>Nombre de la Valuaci√≥n *</label>
                        <input type="text" id="valNombre" placeholder="Ej: Valuaci√≥n Febrero 2026" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:100%;">
                    </div>
                    <div class="form-group">
                        <label>Base de Comparaci√≥n</label>
                        <select id="valRevaluacion" style="background:#1e1e2f;border:1px solid #444;color:#fff;padding:8px;border-radius:5px;width:100%;">
                            <option value="">√öltimo costo original</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#aaa;font-size:13px;">Subir Excel de Centum (Reporte Stock Inventario Valorizado)</label>
                    <div style="display:flex;gap:10px;margin-top:5px;align-items:center;">
                        <input type="file" id="valExcelFile" accept=".xlsx,.xls" style="color:#aaa;">
                        <button class="btn btn-secondary" onclick="parsearExcelCentum()">üì§ Cargar Excel</button>
                    </div>
                    <div id="valExcelPreview" style="margin-top:10px;"></div>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#aaa;font-size:13px;">O pegar datos manualmente (C√≥digo | Descripci√≥n | Cantidad | Costo Unit | Costo Total, separados por tab)</label>
                    <textarea id="valDatosCentum" rows="5" placeholder="Pegar datos aqu√≠..." style="width:100%;background:#1e1e2f;border:1px solid #444;color:#fff;padding:10px;border-radius:5px;font-family:monospace;font-size:12px;margin-top:5px;"></textarea>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="crearValuacion()">üìä Generar Valuaci√≥n</button>
                    <button class="btn btn-secondary" onclick="cargarRevaluacionesDisponibles()">üîÑ Actualizar Revaluaciones</button>
                </div>
            </div>

            <!-- RESULTADO VALUACI√ìN -->
            <div class="card" style="grid-column: 1 / -1; display:none;" id="resultadoValuacionCard">
                <h3>üìã Resultado de Valuaci√≥n</h3>
                <div id="resumenValuacion" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;"></div>
                <div class="table-container" style="max-height:400px;overflow-y:auto;">
                    <table>
                        <thead><tr>
                            <th>C√≥digo</th><th>Descripci√≥n</th><th>Cantidad</th>
                            <th>Costo Unit Contable</th><th>Costo Total Contable</th>
                            <th>Costo Unit Revaluado</th><th>Costo Total Revaluado</th>
                            <th>Dif Unit</th><th>Dif Total</th><th>Dif %</th>
                        </tr></thead>
                        <tbody id="valuacionDetalleBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success" onclick="exportarValuacion()" style="margin-top:15px;">üì• Exportar Excel</button>
            </div>

            <!-- HISTORIAL VALUACIONES -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üìö Historial de Valuaciones</h3>
                <button class="btn btn-secondary" onclick="cargarHistorialValuaciones()" style="margin-bottom:15px;">üîÑ Actualizar</button>
                <div class="table-container" style="max-height:400px;overflow-y:auto;">
                    <table>
                        <thead><tr>
                            <th>Fecha</th><th>Nombre</th><th>Total Contable</th><th>Total Revaluado</th><th>Diferencia</th><th>Art√≠culos</th><th>Acciones</th>
                        </tr></thead>
                        <tbody id="historialValuacionesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- =============================================
         M√ìDULO ADMIN
         ============================================= -->
    <div id="modAdmin" style="display:none;">
        <div class="cards">
            <div class="card">
                <h3>üë• Usuarios del Sistema</h3>
                <p style="color:#aaa;margin-bottom:10px;">Roles: admin (acceso total), comex, comercial, contable, visualizador</p>
                <div id="listaUsuarios" style="color:#ccc;">Pr√≥ximamente: gesti√≥n de usuarios</div>
            </div>
            <div class="card">
                <h3>‚öôÔ∏è Configuraci√≥n</h3>
                <div style="padding:15px;background:#2a2a3e;border-radius:8px;">
                    <p style="color:#aaa;">Sistema de Costeo - GOODIES S.A.</p>
                    <p style="color:#aaa;margin-top:10px;">Versi√≥n: 2.0 (con m√≥dulos COMEX + COMERCIAL + CONTABLE)</p>
                    <p style="color:#aaa;margin-top:10px;">Hosting: Railway</p>
                    <p style="color:#aaa;margin-top:10px;">Base de datos: PostgreSQL</p>
                </div>
            </div>
        </div>
    </div>
  
<div class="modal" id="revaluarModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Revaluaci√≥n de Costos</h3>
                <button class="modal-close" onclick="cerrarModal('revaluarModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p id="revaluarInfo" style="margin-bottom:15px;color:#aaa;"></p>
                
                <div class="form-group">
                    <label>Motivo de Revaluaci√≥n *</label>
                    <select id="rev_motivo" style="width:100%;padding:10px;background:#1e1e2f;color:#fff;border:1px solid #444;border-radius:4px;">
                        <option value="">Seleccionar...</option>
                        <option value="Revaluaci√≥n Contable">Revaluaci√≥n Contable</option>
                        <option value="An√°lisis de Margen">An√°lisis de Margen</option>
                        <option value="Actualizaci√≥n Costos Reposici√≥n">Actualizaci√≥n Costos de Reposici√≥n</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                
                <div class="form-group" id="rev_otroMotivoGroup" style="display:none;">
                    <label>Especificar Motivo</label>
                    <input type="text" id="rev_otroMotivo" style="width:100%;padding:10px;background:#1e1e2f;color:#fff;border:1px solid #444;border-radius:4px;">
                </div>
                
                <h4 style="margin-top:20px;margin-bottom:10px;">Nuevos Tipos de Cambio</h4>
                <div style="display:flex;gap:15px;">
                    <div class="form-group" style="flex:1;">
                        <label>TC USD *</label>
                        <input type="number" id="rev_tcUsd" step="0.0001" style="width:100%;padding:10px;background:#1e1e2f;color:#fff;border:1px solid #444;border-radius:4px;">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>TC EUR</label>
                        <input type="number" id="rev_tcEur" step="0.0001" style="width:100%;padding:10px;background:#1e1e2f;color:#fff;border:1px solid #444;border-radius:4px;">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>TC GBP</label>
                        <input type="number" id="rev_tcGbp" step="0.0001" style="width:100%;padding:10px;background:#1e1e2f;color:#fff;border:1px solid #444;border-radius:4px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('revaluarModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="ejecutarRevaluacion()">Revaluar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="resultadoRevaluacionModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Resultado de Revaluaci√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('resultadoRevaluacionModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="resumenRevaluacion" style="margin-bottom:15px;padding:10px;background:#1e1e2f;border-radius:4px;"></div>
                <div style="max-height:400px;overflow-y:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre Art√≠culo</th>
                                <th>Costo Neto Original</th>
                                <th>Costo Neto Revaluado</th>
                                <th>Diferencia %</th>
                            </tr>
                        </thead>
                        <tbody id="resultadoRevaluacionBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('resultadoRevaluacionModal')">Cerrar</button>
                <button class="btn btn-success" id="btnExportarRevaluacion" onclick="exportarRevaluacionActual()">Exportar Excel</button>
            </div>
        </div>
    </div>
<div class="modal" id="detalleArticuloModal">
        <div class="modal-content" style="max-width: 950px;">
            <div class="modal-header">
                <h3 id="detalleArticuloTitle">Detalle del Art√≠culo</h3>
                <button class="modal-close" onclick="cerrarModal('detalleArticuloModal')">√ó</button>
            </div>
            <div id="detalleArticuloBody" style="padding: 20px;"></div>
        </div>
    </div> 
 <div class="modal" id="detalleModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="modalTitle">Detalle del Costeo</h3>
                <button class="modal-close" onclick="cerrarModal('detalleModal')">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    <div class="modal" id="compPvsDefModal">
        <div class="modal-content modal-fullsize" style="max-width: 1400px;">
            <div class="modal-header">
                <h3 id="compPvsDefTitle">Comparativo Presupuesto vs Definitivo</h3>
                <button class="modal-close" onclick="cerrarModal('compPvsDefModal')">√ó</button>
            </div>
            <div id="compPvsDefBody" style="padding: 20px; overflow-x: auto;"></div>
        </div>
    </div>
    <div class="modal" id="recalcularModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Recalcular con Tipo de Cambio</h3>
                <button class="modal-close" onclick="cerrarModal('recalcularModal')">√ó</button>
            </div>
            <p style="color: #aaa; margin-bottom: 15px;">Ingresa los tipos de cambio:</p>
            <div class="form-row">
                <div class="form-group"><label>TC USD</label><input type="number" id="tcUsdNuevo" step="0.01"></div>
                <div class="form-group"><label>TC EUR</label><input type="number" id="tcEurNuevo" step="0.01"></div>
                <div class="form-group"><label>TC GBP</label><input type="number" id="tcGbpNuevo" step="0.01"></div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="cerrarModal('recalcularModal')">Cancelar</button>
                <button class="btn btn-purple" onclick="ejecutarRecalcular()">Recalcular</button>
            </div>
        </div>
    </div>
    <div class="modal" id="cargaManualModal">
        <div class="modal-content modal-fullsize">
            <div class="modal-header">
                <h3>Carga Manual de Legajo</h3>
                <button class="modal-close" onclick="cerrarModal('cargaManualModal')">√ó</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('datosGenerales')">1. Datos Generales</button>
                <button class="tab" onclick="cambiarTab('baseAduana')">2. Base Aduana</button>
                <button class="tab" onclick="cambiarTab('articulos')">3. Articulos</button>
                <button class="tab" onclick="cambiarTab('gastos')">4. Gastos</button>
            </div>
            <div id="tabDatosGenerales" class="tab-content active">
                <h4>Datos del Costeo</h4>
                <div class="form-row">
                    <div class="form-group"><label>Nombre del Costeo *</label><input type="text" id="cm_nombre" placeholder="Ej: BACKUS 1-25"></div>
                    <div class="form-group"><label>Proveedor de Origen *</label><input type="text" id="cm_proveedor" list="listaProveedoresMaestro" placeholder="Seleccione o escriba proveedor" onchange="cargarMarcasDelProveedor()"><datalist id="listaProveedoresMaestro"></datalist></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><input type="checkbox" id="cm_tieneIntermediaria" onchange="toggleIntermediaria(); recalcularValoresOrigen();"> Tiene Datos de F√°brica Original</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="cm_esConsolidado" onchange="toggleConsolidado()"> Es Costeo Consolidado</label>
                    </div>
                   <div class="form-group" id="cm_intermediariaGroup" style="display:none;">
                        <label>Nombre Empresa F√°brica</label>
                        <input type="text" id="cm_intermediaria" placeholder="Ej: BACKUS, PRAVDA">
                    </div>
                    <div class="form-group" id="cm_facturaIntermGroup" style="display:none;">
                        <label>Nro Factura F√°brica</label>
                        <input type="text" id="cm_facturaInterm" placeholder="Nro factura">
                    </div>
                    <div class="form-group" id="cm_fechaFacturaIntermGroup" style="display:none;">
                        <label>Fecha Factura F√°brica</label>
                        <input type="date" id="cm_fechaFacturaInterm">
                    </div>
                   <div class="form-group" id="cm_fechaVencIntermGroup" style="display:none;">
                        <label>Fecha Venc. F√°brica</label>
                        <input type="date" id="cm_fechaVencInterm">
                    </div>
                </div>
                <!-- Secci√≥n Consolidado -->
                <div id="cm_consolidadoSection" style="display:none; margin-bottom:15px; padding:15px; background:#1a3a1a; border-radius:8px; border:1px solid #2d5a2d;">
                    <h4 style="color:#4CAF50; margin-top:0;">Datos del Proveedor Actual (para consolidado)</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Volumen (m¬≥)</label>
                            <input type="number" step="0.01" id="cm_volumenM3" placeholder="Ej: 25.5">
                        </div>
                        <div class="form-group">
                            <label>Peso (Kg)</label>
                            <input type="number" step="0.01" id="cm_pesoKg" placeholder="Ej: 1500">
                        </div>
                    </div>
                    <h4 style="color:#ff9800; margin-top:15px;">Otros Proveedores del Consolidado</h4>
                    <div id="consolidadoProveedoresBody"></div>
                    <button type="button" class="btn btn-success" onclick="agregarProveedorConsolidado()" style="margin-top:10px;">+ Agregar Proveedor</button>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Factura Nro</label><input type="text" id="cm_facturaNro"></div>
                    <div class="form-group"><label>Moneda Principal *</label>
                        <select id="cm_moneda"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                    </div>
                    <div class="form-group"><label>Monto Factura</label><input type="number" id="cm_monto" step="0.01"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fecha Factura</label><input type="date" id="cm_fechaFactura"></div>
                    <div class="form-group"><label>Fecha Vencimiento</label><input type="date" id="cm_fechaVenc"></div>
                    <div class="form-group"><label>Fecha Despacho</label><input type="date" id="cm_fechaDespacho"></div>
                    <div class="form-group"><label>Nro Despacho</label><input type="text" id="cm_nroDespacho" placeholder="Ej: 25-001-IC04..."></div>
                </div>
                <h4>Tipos de Cambio</h4>
                <div class="form-row">
                    <div class="form-group"><label>TC USD</label><input type="number" id="cm_tcUsd" step="0.0001" placeholder="Ej: 1450.00"></div>
                    <div class="form-group"><label>TC EUR</label><input type="number" id="cm_tcEur" step="0.0001" placeholder="Ej: 1550.00"></div>
                    <div class="form-group"><label>TC GBP</label><input type="number" id="cm_tcGbp" step="0.0001" placeholder="Ej: 1800.00"></div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="refrescarDatosGenerales()" style="margin-right:10px;">üîÑ Refrescar</button>
                    <button class="btn btn-primary" onclick="cambiarTab('baseAduana')">Siguiente ‚Üí</button>
                </div>
            </div>
            <div id="tabBaseAduana" class="tab-content">
                <h4>Datos para Base Aduana</h4>
                <div class="form-row">
                    <div class="form-group"><label>Puesta FOB - Moneda</label>
                        <select id="cm_fobMoneda"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                    </div>
                    <div class="form-group"><label>Puesta FOB - Monto</label><input type="number" id="cm_fobMonto" step="0.01" onchange="calcularPartesBaseAduana()"></div><div class="form-group" id="fobParteGroup" style="display:none;"><label>Tu parte (FOB)</label><input type="text" id="cm_fobParte" readonly style="background:#333;color:#4CAF50;font-weight:bold;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Flete Aduana - Moneda</label>
                        <select id="cm_fleteMoneda"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                    </div>
                    <div class="form-group"><label>Flete Aduana - Monto</label><input type="number" id="cm_fleteMonto" step="0.01" onchange="calcularPartesBaseAduana()"></div><div class="form-group" id="fleteParteGroup" style="display:none;"><label>Tu parte (FOB)</label><input type="text" id="cm_fleteParte" readonly style="background:#333;color:#4CAF50;font-weight:bold;"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Seguro Aduana - Moneda</label>
                        <select id="cm_seguroMoneda"><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select>
                    </div>
                    <div class="form-group"><label>Seguro Aduana - Monto</label><input type="number" id="cm_seguroMonto" step="0.01" onchange="calcularPartesBaseAduana()"></div><div class="form-group" id="seguroParteGroup" style="display:none;"><label>Tu parte (FOB)</label><input type="text" id="cm_seguroParte" readonly style="background:#333;color:#4CAF50;font-weight:bold;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="cambiarTab('datosGenerales')">‚Üê Anterior</button>
                    <button class="btn btn-warning" onclick="refrescarBaseAduana()">üîÑ Refrescar</button>
                    <button class="btn btn-primary" onclick="cambiarTab('articulos')">Siguiente ‚Üí</button>
                </div>
            </div>
<div id="tabArticulos" class="tab-content">
                <h4>Articulos</h4>
                      <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="descargarTemplateArticulos()">üì• Descargar Template</button>
                    <label class="btn btn-primary" style="margin:0; cursor:pointer;">
                        üì§ Importar desde Excel
                        <input type="file" accept=".xlsx,.xls,.txt,.csv" onchange="importarArticulosExcel(this)" style="display:none;">
                    </label>
                    <button class="btn btn-success" onclick="cargarArticulosDelProveedor()" title="Carga todos los art√≠culos del proveedor desde el cat√°logo maestro">üì¶ Cargar art√≠culos del proveedor</button>
                    <select id="selectMarcaMaestro" style="padding:8px;border-radius:5px;background:#2a2a3e;color:#fff;border:1px solid #444;"><option value="">Filtrar por marca...</option></select>
                    <button class="btn btn-info" onclick="cargarArticulosPorMarca()" style="background:#2196F3;" title="Carga art√≠culos filtrados por marca">üì¶ Cargar por marca</button>
                </div>
                <div id="maestroAlertas" style="display:none; margin-bottom:10px;"></div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                    <table class="articulos-tabla" style="min-width:1300px;">
                        <thead>
                            <tr>
                                <th style="width:35px;">#</th>
                                <th style="min-width:130px;">Cod. Goodies</th>
                                <th style="min-width:110px;">Cod. Proveedor</th>
                                <th style="min-width:300px;">Nombre</th>
                                <th style="width:65px;">Cajas</th>
                                <th style="width:65px;">Und/Caja</th>
                                <th style="width:90px;">Valor F√°brica</th>
<th style="width:90px;">Valor Origen</th>
                                <th style="width:65px;">% Derecho</th>
                               <th style="width:65px;">% Imp.Int.</th>
                                <th style="width:50px;">ANMAT</th>
                                <th style="width:60px;">Grupo</th>
                                <th style="width:35px;"></th>
                            </tr>
                        </thead>
                        <tbody id="articulosBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success" onclick="agregarArticulo()" style="margin-top: 10px;">+ Agregar Articulo</button>
                <button class="btn btn-warning" onclick="completarDesdeCatalogo()" style="margin-top: 10px; margin-left: 10px;" title="Busca derechos, imp. internos y otros datos faltantes en el cat√°logo unificado">üîç Completar datos desde Cat√°logo</button>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="cambiarTab('baseAduana')">‚Üê Anterior</button>
                    <button class="btn btn-warning" onclick="refrescarArticulos()">üîÑ Refrescar</button>
                    <button class="btn btn-primary" onclick="cambiarTab('gastos')">Siguiente ‚Üí</button>
                </div>
            </div>
            <div id="tabGastos" class="tab-content">
                <h4>Gastos</h4>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-secondary" onclick="descargarTemplateGastos()">üì• Descargar Template</button>
                    <label class="btn btn-primary" style="margin:0; cursor:pointer;">
                        üì§ Importar desde Excel
                        <input type="file" accept=".xlsx,.xls,.txt,.csv" onchange="importarGastosExcel(this)" style="display:none;">
                    </label>
<button class="btn btn-warning" id="btnVerComparativo" onclick="mostrarComparativoParticipaciones()" style="display:none;">üìä Ver Comparativo</button>
                </div>
                <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                    <table class="gastos-tabla">
                        <thead>
                            <tr>
                               <th style="width:40px;">#</th>
                                <th>Descripcion</th>
                                <th>Proveedor</th>
                                <th>Nro Comprob.</th>
                                <th>Moneda</th>
                                <th>Monto</th>
                               <th>% Recargo</th>
                                <th>Grupo</th>
                                <th id="thConsolidado" style="display:none;">Prorrateo</th>
<th id="thMontoProrrateado" style="display:none;">Imp. Prorrat.</th>
                                <th title="Excluir de revaluaci√≥n contable">No Cont.</th>
                                <th>Observaciones</th>
                                <th style="width:40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="gastosBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success" onclick="agregarGasto()" style="margin-top: 10px;">+ Agregar Gasto</button>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="cambiarTab('articulos')">‚Üê Anterior</button>
                    <button class="btn btn-warning" onclick="refrescarGastos()">üîÑ Refrescar</button>
                    <button class="btn btn-primary" onclick="guardarCargaManual()">üíæ Guardar Costeo</button>
                </div>
            </div>
        </div>
    </div>
<script>
        const API_URL = window.location.origin;
        let token = localStorage.getItem('token');
        let usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
        let selectedFile = null;
        let todosLosCosteos = [];
        let costeosFiltrados = [];
        let seleccionados = new Set();
        let articulosManual = [];
        let gastosManual = [];

        document.addEventListener('DOMContentLoaded', () => { if (token && usuario) { mostrarApp(); } });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msgEl = document.getElementById('loginMessage');
            try {
                const res = await fetch(API_URL + '/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                const data = await res.json();
                if (res.ok) { token = data.token; usuario = data.usuario; localStorage.setItem('token', token); localStorage.setItem('usuario', JSON.stringify(usuario)); mostrarApp(); }
                else { msgEl.className = 'message error'; msgEl.textContent = data.error || 'Error al iniciar sesion'; }
            } catch (err) { msgEl.className = 'message error'; msgEl.textContent = 'Error de conexion.'; }
        });

        function mostrarApp() { document.getElementById('loginContainer').style.display = 'none'; document.getElementById('appContainer').style.display = 'block'; document.getElementById('userName').textContent = usuario.nombre; cargarCosteos(); cargarUltimosCostos(); cargarHistorialRevaluaciones(); cargarStatsMaestro(); }
        function logout() { token = null; usuario = null; localStorage.removeItem('token'); localStorage.removeItem('usuario'); document.getElementById('loginContainer').style.display = 'block'; document.getElementById('appContainer').style.display = 'none'; }
        function toggleImportExcel() { const area = document.getElementById('importExcelArea'); area.style.display = area.style.display === 'none' ? 'block' : 'none'; }

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const file = e.dataTransfer.files[0]; if (file) seleccionarArchivo(file); });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) seleccionarArchivo(e.target.files[0]); });

        function seleccionarArchivo(file) { if (!file.name.match(/\.xlsx?$/i)) { alert('Solo se permiten archivos Excel'); return; } selectedFile = file; document.getElementById('fileName').textContent = file.name; document.getElementById('importBtn').disabled = false; }

        async function importarExcel() {
            if (!selectedFile) return;
            const msgEl = document.getElementById('importMessage'); const loading = document.getElementById('importLoading'); const btn = document.getElementById('importBtn');
            btn.disabled = true; loading.classList.add('show'); msgEl.className = 'message';
            const formData = new FormData(); formData.append('archivo', selectedFile);
            try {
                const res = await fetch(API_URL + '/api/costeos/precargar', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: formData });
                const data = await res.json();
                if (res.ok) {
                    msgEl.className = 'message success'; 
                    msgEl.textContent = 'Excel leido - Revis√° los datos y guard√°';
                    selectedFile = null; 
                    document.getElementById('fileName').textContent = '';
                    document.getElementById('importExcelArea').style.display = 'none';
                    precargarDatosEnFormulario(data);
                }
                else { msgEl.className = 'message error'; msgEl.textContent = data.error || 'Error al leer Excel'; }
            } catch (err) { msgEl.className = 'message error'; msgEl.textContent = 'Error de conexion'; }
            finally { loading.classList.remove('show'); btn.disabled = !selectedFile; }
        }

        function precargarDatosEnFormulario(data) {
            document.getElementById('cm_nombre').value = data.nombre_costeo || '';
            document.getElementById('cm_proveedor').value = data.proveedor || '';
            document.getElementById('cm_tieneIntermediaria').checked = false;
            const tieneInterm = !!data.empresa_intermediaria;
            document.getElementById('cm_tieneIntermediaria').checked = tieneInterm;
            document.getElementById('cm_intermediaria').value = data.empresa_intermediaria || '';
            document.getElementById('cm_facturaInterm').value = data.factura_intermediaria || '';
            document.getElementById('cm_fechaFacturaInterm').value = data.fecha_factura_intermediaria ? data.fecha_factura_intermediaria.split('T')[0] : '';
            document.getElementById('cm_fechaVencInterm').value = data.fecha_vencimiento_intermediaria ? data.fecha_vencimiento_intermediaria.split('T')[0] : '';
            document.getElementById('cm_facturaNro').value = data.factura_nro || '';
            document.getElementById('cm_moneda').value = data.moneda_principal || 'USD';
            document.getElementById('cm_monto').value = data.monto_factura || '';
            document.getElementById('cm_fechaFactura').value = data.fecha_factura ? data.fecha_factura.split('T')[0] : '';
            document.getElementById('cm_fechaVenc').value = data.fecha_vencimiento_factura ? data.fecha_vencimiento_factura.split('T')[0] : '';
            document.getElementById('cm_fechaDespacho').value = data.fecha_despacho ? data.fecha_despacho.split('T')[0] : '';
            document.getElementById('cm_tcUsd').value = data.tc_usd || '';
            document.getElementById('cm_tcEur').value = data.tc_eur || '';
            document.getElementById('cm_tcGbp').value = data.tc_gbp || '';
            document.getElementById('cm_fobMoneda').value = data.fob_moneda || 'USD';
            document.getElementById('cm_fobMonto').value = data.fob_monto || '';
            document.getElementById('cm_fleteMoneda').value = data.flete_moneda || 'USD';
            document.getElementById('cm_fleteMonto').value = data.flete_monto || '';
            document.getElementById('cm_seguroMoneda').value = data.seguro_moneda || 'USD';
            document.getElementById('cm_seguroMonto').value = data.seguro_monto || '';
            document.getElementById('cm_intermediariaGroup').style.display = tieneInterm ? 'block' : 'none';
            document.getElementById('cm_facturaIntermGroup').style.display = tieneInterm ? 'block' : 'none';
            document.getElementById('cm_fechaFacturaIntermGroup').style.display = tieneInterm ? 'block' : 'none';
            document.getElementById('cm_fechaVencIntermGroup').style.display = tieneInterm ? 'block' : 'none';
            document.getElementById('intermediariaMargenGroup').style.display = tieneInterm ? 'flex' : 'none';
            articulosManual = (data.articulos || []).map(a => {
                const dRaw = parseFloat(a.derechos_porcentaje) || 0;
                const iRaw = parseFloat(a.impuesto_interno_porcentaje) || 0;
                return {
                codigo_goodies: a.codigo_goodies || '',
                codigo_proveedor: a.codigo_proveedor || '',
                nombre: a.nombre || '',
                cajas: a.cantidad_cajas || '',
                und_caja: a.unidades_por_caja || '',
                valor_fabrica: (a.valor_proveedor_origen != null && parseFloat(a.valor_proveedor_origen) > 0) ? a.valor_proveedor_origen : '',
                valor_origen: (a.valor_unitario_origen != null && a.valor_unitario_origen !== '') ? a.valor_unitario_origen : '',
                derechos: dRaw > 0 ? (dRaw <= 1 ? +(dRaw * 100).toFixed(4) : dRaw) : '',
                imp_interno: iRaw > 0 ? (iRaw <= 1 ? +(iRaw * 100).toFixed(4) : iRaw) : '',
                };
            });
            if (articulosManual.length === 0) agregarArticulo();
            renderizarArticulos();
            gastosManual = (data.gastos || []).map(g => ({
                descripcion: g.descripcion || '',
                proveedor: g.proveedor_gasto || '',
                nro_comprobante: g.nro_comprobante || '',
                moneda: g.moneda || 'USD',
                monto: g.monto || '',
                recargo: g.recargo || '',
                observaciones: g.observaciones || '',
                no_contable: g.no_contable || false
            }));
            if (gastosManual.length === 0) agregarGasto();
            renderizarGastos();
            window.costeoEditandoId = null;
            cambiarTab('datosGenerales');
            document.getElementById('cargaManualModal').classList.add('show');
        }
        
let todosLosArticulos = [];
        let articulosFiltrados = [];

        async function cargarUltimosCostos() {
            const loading = document.getElementById('articulosLoading');
            loading.classList.add('show');
            try {
                const res = await fetch(API_URL + '/api/costeos/ultimos-costos', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                if (res.ok && Array.isArray(data)) {
                    todosLosArticulos = data;
                    actualizarDropdownProveedorArticulo();
                    filtrarArticulos();
                }
            } catch (err) { console.error(err); }
            finally { loading.classList.remove('show'); }
        }

        function actualizarDropdownProveedorArticulo() {
            const datalist = document.getElementById('listaProveedoresArticulo');
            const proveedores = [...new Set(todosLosArticulos.map(a => a.proveedor).filter(p => p))].sort();
            datalist.innerHTML = proveedores.map(p => '<option value="' + p + '">').join('');
        }

        function filtrarArticulos() {
            const busqueda = document.getElementById('buscarArticulo').value.toLowerCase();
            const proveedor = document.getElementById('filtroProveedorArticulo').value;
            
            articulosFiltrados = todosLosArticulos.filter(a => {
                const coincideBusqueda = !busqueda || 
                    (a.codigo_goodies || '').toLowerCase().includes(busqueda) ||
                    (a.nombre || '').toLowerCase().includes(busqueda);
                const coincideProveedor = !proveedor || (a.proveedor && a.proveedor.toLowerCase().includes(proveedor.toLowerCase()));
                return coincideBusqueda && coincideProveedor;
            });
            
            renderizarArticulosUltimoCosto(articulosFiltrados);
        }

        function renderizarArticulosUltimoCosto(articulos) {
            const tbody = document.getElementById('articulosUltimoCostoBody');
            if (articulos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;">No hay art√≠culos</td></tr>';
                return;
            }
            tbody.innerHTML = articulos.map(art => {
                const tcInfo = [];
                if (art.tc_usd) tcInfo.push('USD: ' + art.tc_usd);
                if (art.tc_eur) tcInfo.push('EUR: ' + art.tc_eur);
                if (art.tc_gbp) tcInfo.push('GBP: ' + art.tc_gbp);
                
                const colorDifCosto = art.diferencia_pct > 0 ? '#f44336' : art.diferencia_pct < 0 ? '#4CAF50' : '#fff';
                
                return '<tr>' +
                    '<td><input type="checkbox" class="art-check" value="' + (art.codigo_goodies || '') + '" onchange="actualizarSeleccion()"></td>' +
                    '<td>' + (art.codigo_goodies || '-') + '</td>' +
                    '<td>' + (art.proveedor || '-') + '</td>' +
                    '<td>' + (art.nombre || '-') + '</td>' +
                    '<td>' + (art.moneda_fob || '-') + '</td>' +
                    '<td>' + (art.valor_fob ? parseFloat(art.valor_fob).toFixed(2) : '-') + '</td>' +
                    '<td>$' + (art.costo_neto ? parseFloat(art.costo_neto).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '-') + '</td>' +
                    '<td>$' + (art.costo_con_impuestos ? parseFloat(art.costo_con_impuestos).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '-') + '</td>' +
                    '<td>$' + (art.costo_anterior ? parseFloat(art.costo_anterior).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '-') + '</td>' +
                    '<td style="color:' + colorDifCosto + ';font-weight:bold;">' + (art.diferencia_pct !== null ? (art.diferencia_pct > 0 ? '+' : '') + art.diferencia_pct.toFixed(2) + '%' : '-') + '</td>' +
                    '<td>' + formatearFecha(art.fecha_despacho) + '</td>' +
                    '<td>' + (art.nombre_costeo || '-') + '</td>' +
                    '<td style="font-size:11px;">' + (tcInfo.join('<br>') || '-') + '</td>' +
                    '<td><button class="btn btn-secondary btn-sm" onclick="verDetalleArticulo(\'' + art.codigo_goodies + '\')">Ver</button></td>' +
                    '</tr>';
            }).join('');
        }
        
// ========== REVALUACIONES ==========
        let revaluacionActualId = null;
        
        function abrirModalRevaluar() {
            // Verificar si hay costeos seleccionados
            const seleccionados = document.querySelectorAll('.costeo-check:checked');
            if (seleccionados.length > 0) {
                document.getElementById('revaluarInfo').textContent = `Se revaluar√°n los art√≠culos de ${seleccionados.length} costeo(s) seleccionado(s)`;
            } else {
                document.getElementById('revaluarInfo').textContent = 'Se revaluar√°n todos los art√≠culos (√∫ltimo costo de cada uno)';
            }
            
            // Limpiar campos
            document.getElementById('rev_motivo').value = '';
            document.getElementById('rev_otroMotivo').value = '';
            document.getElementById('rev_otroMotivoGroup').style.display = 'none';
            document.getElementById('rev_tcUsd').value = '';
            document.getElementById('rev_tcEur').value = '';
            document.getElementById('rev_tcGbp').value = '';
            
            document.getElementById('revaluarModal').style.display = 'flex';
        }
        
        document.getElementById('rev_motivo').addEventListener('change', function() {
            document.getElementById('rev_otroMotivoGroup').style.display = this.value === 'Otro' ? 'block' : 'none';
        });
        
        async function ejecutarRevaluacion() {
            const motivoSelect = document.getElementById('rev_motivo').value;
            const motivoOtro = document.getElementById('rev_otroMotivo').value;
            const tcUsd = document.getElementById('rev_tcUsd').value;
            const tcEur = document.getElementById('rev_tcEur').value;
            const tcGbp = document.getElementById('rev_tcGbp').value;
            
            if (!motivoSelect) {
                alert('Debe seleccionar un motivo');
                return;
            }
            if (!tcUsd) {
                alert('Debe ingresar el TC USD');
                return;
            }
            
            const motivo = motivoSelect === 'Otro' ? motivoOtro : motivoSelect;
            if (!motivo) {
                alert('Debe especificar el motivo');
                return;
            }
            
            // Obtener costeos seleccionados
            const seleccionados = document.querySelectorAll('.costeo-check:checked');
            const costeoIds = Array.from(seleccionados).map(cb => cb.dataset.id);
            
            try {
                const res = await fetch(API_URL + '/api/revaluaciones/generar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        costeo_ids: costeoIds,
                        tc_usd: tcUsd,
                        tc_eur: tcEur || null,
                        tc_gbp: tcGbp || null,
                        motivo: motivo
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                cerrarModal('revaluarModal');
                
                // Guardar ID para exportar
                revaluacionActualId = data.revaluacion_id;
                
                // Mostrar resultado
                document.getElementById('resumenRevaluacion').innerHTML = `
                    <strong>Motivo:</strong> ${data.motivo} | 
                    <strong>TC USD:</strong> ${data.tc_usd_nuevo} | 
                    <strong>TC EUR:</strong> ${data.tc_eur_nuevo || '-'} | 
                    <strong>TC GBP:</strong> ${data.tc_gbp_nuevo || '-'} | 
                    <strong>Art√≠culos:</strong> ${data.cantidad_articulos}
                `;
                
                let html = '';
                for (const art of data.articulos) {
                    const difColor = art.diferencia_pct > 0 ? '#f44336' : (art.diferencia_pct < 0 ? '#4CAF50' : '#fff');
                    html += `<tr>
                        <td>${art.nombre}</td>
                        <td style="font-weight:bold;">$${parseFloat(art.costo_neto_original).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                        <td style="font-weight:bold;">$${parseFloat(art.costo_neto_revaluado).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                        <td style="color:${difColor};">${art.diferencia_pct ? art.diferencia_pct.toFixed(2) + '%' : '-'}</td>
                    </tr>`;
                }
                document.getElementById('resultadoRevaluacionBody').innerHTML = html;
                document.getElementById('resultadoRevaluacionModal').style.display = 'flex';
                
                // Actualizar historial
                cargarHistorialRevaluaciones();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function exportarRevaluacionActual() {
            if (revaluacionActualId) {
                window.open(API_URL + '/api/revaluaciones/exportar/' + revaluacionActualId + '?token=' + token, '_blank');
            }
        }
        
        async function cargarHistorialRevaluaciones() {
            try {
                const res = await fetch(API_URL + '/api/revaluaciones/historial', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                let html = '';
                if (data.length === 0) {
                    html = '<tr><td colspan="7" style="text-align:center;color:#888;">No hay revaluaciones</td></tr>';
                } else {
                    for (const rev of data) {
                        const fecha = new Date(rev.fecha_revaluacion).toLocaleDateString('es-AR');
                        html += `<tr>
                            <td>${fecha}</td>
                            <td>${rev.motivo}</td>
                            <td>${parseFloat(rev.tc_usd_nuevo).toFixed(4)}</td>
                            <td>${rev.tc_eur_nuevo ? parseFloat(rev.tc_eur_nuevo).toFixed(4) : '-'}</td>
                            <td>${rev.tc_gbp_nuevo ? parseFloat(rev.tc_gbp_nuevo).toFixed(4) : '-'}</td>
                            <td>${rev.cantidad_articulos}</td>
                            <td>
                                <button class="btn btn-small btn-info" onclick="verDetalleRevaluacion('${rev.id}')">Ver</button>
                                <button class="btn btn-small btn-success" onclick="exportarRevaluacion('${rev.id}')">Excel</button>
                                <button class="btn btn-small btn-danger" onclick="eliminarRevaluacion('${rev.id}')">X</button>
                            </td>
                        </tr>`;
                    }
                }
                document.getElementById('historialRevaluacionesBody').innerHTML = html;
            } catch (error) {
                console.error('Error al cargar historial:', error);
            }
        }
        
        async function verDetalleRevaluacion(id) {
            try {
                const res = await fetch(API_URL + '/api/revaluaciones/detalle/' + id, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                revaluacionActualId = id;
                
                document.getElementById('resumenRevaluacion').innerHTML = `
                    <strong>Fecha:</strong> ${new Date(data.fecha_revaluacion).toLocaleDateString('es-AR')} | 
                    <strong>Motivo:</strong> ${data.motivo} | 
                    <strong>TC USD:</strong> ${data.tc_usd_nuevo} | 
                    <strong>TC EUR:</strong> ${data.tc_eur_nuevo || '-'} | 
                    <strong>TC GBP:</strong> ${data.tc_gbp_nuevo || '-'}
                `;
                
                let html = '';
                for (const art of data.articulos) {
                    const difColor = art.diferencia_costo_pct > 0 ? '#f44336' : (art.diferencia_costo_pct < 0 ? '#4CAF50' : '#fff');
                    html += `<tr>
                        <td>${art.nombre}</td>
                        <td style="font-weight:bold;">$${parseFloat(art.costo_neto_original).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                        <td style="font-weight:bold;">$${parseFloat(art.costo_neto_revaluado).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                        <td style="color:${difColor};">${art.diferencia_costo_pct ? parseFloat(art.diferencia_costo_pct).toFixed(2) + '%' : '-'}</td>
                    </tr>`;
                }
                document.getElementById('resultadoRevaluacionBody').innerHTML = html;
                document.getElementById('resultadoRevaluacionModal').style.display = 'flex';
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function exportarRevaluacion(id) {
            window.open(API_URL + '/api/revaluaciones/exportar/' + id + '?token=' + token, '_blank');
        }
        
        async function eliminarRevaluacion(id) {
            if (!confirm('¬øEliminar esta revaluaci√≥n?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/revaluaciones/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (res.ok) {
                    cargarHistorialRevaluaciones();
                } else {
                    const data = await res.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
async function verDetalleArticulo(codigo) {
            try {
                const res = await fetch(API_URL + '/api/costeos/detalle-articulo/' + encodeURIComponent(codigo), { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                const ultimo = data.ultimo;
                const anterior = data.anterior;
                
                let html = '<div style="display:flex;gap:20px;flex-wrap:wrap;">';
                
                let varTcUsd = null, varTcEur = null, varTcGbp = null;
                let varFobOrigen = null, varFobInterm = null;
                let varCostoNeto = null, varCostoImp = null;
                let varGastos = null;
                
                if (anterior) {
                    varTcUsd = ultimo.tc_usd && anterior.tc_usd ? (((ultimo.tc_usd - anterior.tc_usd) / anterior.tc_usd) * 100).toFixed(2) : null;
                    varTcEur = ultimo.tc_eur && anterior.tc_eur ? (((ultimo.tc_eur - anterior.tc_eur) / anterior.tc_eur) * 100).toFixed(2) : null;
                    varTcGbp = ultimo.tc_gbp && anterior.tc_gbp ? (((ultimo.tc_gbp - anterior.tc_gbp) / anterior.tc_gbp) * 100).toFixed(2) : null;
                    varFobOrigen = ultimo.fob_origen && anterior.fob_origen ? (((ultimo.fob_origen - anterior.fob_origen) / anterior.fob_origen) * 100).toFixed(2) : null;
                    varFobInterm = ultimo.fob_interm && anterior.fob_interm ? (((ultimo.fob_interm - anterior.fob_interm) / anterior.fob_interm) * 100).toFixed(2) : null;
                    varCostoNeto = ultimo.costo_neto && anterior.costo_neto ? (((ultimo.costo_neto - anterior.costo_neto) / anterior.costo_neto) * 100).toFixed(2) : null;
                    varCostoImp = ultimo.costo_con_impuestos && anterior.costo_con_impuestos ? (((ultimo.costo_con_impuestos - anterior.costo_con_impuestos) / anterior.costo_con_impuestos) * 100).toFixed(2) : null;
                    if (ultimo.total_gastos_ars && anterior.total_gastos_ars && anterior.total_gastos_ars > 0) {
                        varGastos = (((ultimo.total_gastos_ars - anterior.total_gastos_ars) / anterior.total_gastos_ars) * 100).toFixed(2);
                    }
                }
                
                const colorVar = (v) => v > 0 ? '#f44336' : v < 0 ? '#4CAF50' : '#fff';
                const formatVar = (v) => v !== null ? ' <span style="color:' + colorVar(v) + ';">(' + (v > 0 ? '+' : '') + v + '%)</span>' : '';
                const fmtARS = (v) => v ? '$' + parseFloat(v).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
                
                // Columna √öLTIMO
                html += '<div style="flex:1;min-width:380px;background:#1e1e2f;padding:15px;border-radius:8px;">';
                html += '<h4 style="color:#4CAF50;margin-top:0;">√öLTIMO COSTEO</h4>';
                html += '<p><strong>Costeo:</strong> ' + (ultimo.nombre_costeo || '-') + '</p>';
                html += '<p><strong>Fecha Despacho:</strong> ' + formatearFecha(ultimo.fecha_despacho) + '</p>';
                html += '<hr style="border-color:#444;">';
                html += '<p><strong>TC USD:</strong> ' + (ultimo.tc_usd || '-') + formatVar(varTcUsd) + '</p>';
                html += '<p><strong>TC EUR:</strong> ' + (ultimo.tc_eur || '-') + formatVar(varTcEur) + '</p>';
                html += '<p><strong>TC GBP:</strong> ' + (ultimo.tc_gbp || '-') + formatVar(varTcGbp) + '</p>';
                html += '<hr style="border-color:#444;">';
                html += '<p><strong>FOB Origen:</strong> ' + (ultimo.fob_origen ? parseFloat(ultimo.fob_origen).toFixed(4) : '-') + ' ' + (ultimo.moneda || '') + formatVar(varFobOrigen) + '</p>';
                if (ultimo.fob_interm && parseFloat(ultimo.fob_interm) > 0) {
                    html += '<p><strong>FOB F√°brica:</strong> ' + parseFloat(ultimo.fob_interm).toFixed(4) + ' ' + (ultimo.moneda || '') + formatVar(varFobInterm) + '</p>';
                }
                html += '<p><strong>Costo Neto:</strong> ' + fmtARS(ultimo.costo_neto) + formatVar(varCostoNeto) + '</p>';
                html += '<p><strong>Costo c/Imp:</strong> ' + fmtARS(ultimo.costo_con_impuestos) + formatVar(varCostoImp) + '</p>';
                
                // Gastos resumen
                html += '<hr style="border-color:#444;">';
                html += '<p><strong>Total Gastos:</strong> ' + fmtARS(ultimo.total_gastos_ars) + formatVar(varGastos) + '</p>';
                if (ultimo.gastos && ultimo.gastos.length > 0) {
                    html += '<a href="#" onclick="document.getElementById(\'gastosUltimo\').style.display = document.getElementById(\'gastosUltimo\').style.display === \'none\' ? \'block\' : \'none\'; return false;" style="color:#4CAF50;font-size:13px;">‚ñ∂ Ver detalle gastos (' + ultimo.gastos.length + ')</a>';
                    html += '<div id="gastosUltimo" style="display:none;margin-top:8px;font-size:12px;background:#16162a;padding:10px;border-radius:5px;max-height:200px;overflow-y:auto;">';
                    html += '<table style="width:100%;font-size:12px;"><thead><tr><th style="text-align:left;padding:2px 5px;">Gasto</th><th style="text-align:right;padding:2px 5px;">Divisa</th><th style="text-align:right;padding:2px 5px;">Monto ARS</th></tr></thead><tbody>';
                    ultimo.gastos.forEach(g => {
                        const divisa = (g.moneda && g.monto_orig && g.moneda !== 'ARS') ? g.moneda + ' ' + parseFloat(g.monto_orig).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '-';
                        html += '<tr><td style="padding:2px 5px;">' + g.descripcion + '</td><td style="text-align:right;padding:2px 5px;color:#aaa;">' + divisa + '</td><td style="text-align:right;padding:2px 5px;">' + fmtARS(g.monto_ars) + '</td></tr>';
                    });
                    html += '</tbody></table></div>';
                }
                html += '</div>';
                
                // Columna ANTERIOR
                html += '<div style="flex:1;min-width:380px;background:#1e1e2f;padding:15px;border-radius:8px;">';
                html += '<h4 style="color:#ff9800;margin-top:0;">COSTEO ANTERIOR</h4>';
                if (anterior) {
                    html += '<p><strong>Costeo:</strong> ' + (anterior.nombre_costeo || '-') + '</p>';
                    html += '<p><strong>Fecha Despacho:</strong> ' + formatearFecha(anterior.fecha_despacho) + '</p>';
                    html += '<hr style="border-color:#444;">';
                    html += '<p><strong>TC USD:</strong> ' + (anterior.tc_usd || '-') + '</p>';
                    html += '<p><strong>TC EUR:</strong> ' + (anterior.tc_eur || '-') + '</p>';
                    html += '<p><strong>TC GBP:</strong> ' + (anterior.tc_gbp || '-') + '</p>';
                    html += '<hr style="border-color:#444;">';
                    html += '<p><strong>FOB Origen:</strong> ' + (anterior.fob_origen ? parseFloat(anterior.fob_origen).toFixed(4) : '-') + ' ' + (anterior.moneda || '') + '</p>';
                    if (anterior.fob_interm && parseFloat(anterior.fob_interm) > 0) {
                        html += '<p><strong>FOB F√°brica:</strong> ' + parseFloat(anterior.fob_interm).toFixed(4) + ' ' + (anterior.moneda || '') + '</p>';
                    }
                    html += '<hr style="border-color:#444;">';
                    html += '<p><strong>Costo Neto:</strong> ' + fmtARS(anterior.costo_neto) + '</p>';
                    html += '<p><strong>Costo c/Imp:</strong> ' + fmtARS(anterior.costo_con_impuestos) + '</p>';
                    
                    // Gastos anterior
                    html += '<hr style="border-color:#444;">';
                    html += '<p><strong>Total Gastos:</strong> ' + fmtARS(anterior.total_gastos_ars) + '</p>';
                    if (anterior.gastos && anterior.gastos.length > 0) {
                        html += '<a href="#" onclick="document.getElementById(\'gastosAnterior\').style.display = document.getElementById(\'gastosAnterior\').style.display === \'none\' ? \'block\' : \'none\'; return false;" style="color:#ff9800;font-size:13px;">‚ñ∂ Ver detalle gastos (' + anterior.gastos.length + ')</a>';
                        html += '<div id="gastosAnterior" style="display:none;margin-top:8px;font-size:12px;background:#16162a;padding:10px;border-radius:5px;max-height:200px;overflow-y:auto;">';
                        html += '<table style="width:100%;font-size:12px;"><thead><tr><th style="text-align:left;padding:2px 5px;">Gasto</th><th style="text-align:right;padding:2px 5px;">Divisa</th><th style="text-align:right;padding:2px 5px;">Monto ARS</th></tr></thead><tbody>';
                        anterior.gastos.forEach(g => {
                            const divisa = (g.moneda && g.monto_orig && g.moneda !== 'ARS') ? g.moneda + ' ' + parseFloat(g.monto_orig).toLocaleString('es-AR', {minimumFractionDigits: 2}) : '-';
                            html += '<tr><td style="padding:2px 5px;">' + g.descripcion + '</td><td style="text-align:right;padding:2px 5px;color:#aaa;">' + divisa + '</td><td style="text-align:right;padding:2px 5px;">' + fmtARS(g.monto_ars) + '</td></tr>';
                        });
                        html += '</tbody></table></div>';
                    }
                } else {
                    html += '<p style="color:#888;">No hay costeo anterior para comparar</p>';
                }
                html += '</div>';
                
                html += '</div>';

                // Comparativo de gastos l√≠nea por l√≠nea
                if (anterior && ultimo.gastos && ultimo.gastos.length > 0) {
                    html += '<div style="margin-top:15px;">';
                    html += '<a href="#" onclick="document.getElementById(\'comparativoGastos\').style.display = document.getElementById(\'comparativoGastos\').style.display === \'none\' ? \'block\' : \'none\'; return false;" style="color:#64b5f6;font-size:14px;font-weight:bold;">üìä Ver comparativo de gastos l√≠nea por l√≠nea</a>';
                    html += '<div id="comparativoGastos" style="display:none;margin-top:10px;background:#1e1e2f;padding:15px;border-radius:8px;">';
                    html += '<table style="width:100%;font-size:13px;border-collapse:collapse;">';
                    html += '<thead><tr style="border-bottom:1px solid #444;"><th style="text-align:left;padding:5px;">Gasto</th><th style="text-align:right;padding:5px;">√öltimo</th><th style="text-align:right;padding:5px;">Anterior</th><th style="text-align:right;padding:5px;">Variaci√≥n</th></tr></thead><tbody>';
                    
                    // Normalizar nombres de gastos para comparaci√≥n
                    const normalizarGasto = (desc) => (desc || '').trim().toUpperCase().replace(/\s+/g, ' ');
                    
                    const gastosUMap = {};
                    ultimo.gastos.forEach(g => {
                        const key = normalizarGasto(g.descripcion);
                        gastosUMap[key] = { desc: g.descripcion, monto: (gastosUMap[key] ? gastosUMap[key].monto : 0) + (g.monto_ars || 0) };
                    });
                    
                    const gastosAMap = {};
                    if (anterior.gastos) {
                        anterior.gastos.forEach(g => {
                            const key = normalizarGasto(g.descripcion);
                            gastosAMap[key] = { desc: g.descripcion, monto: (gastosAMap[key] ? gastosAMap[key].monto : 0) + (g.monto_ars || 0) };
                        });
                    }
                    
                    const todosKeys = new Set([...Object.keys(gastosUMap), ...Object.keys(gastosAMap)]);
                    const sortedKeys = [...todosKeys].sort();
                    
                    let totalU = 0, totalA = 0;
                    sortedKeys.forEach(key => {
                        const gU = gastosUMap[key];
                        const gA = gastosAMap[key];
                        const mU = gU ? gU.monto : 0;
                        const mA = gA ? gA.monto : 0;
                        totalU += mU;
                        totalA += mA;
                        const desc = gU ? gU.desc : gA.desc;
                        let varPct = '';
                        let varColor = '#fff';
                        if (mA !== 0 && mU !== 0) {
                            const pct = ((mU - mA) / Math.abs(mA) * 100).toFixed(2);
                            varColor = pct > 0 ? '#f44336' : pct < 0 ? '#4CAF50' : '#fff';
                            varPct = (pct > 0 ? '+' : '') + pct + '%';
                        } else if (mU !== 0 && mA === 0) {
                            varPct = 'NUEVO'; varColor = '#ff9800';
                        } else if (mU === 0 && mA !== 0) {
                            varPct = 'ELIMINADO'; varColor = '#888';
                        }
                        html += '<tr style="border-bottom:1px solid #333;"><td style="padding:4px 5px;">' + desc + '</td>';
                        html += '<td style="text-align:right;padding:4px 5px;">' + (mU !== 0 ? fmtARS(mU) : '-') + '</td>';
                        html += '<td style="text-align:right;padding:4px 5px;">' + (mA !== 0 ? fmtARS(mA) : '-') + '</td>';
                        html += '<td style="text-align:right;padding:4px 5px;color:' + varColor + ';font-weight:bold;">' + varPct + '</td></tr>';
                    });
                    
                    // Fila total
                    let varTotal = '';
                    let varTotalColor = '#fff';
                    if (totalA !== 0 && totalU !== 0) {
                        const pctT = ((totalU - totalA) / Math.abs(totalA) * 100).toFixed(2);
                        varTotalColor = pctT > 0 ? '#f44336' : pctT < 0 ? '#4CAF50' : '#fff';
                        varTotal = (pctT > 0 ? '+' : '') + pctT + '%';
                    }
                    html += '<tr style="border-top:2px solid #666;font-weight:bold;"><td style="padding:5px;">TOTAL</td>';
                    html += '<td style="text-align:right;padding:5px;">' + fmtARS(totalU) + '</td>';
                    html += '<td style="text-align:right;padding:5px;">' + fmtARS(totalA) + '</td>';
                    html += '<td style="text-align:right;padding:5px;color:' + varTotalColor + ';">' + varTotal + '</td></tr>';
                    
                    html += '</tbody></table></div></div>';
                }
                
                document.getElementById('detalleArticuloBody').innerHTML = html;
                document.getElementById('detalleArticuloTitle').textContent = 'Detalle: ' + codigo + ' - ' + (ultimo.nombre || '');
                document.getElementById('detalleArticuloModal').classList.add('show');
                
            } catch (err) {
                console.error(err);
                alert('Error al cargar detalle del art√≠culo');
            }
        }
function exportarUltimosCostosXLSX() {
            exportarArticulosXLSX(articulosFiltrados, 'Ultimos_Costos');
        }

        function exportarSeleccionadosXLSX() {
            const seleccionados = document.querySelectorAll('.art-check:checked');
            const codigos = [...seleccionados].map(cb => cb.value);
            const arts = articulosFiltrados.filter(a => codigos.includes(a.codigo_goodies));
            if (arts.length === 0) { alert('No hay art√≠culos seleccionados'); return; }
            exportarArticulosXLSX(arts, 'Seleccion_Costos');
        }

        function exportarArticulosXLSX(articulos, prefijo) {
            if (articulos.length === 0) { alert('No hay art√≠culos para exportar'); return; }
            
            const data = articulos.map(art => ({
                'C√≥digo': art.codigo_goodies || '',
                'Proveedor': art.proveedor || '',
                'Nombre': art.nombre || '',
                'Moneda FOB': art.moneda_fob || '',
                'FOB Origen': art.valor_fob ? parseFloat(parseFloat(art.valor_fob).toFixed(4)) : '',
                'Costo Neto $': art.costo_neto ? parseFloat(parseFloat(art.costo_neto).toFixed(2)) : '',
                'Costo c/Imp $': art.costo_con_impuestos ? parseFloat(parseFloat(art.costo_con_impuestos).toFixed(2)) : '',
                'Costo Anterior $': art.costo_anterior ? parseFloat(parseFloat(art.costo_anterior).toFixed(2)) : '',
                'Dif %': art.diferencia_pct !== null ? parseFloat(art.diferencia_pct.toFixed(2)) : '',
                'Fecha Despacho': art.fecha_despacho ? art.fecha_despacho.split('T')[0] : '',
                'Costeo': art.nombre_costeo || '',
                'TC USD': art.tc_usd ? parseFloat(art.tc_usd) : '',
                'TC EUR': art.tc_eur ? parseFloat(art.tc_eur) : '',
                'TC GBP': art.tc_gbp ? parseFloat(art.tc_gbp) : ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [
                { wch: 22 }, { wch: 20 }, { wch: 50 }, { wch: 10 },
                { wch: 12 }, { wch: 14 }, { wch: 14 }, { wch: 14 },
                { wch: 8 }, { wch: 14 }, { wch: 30 }, { wch: 12 },
                { wch: 12 }, { wch: 12 }
            ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '√öltimos Costos');
            XLSX.writeFile(wb, prefijo + '_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        function limpiarFiltrosArticulos() {
            document.getElementById('buscarArticulo').value = '';
            document.getElementById('filtroProveedorArticulo').value = '';
            document.getElementById('seleccionarTodosArt').checked = false;
            filtrarArticulos();
            actualizarSeleccion();
        }

        function toggleSeleccionTodos(masterCb) {
            document.querySelectorAll('.art-check').forEach(cb => cb.checked = masterCb.checked);
            actualizarSeleccion();
        }

        function actualizarSeleccion() {
            const seleccionados = document.querySelectorAll('.art-check:checked').length;
            const btn = document.getElementById('btnExportarSeleccion');
            const count = document.getElementById('countSeleccion');
            if (seleccionados > 0) {
                btn.style.display = 'inline-block';
                count.textContent = seleccionados;
            } else {
                btn.style.display = 'none';
            }
        }
async function cargarCosteos() {
            const loading = document.getElementById('tableLoading');
            loading.classList.add('show');
            try {
                const res = await fetch(API_URL + '/api/costeos/listar', { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                if (res.ok && Array.isArray(data)) {
                    todosLosCosteos = data;
                    actualizarDropdownProveedores();
                    aplicarFiltros();
                    document.getElementById('totalCosteos').textContent = data.length;
                    document.getElementById('costeosPresupuestos').textContent = data.filter(c => !esDefinitivo(c)).length;
                }
            } catch (err) { console.error(err); }
            finally { loading.classList.remove('show'); }
        }

        function esDefinitivo(costeo) { return costeo.fecha_despacho || costeo.nro_despacho; }
        async function actualizarDropdownProveedores() {
            // Proveedores from costeos
            const provsCosteos = [...new Set(todosLosCosteos.map(c => c.proveedor).filter(p => p))];
            // Also try to get proveedores from catalogo (unified source)
            let provsCatalogo = [];
            try {
                const res = await fetch(window.location.origin + '/api/maestro/proveedores', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) provsCatalogo = await res.json();
            } catch(e) {}
            // Merge and deduplicate (case-insensitive)
            const seen = new Map();
            [...provsCatalogo, ...provsCosteos].forEach(p => {
                if (p && !seen.has(p.toUpperCase())) seen.set(p.toUpperCase(), p);
            });
            const proveedores = [...seen.values()].sort();
            const datalist = document.getElementById('listaProveedores');
            datalist.innerHTML = proveedores.map(p => '<option value="' + p + '">').join('');
        }
        function toggleCriterio() { const cb = document.getElementById('filtroUltimo'); document.getElementById('criterioContainer').classList.toggle('show', cb.checked); }
        function limpiarFiltros() {
            document.getElementById('filtroProveedor').value = '';
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroMarca').value = '';
            document.getElementById('filtroUltimo').checked = false;
            document.getElementById('criterioContainer').classList.remove('show');
            seleccionados.clear();
            aplicarFiltros();
        }

        function aplicarFiltros() {
            const proveedor = document.getElementById('filtroProveedor').value;
            const tipo = document.getElementById('filtroTipo').value;
            const marca = document.getElementById('filtroMarca').value.toLowerCase();
            const soloUltimo = document.getElementById('filtroUltimo').checked;
            const criterio = document.getElementById('filtroCriterio').value;
            let filtrados = [...todosLosCosteos];
            if (proveedor) filtrados = filtrados.filter(c => c.proveedor && c.proveedor.toLowerCase().includes(proveedor.toLowerCase()));
            if (marca) filtrados = filtrados.filter(c => c.articulos_nombres && c.articulos_nombres.toLowerCase().includes(marca));
            if (tipo === 'definitivo') filtrados = filtrados.filter(c => esDefinitivo(c));
            else if (tipo === 'presupuesto') filtrados = filtrados.filter(c => !esDefinitivo(c));
            if (soloUltimo) {
                if (criterio === 'fecha_factura') filtrados = filtrados.filter(c => c.fecha_factura);
                else if (criterio === 'fecha_despacho') filtrados = filtrados.filter(c => c.fecha_despacho);
                const ultimosPorProveedor = {};
                filtrados.forEach(c => {
                    const prov = c.proveedor || 'Sin Proveedor';
                    let fechaComparar;
                    if (criterio === 'fecha_factura') fechaComparar = new Date(c.fecha_factura);
                    else if (criterio === 'fecha_despacho') fechaComparar = new Date(c.fecha_despacho);
                    else fechaComparar = c.created_at ? new Date(c.created_at) : new Date(0);
                    if (!ultimosPorProveedor[prov] || fechaComparar > ultimosPorProveedor[prov].fecha) {
                        ultimosPorProveedor[prov] = { costeo: c, fecha: fechaComparar };
                    }
                });
                filtrados = Object.values(ultimosPorProveedor).map(u => u.costeo);
            }
            costeosFiltrados = filtrados;
            renderizarTabla(filtrados);
            actualizarAccionesMasivas();
        }

        function formatearFecha(fecha) { if (!fecha) return '-'; const d = new Date(fecha); if (isNaN(d.getTime())) return '-'; return d.toLocaleDateString('es-AR'); }
        function toggleSelectAll() {
            const checkAll = document.getElementById('selectAll').checked;
            if (checkAll) costeosFiltrados.forEach(c => seleccionados.add(c.id));
            else seleccionados.clear();
            renderizarTabla(costeosFiltrados);
            actualizarAccionesMasivas();
        }
        function toggleSeleccion(id) {
            if (seleccionados.has(id)) seleccionados.delete(id);
            else seleccionados.add(id);
            actualizarAccionesMasivas();
            document.getElementById('selectAll').checked = costeosFiltrados.length > 0 && costeosFiltrados.every(c => seleccionados.has(c.id));
        }
        function actualizarAccionesMasivas() {
            document.getElementById('contadorSeleccionados').textContent = seleccionados.size;
            document.getElementById('accionesMasivas').style.display = seleccionados.size > 0 ? 'flex' : 'none';
        }

        function renderizarTabla(costeos) {
            const tbody = document.getElementById('costeosBody');
            if (costeos.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No hay costeos</td></tr>'; return; }
            tbody.innerHTML = costeos.map(costeo => {
                const def = esDefinitivo(costeo);
                const checked = seleccionados.has(costeo.id) ? 'checked' : '';
                return '<tr>' +
                    '<td class="checkbox-cell"><input type="checkbox" ' + checked + ' onchange="toggleSeleccion(\'' + costeo.id + '\')"></td>' +
                    '<td>' + (costeo.nombre_costeo || '-') + '</td>' +
                    '<td>' + (costeo.proveedor || '-') + '</td>' +
                    '<td>' + (costeo.moneda_principal || 'USD') + '</td>' +
                    '<td>' + (costeo.unidades_totales || 0) + '</td>' +
                    '<td>' + formatearFecha(costeo.fecha_factura) + '</td>' +
                    '<td>' + formatearFecha(costeo.fecha_despacho) + '</td>' +
                    '<td><span class="status-badge ' + (def ? 'status-definitivo' : 'status-presupuesto') + '">' + (def ? 'Definitivo' : 'Presupuesto') + '</span></td>' +
                    '<td class="actions">' +
                    '<button class="btn btn-warning btn-sm" onclick="calcularCosteo(\'' + costeo.id + '\')">Calc</button>' +
                    '<button class="btn btn-primary btn-sm" onclick="editarCosteo(\'' + costeo.id + '\')">Edit</button>' +
                    '<button class="btn btn-purple btn-sm" onclick="duplicarCosteo(\'' + costeo.id + '\')" title="Duplicar">Dup</button>' +
                    '<button class="btn btn-sm" style="background:#00bcd4;color:#fff;" onclick="iniciarComparativo(\'' + costeo.id + '\',\'' + (costeo.proveedor || '').replace(/'/g, "\\'") + '\')" title="Comparar con otro costeo">Comp</button>' +
                    '<button class="btn btn-secondary btn-sm" onclick="exportarLegajo(\'' + costeo.id + '\')" title="Exportar Legajo">Leg</button>' +
                    '<button class="btn btn-secondary btn-sm" onclick="verDetalle(\'' + costeo.id + '\')">Ver</button>' +
                    '<button class="btn btn-success btn-sm" onclick="exportarCosteo(\'' + costeo.id + '\')">Excel</button>' +
                    '<button class="btn btn-danger btn-sm" onclick="eliminarCosteo(\'' + costeo.id + '\')">X</button>' +
                    '</td></tr>';
            }).join('');
        }

async function exportarLegajo(id) {
            try {
                const res = await fetch(API_URL + '/api/costeos/' + id, { headers: { 'Authorization': 'Bearer ' + token } });
                const costeo = await res.json();
                if (res.ok) {
                    let contenido = 'DATOS GENERALES\n';
                    contenido += 'Campo\tValor\n';
                    contenido += 'Nombre Costeo\t' + (costeo.nombre_costeo || '') + '\n';
                    contenido += 'Proveedor\t' + (costeo.proveedor || '') + '\n';
                    contenido += 'Empresa Intermediaria\t' + (costeo.empresa_intermediaria || '') + '\n';
                    contenido += 'Factura Nro\t' + (costeo.factura_nro || '') + '\n';
                    contenido += 'Fecha Factura\t' + (costeo.fecha_factura ? costeo.fecha_factura.split('T')[0] : '') + '\n';
                    contenido += 'Fecha Vencimiento\t' + (costeo.fecha_vencimiento_factura ? costeo.fecha_vencimiento_factura.split('T')[0] : '') + '\n';
                    contenido += 'Fecha Despacho\t' + (costeo.fecha_despacho ? costeo.fecha_despacho.split('T')[0] : '') + '\n';
                    contenido += 'Moneda Principal\t' + (costeo.moneda_principal || '') + '\n';
                    contenido += 'Monto Factura\t' + (costeo.monto_factura || '') + '\n';
                    contenido += 'TC USD\t' + (costeo.tc_usd || '') + '\n';
                    contenido += 'TC EUR\t' + (costeo.tc_eur || '') + '\n';
                    contenido += 'TC GBP\t' + (costeo.tc_gbp || '') + '\n';
                    contenido += 'FOB Monto\t' + (costeo.fob_monto || '') + '\n';
                    contenido += 'Flete Monto\t' + (costeo.flete_monto || '') + '\n';
                    contenido += 'Seguro Monto\t' + (costeo.seguro_monto || '') + '\n';
                    contenido += '\nARTICULOS\n';
                    contenido += 'Cod_Goodies\tCod_Proveedor\tNombre\tCajas\tUnd_Caja\tUnidades\tValor_Origen\tValor_Unit\tPct_Derecho\tPct_Imp_Interno\n';
                    (costeo.articulos || []).forEach(a => {
                        contenido += (a.codigo_goodies || '') + '\t';
                        contenido += (a.codigo_proveedor || '') + '\t';
                        contenido += (a.nombre || '') + '\t';
                        contenido += (a.cantidad_cajas || '') + '\t';
                        contenido += (a.unidades_por_caja || '') + '\t';
                        contenido += (a.unidades_totales || '') + '\t';
                        contenido += (a.valor_proveedor_origen || '') + '\t';
                        contenido += (a.valor_unitario_origen || '') + '\t';
                        contenido += ((a.derechos_porcentaje || 0) * 100) + '\t';
                        contenido += ((a.impuesto_interno_porcentaje || 0) * 100) + '\n';
                    });
                    contenido += '\nGASTOS\n';
                    contenido += 'Descripcion\tProveedor\tNro_Comprobante\tMoneda\tMonto\tPct_Recargo\tObservaciones\tNo_Contable\n';
                    (costeo.gastos_varios || []).forEach(g => {
                        contenido += (g.descripcion || '') + '\t';
                        contenido += (g.proveedor_gasto || '') + '\t';
                        contenido += (g.nro_comprobante || '') + '\t';
                        contenido += (g.moneda || '') + '\t';
                        contenido += (g.monto || '') + '\t';
                        contenido += (g.recargo || '') + '\t';
                        contenido += (g.observaciones || '') + '\t';
                        contenido += (g.no_contable ? 'SI' : '') + '\n';
                    });
                    const blob = new Blob([contenido], { type: 'text/tab-separated-values;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Legajo_' + (costeo.nombre_costeo || 'costeo').replace(/[^a-zA-Z0-9]/g, '_') + '.xls';
                    a.click();
                    URL.revokeObjectURL(url);
                }
            } catch (err) { alert('Error al exportar legajo'); console.error(err); }
        }
async function duplicarCosteo(id) {
            try {
                const res = await fetch(API_URL + '/api/costeos/' + id, { headers: { 'Authorization': 'Bearer ' + token } });
                const costeo = await res.json();
                if (res.ok) {
                    document.getElementById('cm_nombre').value = (costeo.nombre_costeo || '') + ' - DEFINITIVO';
                    document.getElementById('cm_proveedor').value = costeo.proveedor || '';
                    document.getElementById('cm_tieneIntermediaria').checked = !!costeo.empresa_intermediaria;
                    document.getElementById('cm_intermediaria').value = costeo.empresa_intermediaria || '';
                    document.getElementById('cm_facturaInterm').value = costeo.factura_intermediaria || '';
                    document.getElementById('cm_fechaFacturaInterm').value = costeo.fecha_factura_intermediaria ? costeo.fecha_factura_intermediaria.split('T')[0] : '';
                    document.getElementById('cm_fechaVencInterm').value = costeo.fecha_vencimiento_intermediaria ? costeo.fecha_vencimiento_intermediaria.split('T')[0] : '';
                    document.getElementById('cm_facturaNro').value = costeo.factura_nro || '';
                    document.getElementById('cm_moneda').value = costeo.moneda_principal || 'USD';
                    document.getElementById('cm_monto').value = costeo.monto_factura || '';
                    document.getElementById('cm_fechaFactura').value = costeo.fecha_factura ? costeo.fecha_factura.split('T')[0] : '';
                    document.getElementById('cm_fechaVenc').value = costeo.fecha_vencimiento_factura ? costeo.fecha_vencimiento_factura.split('T')[0] : '';
                    document.getElementById('cm_fechaDespacho').value = costeo.fecha_despacho ? costeo.fecha_despacho.split('T')[0] : '';
                    document.getElementById('cm_nroDespacho').value = costeo.nro_despacho || '';
                    document.getElementById('cm_tcUsd').value = costeo.tc_usd || '';
                    document.getElementById('cm_tcEur').value = costeo.tc_eur || '';
                    document.getElementById('cm_tcGbp').value = costeo.tc_gbp || '';
                    document.getElementById('cm_fobMoneda').value = costeo.fob_moneda || 'USD';
                    document.getElementById('cm_fobMonto').value = costeo.fob_monto || '';
                    document.getElementById('cm_fleteMoneda').value = costeo.flete_moneda || 'USD';
                    document.getElementById('cm_fleteMonto').value = costeo.flete_monto || '';
                    document.getElementById('cm_seguroMoneda').value = costeo.seguro_moneda || 'USD';
                    document.getElementById('cm_seguroMonto').value = costeo.seguro_monto || '';
                    toggleIntermediaria();
                    articulosManual = (costeo.articulos || []).map(mapearArticuloDesdeDB);
                    if (articulosManual.length === 0) agregarArticulo();
                    renderizarArticulos();
                    gastosManual = (costeo.gastos_varios || []).map(g => ({
                        descripcion: g.descripcion || '',
                        proveedor: g.proveedor_gasto || '',
                        nro_comprobante: g.nro_comprobante || '',
                        moneda: g.moneda || 'USD',
                        monto: g.monto || '',
                        recargo: g.recargo || '',
                        grupo: g.grupo || '',
                        observaciones: g.observaciones || '',
                        no_contable: g.no_contable || false
                    }));
                    if (gastosManual.length === 0) agregarGasto();
                    renderizarGastos();
                    window.costeoEditandoId = null;
                    cambiarTab('datosGenerales');
                    document.getElementById('cargaManualModal').classList.add('show');
setTimeout(function() { toggleConsolidado(); calcularPartesBaseAduana(); }, 100);
                }
            } catch (err) { alert('Error al duplicar costeo'); console.error(err); }
        }
async function editarCosteo(id) {
            try {
                const res = await fetch(API_URL + '/api/costeos/' + id, { headers: { 'Authorization': 'Bearer ' + token } });
                const costeo = await res.json();
                if (res.ok) {
                    document.getElementById('cm_nombre').value = costeo.nombre_costeo || '';
                    document.getElementById('cm_proveedor').value = costeo.proveedor || '';
                    document.getElementById('cm_tieneIntermediaria').checked = !!costeo.empresa_intermediaria;
                    document.getElementById('cm_intermediaria').value = costeo.empresa_intermediaria || '';
                    document.getElementById('cm_facturaInterm').value = costeo.factura_intermediaria || '';
                    document.getElementById('cm_fechaFacturaInterm').value = costeo.fecha_factura_intermediaria ? costeo.fecha_factura_intermediaria.split('T')[0] : '';
                    document.getElementById('cm_fechaVencInterm').value = costeo.fecha_vencimiento_intermediaria ? costeo.fecha_vencimiento_intermediaria.split('T')[0] : '';
                    document.getElementById('cm_facturaNro').value = costeo.factura_nro || '';
                    document.getElementById('cm_moneda').value = costeo.moneda_principal || 'USD';
                    document.getElementById('cm_monto').value = costeo.monto_factura || '';
                    document.getElementById('cm_fechaFactura').value = costeo.fecha_factura ? costeo.fecha_factura.split('T')[0] : '';
                    document.getElementById('cm_fechaVenc').value = costeo.fecha_vencimiento_factura ? costeo.fecha_vencimiento_factura.split('T')[0] : '';
                    document.getElementById('cm_fechaDespacho').value = costeo.fecha_despacho ? costeo.fecha_despacho.split('T')[0] : '';
                    document.getElementById('cm_nroDespacho').value = costeo.nro_despacho || '';
                    document.getElementById('cm_tcUsd').value = costeo.tc_usd || '';
                    document.getElementById('cm_tcEur').value = costeo.tc_eur || '';
                    document.getElementById('cm_tcGbp').value = costeo.tc_gbp || '';
                    document.getElementById('cm_fobMoneda').value = costeo.fob_moneda || 'USD';
                    document.getElementById('cm_fobMonto').value = costeo.fob_monto || '';
                    document.getElementById('cm_fleteMoneda').value = costeo.flete_moneda || 'USD';
                    document.getElementById('cm_fleteMonto').value = costeo.flete_monto || '';
                    document.getElementById('cm_seguroMoneda').value = costeo.seguro_moneda || 'USD';
                    document.getElementById('cm_seguroMonto').value = costeo.seguro_monto || '';
                    // Consolidado
                    document.getElementById('cm_esConsolidado').checked = !!costeo.es_consolidado;
                    document.getElementById('cm_volumenM3').value = costeo.volumen_m3 || '';
                    document.getElementById('cm_pesoKg').value = costeo.peso_kg || '';
                    proveedoresConsolidado = (costeo.proveedores_consolidado || []).map(p => ({
                        nombre: p.nombre_proveedor || '',
                        fob_total: p.fob_total || '',
                        moneda: p.moneda || 'USD',
                        volumen_m3: p.volumen_m3 || '',
                        peso_kg: p.peso_kg || ''
                    }));
                    toggleIntermediaria();
                    toggleConsolidado();
                    articulosManual = (costeo.articulos || []).map(mapearArticuloDesdeDB);
                    if (articulosManual.length === 0) agregarArticulo();
                    renderizarArticulos();
                    gastosManual = (costeo.gastos_varios || []).map(g => ({
                        descripcion: g.descripcion || '',
                        proveedor: g.proveedor_gasto || '',
                        nro_comprobante: g.nro_comprobante || '',
                        moneda: g.moneda || 'USD',
                        monto: g.monto || '',
                        recargo: g.recargo || '',
                        grupo: g.grupo || '',
                        prorratear_consolidado: g.prorratear_consolidado || false,
                        metodo_prorrateo: g.metodo_prorrateo || 'no_prorratear',
                        observaciones: g.observaciones || '',
                        no_contable: g.no_contable || false
                    }));

                    if (gastosManual.length === 0) agregarGasto();
                    renderizarGastos();
                    window.costeoEditandoId = id;
                    cambiarTab('datosGenerales');
                    document.getElementById('cargaManualModal').classList.add('show');
setTimeout(function() { toggleConsolidado(); calcularPartesBaseAduana(); }, 100);
                }
            } catch (err) { alert('Error al cargar costeo'); console.error(err); }
        }
let costeoIdParaCalcular = null;

async function calcularCosteo(id) {
    if (!confirm('¬øCalcular este costeo?')) return;
    await ejecutarCalculo(id, null);
}
async function mostrarModalConsolidado(id) {
    document.getElementById('modalConsolidado').style.display = 'block';
    document.getElementById('consolidadoLoading').style.display = 'block';
    document.getElementById('consolidadoContenido').style.display = 'none';
    
    try {
        const res = await fetch(API_URL + '/api/costeos/' + id + '/preview-consolidado', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        if (!data.es_consolidado) {
            alert('Este costeo no es consolidado');
            cerrarModalConsolidado();
            return;
        }
        
        // Mostrar resumen de proveedores
        let htmlProveedores = '<table style="width:100%; border-collapse:collapse;">';
        htmlProveedores += '<tr style="border-bottom:1px solid #555;"><td style="padding:8px;"><strong>' + data.proveedor_actual.nombre + ' (actual)</strong></td>';
        htmlProveedores += '<td style="padding:8px; text-align:right;">FOB: $' + data.proveedor_actual.fob.toLocaleString('es-AR', {minimumFractionDigits:2}) + '</td>';
        htmlProveedores += '<td style="padding:8px; text-align:right;">Vol: ' + (data.proveedor_actual.volumen_m3 || 0) + ' m¬≥</td>';
        htmlProveedores += '<td style="padding:8px; text-align:right;">Peso: ' + (data.proveedor_actual.peso_kg || 0) + ' kg</td></tr>';
        
        for (const prov of data.otros_proveedores) {
            htmlProveedores += '<tr style="border-bottom:1px solid #444;"><td style="padding:8px;">' + prov.nombre + '</td>';
            htmlProveedores += '<td style="padding:8px; text-align:right;">FOB: $' + prov.fob_convertido.toLocaleString('es-AR', {minimumFractionDigits:2}) + '</td>';
            htmlProveedores += '<td style="padding:8px; text-align:right;">Vol: ' + (prov.volumen_m3 || 0) + ' m¬≥</td>';
            htmlProveedores += '<td style="padding:8px; text-align:right;">Peso: ' + (prov.peso_kg || 0) + ' kg</td></tr>';
        }
        
        htmlProveedores += '<tr style="background:#333; font-weight:bold;"><td style="padding:8px;">TOTAL CONSOLIDADO</td>';
        htmlProveedores += '<td style="padding:8px; text-align:right;">$' + data.totales.fob.toLocaleString('es-AR', {minimumFractionDigits:2}) + '</td>';
        htmlProveedores += '<td style="padding:8px; text-align:right;">' + data.totales.volumen_m3 + ' m¬≥</td>';
        htmlProveedores += '<td style="padding:8px; text-align:right;">' + data.totales.peso_kg + ' kg</td></tr>';
        htmlProveedores += '</table>';
        
        document.getElementById('resumenProveedores').innerHTML = htmlProveedores;
        
        // Mostrar participaciones
        document.getElementById('partFOB').textContent = data.comparativo_metodos.por_fob.participacion;
        document.getElementById('gastosFOB').textContent = '$' + parseFloat(data.comparativo_metodos.por_fob.gastos_estimados).toLocaleString('es-AR', {minimumFractionDigits:2});
        
        document.getElementById('partVolumen').textContent = data.comparativo_metodos.por_volumen.participacion;
        document.getElementById('gastosVolumen').textContent = '$' + parseFloat(data.comparativo_metodos.por_volumen.gastos_estimados).toLocaleString('es-AR', {minimumFractionDigits:2});
        
        document.getElementById('partPeso').textContent = data.comparativo_metodos.por_peso.participacion;
        document.getElementById('gastosPeso').textContent = '$' + parseFloat(data.comparativo_metodos.por_peso.gastos_estimados).toLocaleString('es-AR', {minimumFractionDigits:2});
        
        // Deshabilitar botones si no hay datos
        document.getElementById('btnVolumen').disabled = !data.comparativo_metodos.por_volumen.disponible;
        document.getElementById('btnVolumen').style.opacity = data.comparativo_metodos.por_volumen.disponible ? '1' : '0.5';
        
        document.getElementById('btnPeso').disabled = !data.comparativo_metodos.por_peso.disponible;
        document.getElementById('btnPeso').style.opacity = data.comparativo_metodos.por_peso.disponible ? '1' : '0.5';
        
        // Mostrar gastos a prorratear
        document.getElementById('gastosAProrratear').textContent = '$' + parseFloat(data.gastos.total_a_prorratear).toLocaleString('es-AR', {minimumFractionDigits:2});
        
        document.getElementById('consolidadoLoading').style.display = 'none';
        document.getElementById('consolidadoContenido').style.display = 'block';
        
    } catch (err) {
        console.error('Error:', err);
        alert('Error al cargar preview');
        cerrarModalConsolidado();
    }
}

function cerrarModalConsolidado() {
    document.getElementById('modalConsolidado').style.display = 'none';
    costeoIdParaCalcular = null;
}

async function calcularConMetodo(metodo) {
    if (!costeoIdParaCalcular) return;
    cerrarModalConsolidado();
    await ejecutarCalculo(costeoIdParaCalcular, metodo);
}

async function ejecutarCalculo(id, metodo) {
    try {
        const body = metodo ? JSON.stringify({ metodo: metodo }) : '{}';
        const res = await fetch(API_URL + '/api/costeos/' + id + '/calcular', { 
            method: 'POST', 
            headers: { 
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: body
        });
        const data = await res.json();
        
        if (res.ok) { 
            let mensaje = '‚úÖ Costeo calculado!\n\nCosto Total: $' + parseFloat(data.resumen?.costo_total_final_ars || 0).toLocaleString('es-AR');
            if (data.consolidado) {
                mensaje += '\n\nüì¶ Consolidado - M√©todo: ' + data.consolidado.metodo_usado.toUpperCase();
                mensaje += '\nParticipaci√≥n aplicada: ' + data.consolidado.participacion_aplicada;
            }
            if (data.avisos && data.avisos.length > 0) {
                mensaje += '\n\n‚ö†Ô∏è AVISOS:\n' + data.avisos.join('\n');
            }
            alert(mensaje); 
            cargarCosteos(); 
        } else { 
            alert('Error: ' + (data.error || 'No se pudo calcular')); 
        }
    } catch (err) { 
        alert('Error de conexi√≥n'); 
        console.error(err);
    }
}

        async function exportarCosteo(id) {
            try {
                const res = await fetch(API_URL + '/api/costeos/' + id + '/exportar', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const cd = res.headers.get('Content-Disposition');
                    a.download = cd && cd.match(/filename="(.+)"/) ? cd.match(/filename="(.+)"/)[1] : 'costeo.xlsx';
                    document.body.appendChild(a); a.click(); a.remove();
                    window.URL.revokeObjectURL(url);
                } else { alert('Error al exportar'); }
            } catch (err) { alert('Error de conexion'); }
        }

        async function eliminarCosteo(id) {
            if (!confirm('Seguro que deseas eliminar este costeo?')) return;
            try {
                const res = await fetch(API_URL + '/api/costeos/' + id, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) { alert('Costeo eliminado'); seleccionados.delete(id); cargarCosteos(); }
                else { alert('Error al eliminar'); }
            } catch (err) { alert('Error de conexion'); }
        }

        async function verDetalle(id) {
            try {
                const res = await fetch(API_URL + '/api/costeos/' + id, { headers: { 'Authorization': 'Bearer ' + token } });
                const costeo = await res.json();
                if (res.ok) {
                    document.getElementById('modalTitle').textContent = costeo.nombre_costeo || 'Detalle';
                    document.getElementById('modalBody').innerHTML = '<div class="detail-grid">' +
                        '<div class="detail-item"><div class="detail-label">Proveedor</div><div class="detail-value">' + (costeo.proveedor || '-') + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">Factura</div><div class="detail-value">' + (costeo.factura_nro || '-') + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">Moneda</div><div class="detail-value">' + (costeo.moneda_principal || 'USD') + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">TC USD</div><div class="detail-value">' + (costeo.tc_usd || '-') + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">TC EUR</div><div class="detail-value">' + (costeo.tc_eur || '-') + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">TC GBP</div><div class="detail-value">' + (costeo.tc_gbp || '-') + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">Unidades</div><div class="detail-value">' + (costeo.unidades_totales || 0) + '</div></div>' +
                        '<div class="detail-item"><div class="detail-label">Total Gastos</div><div class="detail-value">$' + parseFloat(costeo.total_gastos_ars || 0).toLocaleString('es-AR') + '</div></div>' +
                        '<div class="detail-item" style="grid-column: span 2;"><div class="detail-label">INVERSION TOTAL</div><div class="detail-value highlight" style="font-size:24px;">$' + parseFloat(costeo.costo_total_ars || 0).toLocaleString('es-AR') + '</div></div>' +
                        '</div>';
                    document.getElementById('detalleModal').classList.add('show');
                }
            } catch (err) { alert('Error al cargar detalle'); }
        }

        function exportarSeleccionados() {
            if (seleccionados.size === 0) { alert('No hay costeos seleccionados'); return; }
            alert('Funcion en desarrollo: Exportar ' + seleccionados.size + ' costeos');
        }

        function abrirRecalcular() {
            if (seleccionados.size === 0) { alert('No hay costeos seleccionados'); return; }
            document.getElementById('recalcularModal').classList.add('show');
        }

        async function ejecutarRecalcular() {
            const tcUsd = document.getElementById('tcUsdNuevo').value;
            const tcEur = document.getElementById('tcEurNuevo').value;
            const tcGbp = document.getElementById('tcGbpNuevo').value;
            if (!tcUsd && !tcEur && !tcGbp) { alert('Ingresa al menos un tipo de cambio'); return; }
            const ids = Array.from(seleccionados);
            let exitosos = 0, errores = 0;
            for (const id of ids) {
                try {
                    const res = await fetch(API_URL + '/api/costeos/' + id + '/recalcular', {
                        method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tc_usd: tcUsd, tc_eur: tcEur, tc_gbp: tcGbp })
                    });
                    if (res.ok) exitosos++; else errores++;
                } catch (err) { errores++; }
            }
            cerrarModal('recalcularModal');
            alert('Recalculo completado:\n- Exitosos: ' + exitosos + '\n- Errores: ' + errores);
            cargarCosteos();
        }

        function cerrarModal(id) { 
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = '';
            }
        }
        // ========== COMPARATIVO PRESUPUESTO VS DEFINITIVO ==========
        async function iniciarComparativo(costeoId, proveedor) {
            // Buscar costeos del mismo proveedor
            const mismoProveedor = todosLosCosteos.filter(c => 
                c.proveedor && c.proveedor.toUpperCase().trim() === proveedor.toUpperCase().trim() && c.id !== costeoId
            );
            if (mismoProveedor.length === 0) {
                alert('No hay otros costeos del proveedor "' + proveedor + '" para comparar.');
                return;
            }
            const costeoBase = todosLosCosteos.find(c => c.id === costeoId);
            let opciones = mismoProveedor.map(c => {
                const def = c.fecha_despacho ? 'DEF' : 'PRES';
                const fecha = c.fecha_despacho ? formatearFecha(c.fecha_despacho) : formatearFecha(c.fecha_factura);
                return c.nombre_costeo + ' [' + def + '] ' + fecha;
            });
            let msg = 'Comparar "' + (costeoBase ? costeoBase.nombre_costeo : '') + '" con:\n\n';
            mismoProveedor.forEach((c, i) => {
                const def = c.fecha_despacho ? 'DEF' : 'PRES';
                const fecha = c.fecha_despacho ? formatearFecha(c.fecha_despacho) : formatearFecha(c.fecha_factura);
                msg += (i + 1) + '. ' + c.nombre_costeo + ' [' + def + '] ' + fecha + '\n';
            });
            msg += '\nIngrese el n√∫mero:';
            const seleccion = prompt(msg);
            if (!seleccion) return;
            const idx = parseInt(seleccion) - 1;
            if (isNaN(idx) || idx < 0 || idx >= mismoProveedor.length) { alert('Selecci√≥n inv√°lida'); return; }
            await mostrarComparativo(costeoId, mismoProveedor[idx].id);
        }

        async function mostrarComparativo(idA, idB) {
            try {
                const [resA, resB] = await Promise.all([
                    fetch(API_URL + '/api/costeos/' + idA, { headers: { 'Authorization': 'Bearer ' + token } }),
                    fetch(API_URL + '/api/costeos/' + idB, { headers: { 'Authorization': 'Bearer ' + token } })
                ]);
                const costeoA = await resA.json();
                const costeoB = await resB.json();
                if (!resA.ok || !resB.ok) { alert('Error al cargar costeos'); return; }

                // Nombres cortos para headers de tabla
                const nombreCortoA = (costeoA.nombre_costeo || 'Costeo 1').substring(0, 20);
                const nombreCortoB = (costeoB.nombre_costeo || 'Costeo 2').substring(0, 20);

                const defA = !!costeoA.fecha_despacho;
                const defB = !!costeoB.fecha_despacho;
                const tipoA = defA ? 'DEFINITIVO' : 'PRESUPUESTO';
                const tipoB = defB ? 'DEFINITIVO' : 'PRESUPUESTO';
                const labelA = (defA ? '‚úÖ ' : 'üìã ') + tipoA + ' (ELEGIDO)';
                const labelB = (defB ? '‚úÖ ' : 'üìã ') + tipoB + ' (COMPARADO)';
                const colorA = defA ? '#4CAF50' : '#ff9800';
                const colorB = defB ? '#4CAF50' : '#ff9800';

                const pctDif = (a, b) => {
                    a = parseFloat(a) || 0; b = parseFloat(b) || 0;
                    if (b === 0) return a === 0 ? 0 : 100;
                    return ((a - b) / Math.abs(b)) * 100;
                };
                const fmtNum = (v) => (parseFloat(v) || 0).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const fmtFob = (v) => (parseFloat(v) || 0).toLocaleString('es-AR', {minimumFractionDigits: 4, maximumFractionDigits: 4});
                const fmtPct = (v) => { const n = parseFloat(v); return (n > 0 ? '+' : '') + n.toFixed(2) + '%'; };
                const colorPct = (v) => { const n = parseFloat(v); return n > 0 ? '#f44336' : n < 0 ? '#4CAF50' : '#aaa'; };

                // Verificar si los costeos tienen datos calculados
                const artsA = costeoA.articulos || [];
                const artsB = costeoB.articulos || [];
                const tieneCalculosA = artsA.some(a => parseFloat(a.costo_unitario_neto_ars) > 0 || parseFloat(a.fob_unitario_usd) > 0);
                const tieneCalculosB = artsB.some(a => parseFloat(a.costo_unitario_neto_ars) > 0 || parseFloat(a.fob_unitario_usd) > 0);

                let html = '';

                // Alerta si alg√∫n costeo no tiene c√°lculos
                if (!tieneCalculosA || !tieneCalculosB) {
                    html += '<div style="background:#332200;border:1px solid #ff9800;padding:10px;border-radius:6px;margin-bottom:15px;color:#ff9800;">';
                    html += '‚ö†Ô∏è <strong>Atenci√≥n:</strong> ';
                    if (!tieneCalculosA) html += '"' + costeoA.nombre_costeo + '" no tiene datos calculados (estado: ' + (costeoA.estado || 'borrador') + '). ';
                    if (!tieneCalculosB) html += '"' + costeoB.nombre_costeo + '" no tiene datos calculados (estado: ' + (costeoB.estado || 'borrador') + '). ';
                    html += 'Calcul√° el costeo primero para ver los valores.</div>';
                }

                // Header con datos generales
                html += '<div style="display:flex;gap:15px;margin-bottom:20px;">';
                html += '<div style="flex:1;background:#1e1e2f;padding:12px;border-radius:8px;border-left:4px solid ' + colorA + ';">';
                html += '<h4 style="color:' + colorA + ';margin:0 0 8px 0;">' + labelA + '</h4>';
                html += '<p style="margin:3px 0;"><strong>' + (costeoA.nombre_costeo || '-') + '</strong></p>';
                html += '<p style="margin:3px 0;">Fecha: ' + (defA ? formatearFecha(costeoA.fecha_despacho) : formatearFecha(costeoA.fecha_factura)) + '</p>';
                html += '<p style="margin:3px 0;">TC USD: ' + fmtNum(costeoA.tc_usd) + ' | EUR: ' + fmtNum(costeoA.tc_eur) + ' | GBP: ' + fmtNum(costeoA.tc_gbp) + '</p>';
                html += '<p style="margin:3px 0;">Gastos totales: $' + fmtNum(costeoA.total_gastos_ars) + '</p>';
                html += '<p style="margin:3px 0;color:#888;">Estado: ' + (costeoA.estado || '-') + ' | Arts: ' + artsA.length + '</p>';
                html += '</div>';
                html += '<div style="flex:1;background:#1e1e2f;padding:12px;border-radius:8px;border-left:4px solid ' + colorB + ';">';
                html += '<h4 style="color:' + colorB + ';margin:0 0 8px 0;">' + labelB + '</h4>';
                html += '<p style="margin:3px 0;"><strong>' + (costeoB.nombre_costeo || '-') + '</strong></p>';
                html += '<p style="margin:3px 0;">Fecha: ' + (defB ? formatearFecha(costeoB.fecha_despacho) : formatearFecha(costeoB.fecha_factura)) + '</p>';
                html += '<p style="margin:3px 0;">TC USD: ' + fmtNum(costeoB.tc_usd) + ' | EUR: ' + fmtNum(costeoB.tc_eur) + ' | GBP: ' + fmtNum(costeoB.tc_gbp) + '</p>';
                html += '<p style="margin:3px 0;">Gastos totales: $' + fmtNum(costeoB.total_gastos_ars) + '</p>';
                html += '<p style="margin:3px 0;color:#888;">Estado: ' + (costeoB.estado || '-') + ' | Arts: ' + artsB.length + '</p>';
                html += '</div></div>';

                // Variaci√≥n general TC
                const varTcUsd = pctDif(costeoA.tc_usd, costeoB.tc_usd);
                const varTcEur = pctDif(costeoA.tc_eur, costeoB.tc_eur);
                const varGastos = pctDif(costeoA.total_gastos_ars, costeoB.total_gastos_ars);
                html += '<div style="background:#1e1e2f;padding:10px;border-radius:8px;margin-bottom:15px;display:flex;gap:20px;justify-content:center;">';
                html += '<span>Var TC USD: <strong style="color:' + colorPct(varTcUsd) + '">' + fmtPct(varTcUsd) + '</strong></span>';
                html += '<span>Var TC EUR: <strong style="color:' + colorPct(varTcEur) + '">' + fmtPct(varTcEur) + '</strong></span>';
                html += '<span>Var Gastos: <strong style="color:' + colorPct(varGastos) + '">' + fmtPct(varGastos) + '</strong></span>';
                html += '</div>';

                // Tabla art√≠culos con nombres reales en headers
                const codigos = new Set();
                artsA.forEach(a => codigos.add(a.codigo_goodies));
                artsB.forEach(a => codigos.add(a.codigo_goodies));

                const thStyle = 'padding:8px;text-align:right;border-bottom:2px solid #444;font-size:11px;';
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead>';
                // Fila de grupo: nombre de cada costeo
                html += '<tr style="background:#1a1a2e;">';
                html += '<th style="padding:4px 8px;border-bottom:1px solid #333;"></th>';
                html += '<th colspan="3" style="padding:4px 8px;text-align:center;border-bottom:1px solid #333;color:' + colorA + ';font-size:11px;">FOB en Divisa</th>';
                html += '<th colspan="3" style="padding:4px 8px;text-align:center;border-bottom:1px solid #333;color:#2196F3;font-size:11px;">Costo Neto ARS</th>';
                html += '<th colspan="3" style="padding:4px 8px;text-align:center;border-bottom:1px solid #333;color:#9C27B0;font-size:11px;">Costo Final ARS</th>';
                html += '</tr>';
                html += '<tr style="background:#2a2a3e;">';
                html += '<th style="padding:8px;text-align:left;border-bottom:2px solid #444;">Art√≠culo</th>';
                html += '<th style="' + thStyle + 'color:' + colorA + ';">Elegido</th>';
                html += '<th style="' + thStyle + 'color:' + colorB + ';">Comparado</th>';
                html += '<th style="' + thStyle + '">Var %</th>';
                html += '<th style="' + thStyle + 'color:' + colorA + ';">Elegido</th>';
                html += '<th style="' + thStyle + 'color:' + colorB + ';">Comparado</th>';
                html += '<th style="' + thStyle + '">Var %</th>';
                html += '<th style="' + thStyle + 'color:' + colorA + ';">Elegido</th>';
                html += '<th style="' + thStyle + 'color:' + colorB + ';">Comparado</th>';
                html += '<th style="' + thStyle + '">Var %</th>';
                html += '</tr></thead><tbody>';

                for (const codigo of codigos) {
                    const artA = artsA.find(a => a.codigo_goodies === codigo);
                    const artB = artsB.find(a => a.codigo_goodies === codigo);
                    const nombre = (artA || artB).nombre || '';
                    const fobA = parseFloat((artA || {}).fob_unitario_usd) || 0;
                    const fobB = parseFloat((artB || {}).fob_unitario_usd) || 0;
                    const netoA = parseFloat((artA || {}).costo_unitario_neto_ars) || 0;
                    const netoB = parseFloat((artB || {}).costo_unitario_neto_ars) || 0;
                    const finalA = parseFloat((artA || {}).costo_unitario_ars) || 0;
                    const finalB = parseFloat((artB || {}).costo_unitario_ars) || 0;
                    const varFob = pctDif(fobA, fobB);
                    const varNeto = pctDif(netoA, netoB);
                    const varFinal = pctDif(finalA, finalB);
                    const soloEnA = !artB ? ' style="background:rgba(76,175,80,0.1);"' : '';
                    const soloEnB = !artA ? ' style="background:rgba(255,152,0,0.1);"' : '';
                    const rowStyle = soloEnA || soloEnB;
                    const tdS = 'padding:6px 8px;text-align:right;border-bottom:1px solid #333;';

                    html += '<tr' + rowStyle + '>';
                    html += '<td style="padding:6px 8px;border-bottom:1px solid #333;">' + codigo + '<br><small style="color:#aaa;">' + nombre + '</small></td>';
                    html += '<td style="' + tdS + '">' + (artA && fobA ? fmtFob(fobA) : '-') + '</td>';
                    html += '<td style="' + tdS + '">' + (artB && fobB ? fmtFob(fobB) : '-') + '</td>';
                    html += '<td style="' + tdS + 'color:' + colorPct(varFob) + ';font-weight:bold;">' + (fobA && fobB ? fmtPct(varFob) : '-') + '</td>';
                    html += '<td style="' + tdS + '">$' + (artA && netoA ? fmtNum(netoA) : '-') + '</td>';
                    html += '<td style="' + tdS + '">$' + (artB && netoB ? fmtNum(netoB) : '-') + '</td>';
                    html += '<td style="' + tdS + 'color:' + colorPct(varNeto) + ';font-weight:bold;">' + (netoA && netoB ? fmtPct(varNeto) : '-') + '</td>';
                    html += '<td style="' + tdS + '">$' + (artA && finalA ? fmtNum(finalA) : '-') + '</td>';
                    html += '<td style="' + tdS + '">$' + (artB && finalB ? fmtNum(finalB) : '-') + '</td>';
                    html += '<td style="' + tdS + 'color:' + colorPct(varFinal) + ';font-weight:bold;">' + (finalA && finalB ? fmtPct(varFinal) : '-') + '</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';

                // ========== SECCI√ìN GASTOS COMPARADOS ==========
                const ga = costeoA.gastos_aduana || {};
                const gb = costeoB.gastos_aduana || {};
                const gvA = costeoA.gastos_varios || [];
                const gvB = costeoB.gastos_varios || [];

                html += '<div style="margin-top:25px;">';
                html += '<h4 style="color:#2196F3;margin-bottom:10px;cursor:pointer;" onclick="document.getElementById(\'compGastosDetail\').style.display = document.getElementById(\'compGastosDetail\').style.display === \'none\' ? \'block\' : \'none\';">üìã Detalle de Gastos (click para expandir/colapsar)</h4>';
                html += '<div id="compGastosDetail" style="display:block;">';

                // Tabla Gastos de Aduana
                html += '<h5 style="color:#aaa;margin:15px 0 8px 0;">Gastos de Aduana (ARS)</h5>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead><tr style="background:#2a2a3e;">';
                html += '<th style="padding:6px 8px;text-align:left;border-bottom:2px solid #444;">Concepto</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorA + ';">Elegido</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorB + ';">Comparado</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;">Var %</th>';
                html += '</tr></thead><tbody>';

                const gastosAduanaFields = [
                    {key: 'despachante', label: 'Despachante'},
                    {key: 'gestion_senasa', label: 'Gesti√≥n SENASA'},
                    {key: 'gestion_anmat', label: 'Gesti√≥n ANMAT'},
                    {key: 'transporte_internacional', label: 'Transporte Internacional'},
                    {key: 'gastos_origen', label: 'Gastos Origen'},
                    {key: 'terminal', label: 'Terminal'},
                    {key: 'maritima_agencia', label: 'Mar√≠tima/Agencia'},
                    {key: 'bancarios', label: 'Bancarios'},
                    {key: 'gestor', label: 'Gestor'},
                    {key: 'transporte_nacional', label: 'Transporte Nacional'},
                    {key: 'custodia', label: 'Custodia'},
                    {key: 'sim', label: 'SIM'}
                ];

                let totalGaA = 0, totalGaB = 0;
                for (const campo of gastosAduanaFields) {
                    const valA = parseFloat(ga[campo.key]) || 0;
                    const valB = parseFloat(gb[campo.key]) || 0;
                    if (valA === 0 && valB === 0) continue;
                    totalGaA += valA;
                    totalGaB += valB;
                    const varG = pctDif(valA, valB);
                    html += '<tr>';
                    html += '<td style="padding:5px 8px;border-bottom:1px solid #333;">' + campo.label + '</td>';
                    html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(valA) + '</td>';
                    html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(valB) + '</td>';
                    html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varG) + ';font-weight:bold;">' + (valA && valB ? fmtPct(varG) : '-') + '</td>';
                    html += '</tr>';
                }
                // Total gastos aduana
                const varTotalGa = pctDif(totalGaA, totalGaB);
                html += '<tr style="background:#1a1a2e;font-weight:bold;">';
                html += '<td style="padding:6px 8px;border-top:2px solid #444;">TOTAL GASTOS ADUANA</td>';
                html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;">$' + fmtNum(totalGaA) + '</td>';
                html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;">$' + fmtNum(totalGaB) + '</td>';
                html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;color:' + colorPct(varTotalGa) + ';">' + fmtPct(varTotalGa) + '</td>';
                html += '</tr>';
                html += '</tbody></table>';

                // Tabla Gastos Varios
                if (gvA.length > 0 || gvB.length > 0) {
                    html += '<h5 style="color:#aaa;margin:20px 0 8px 0;">Gastos Varios</h5>';
                    html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                    html += '<thead><tr style="background:#2a2a3e;">';
                    html += '<th style="padding:6px 8px;text-align:left;border-bottom:2px solid #444;">Descripci√≥n</th>';
                    html += '<th style="padding:6px 8px;text-align:center;border-bottom:2px solid #444;">Moneda</th>';
                    html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorA + ';">Elegido</th>';
                    html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorB + ';">Comparado</th>';
                    html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;">Var % Divisa</th>';
                    html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorA + ';">ARS Elegido</th>';
                    html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorB + ';">ARS Comparado</th>';
                    html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;">Var % ARS</th>';
                    html += '</tr></thead><tbody>';

                    // Combinar gastos por descripci√≥n normalizada
                    const gastosMap = new Map();
                    gvA.forEach(g => {
                        const key = (g.descripcion || '').toUpperCase().trim();
                        if (!gastosMap.has(key)) gastosMap.set(key, {desc: g.descripcion, moneda: g.moneda, a: null, b: null});
                        gastosMap.get(key).a = g;
                    });
                    gvB.forEach(g => {
                        const key = (g.descripcion || '').toUpperCase().trim();
                        if (!gastosMap.has(key)) gastosMap.set(key, {desc: g.descripcion, moneda: g.moneda, a: null, b: null});
                        gastosMap.get(key).b = g;
                    });

                    let totalGvArsA = 0, totalGvArsB = 0;
                    for (const [key, item] of gastosMap) {
                        const montoA = item.a ? (parseFloat(item.a.monto) || 0) : 0;
                        const montoB = item.b ? (parseFloat(item.b.monto) || 0) : 0;
                        const arsA = item.a ? (parseFloat(item.a.monto_ars) || 0) : 0;
                        const arsB = item.b ? (parseFloat(item.b.monto_ars) || 0) : 0;
                        const esStabz = key.includes('STABZ');
                        if (!esStabz) {
                            totalGvArsA += arsA;
                            totalGvArsB += arsB;
                        }
                        const varGv = pctDif(arsA, arsB);
                        const soloUno = !item.a || !item.b;
                        const rowBg = esStabz ? ' style="background:rgba(100,100,100,0.15);opacity:0.6;"' : (soloUno ? ' style="background:rgba(255,152,0,0.08);"' : '');
                        const nc = (item.a && item.a.no_contable) || (item.b && item.b.no_contable) ? ' <span style="color:#888;font-size:10px;">(NC)</span>' : '';
                        const stabzTag = esStabz ? ' <span style="color:#f44336;font-size:10px;">(excl. total)</span>' : '';

                        html += '<tr' + rowBg + '>';
                        html += '<td style="padding:5px 8px;border-bottom:1px solid #333;">' + (item.desc || '-') + nc + stabzTag + '</td>';
                        html += '<td style="padding:5px 8px;text-align:center;border-bottom:1px solid #333;">' + (item.moneda || '-') + '</td>';
                        html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + (item.a ? fmtNum(montoA) : '-') + '</td>';
                        html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + (item.b ? fmtNum(montoB) : '-') + '</td>';
                        const varDiv = pctDif(montoA, montoB);
                        html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varDiv) + ';font-weight:bold;">' + (montoA && montoB ? fmtPct(varDiv) : '-') + '</td>';
                        html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + (item.a ? fmtNum(arsA) : '-') + '</td>';
                        html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + (item.b ? fmtNum(arsB) : '-') + '</td>';
                        html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varGv) + ';font-weight:bold;">' + (arsA && arsB ? fmtPct(varGv) : '-') + '</td>';
                        html += '</tr>';
                    }
                    // Total gastos varios
                    const varTotalGv = pctDif(totalGvArsA, totalGvArsB);
                    html += '<tr style="background:#1a1a2e;font-weight:bold;">';
                    html += '<td colspan="4" style="padding:6px 8px;border-top:2px solid #444;">TOTAL GASTOS VARIOS <span style="font-weight:normal;font-size:11px;color:#888;">(sin STABZ)</span></td>';
                    html += '<td style="padding:6px 8px;border-top:2px solid #444;"></td>';
                    html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;">$' + fmtNum(totalGvArsA) + '</td>';
                    html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;">$' + fmtNum(totalGvArsB) + '</td>';
                    html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;color:' + colorPct(varTotalGv) + ';">' + fmtPct(varTotalGv) + '</td>';
                    html += '</tr>';
                    html += '</tbody></table>';
                }

                html += '</div></div>';

                // ========== SECCI√ìN BASE ADUANA ==========
                html += '<div style="margin-top:25px;">';
                html += '<h4 style="color:#e91e63;margin-bottom:10px;">üì¶ Datos para Base Aduana (Puesta FOB + Flete + Seguro)</h4>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead><tr style="background:#2a2a3e;">';
                html += '<th style="padding:6px 8px;text-align:left;border-bottom:2px solid #444;">Concepto</th>';
                html += '<th style="padding:6px 8px;text-align:center;border-bottom:2px solid #444;">Moneda</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorA + ';">Elegido</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorB + ';">Comparado</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;">Var %</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorA + ';">ARS Elegido</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;color:' + colorB + ';">ARS Comparado</th>';
                html += '<th style="padding:6px 8px;text-align:right;border-bottom:2px solid #444;">Var % ARS</th>';
                html += '</tr></thead><tbody>';

                // Puesta FOB
                const fobMontoA = parseFloat(costeoA.es_consolidado ? costeoA.fob_parte : costeoA.fob_monto) || 0;
                const fobMontoB = parseFloat(costeoB.es_consolidado ? costeoB.fob_parte : costeoB.fob_monto) || 0;
                const fobMonedaLabel = costeoA.moneda_principal || 'USD';
                const tcFobA = fobMonedaLabel === 'EUR' ? (parseFloat(costeoA.tc_eur)||0) : fobMonedaLabel === 'GBP' ? (parseFloat(costeoA.tc_gbp)||0) : (parseFloat(costeoA.tc_usd)||0);
                const tcFobB = fobMonedaLabel === 'EUR' ? (parseFloat(costeoB.tc_eur)||0) : fobMonedaLabel === 'GBP' ? (parseFloat(costeoB.tc_gbp)||0) : (parseFloat(costeoB.tc_usd)||0);
                const fobArsBA = fobMontoA * tcFobA;
                const fobArsBB = fobMontoB * tcFobB;
                const varFobBDiv = pctDif(fobMontoA, fobMontoB);
                const varFobBArs = pctDif(fobArsBA, fobArsBB);
                html += '<tr>';
                html += '<td style="padding:5px 8px;border-bottom:1px solid #333;">Puesta FOB</td>';
                html += '<td style="padding:5px 8px;text-align:center;border-bottom:1px solid #333;">' + fobMonedaLabel + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + fmtNum(fobMontoA) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + fmtNum(fobMontoB) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varFobBDiv) + ';font-weight:bold;">' + fmtPct(varFobBDiv) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(fobArsBA) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(fobArsBB) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varFobBArs) + ';font-weight:bold;">' + fmtPct(varFobBArs) + '</td>';
                html += '</tr>';

                // Flete
                const fleteMontoA = parseFloat(costeoA.es_consolidado ? costeoA.flete_parte : costeoA.flete_monto) || 0;
                const fleteMontoB = parseFloat(costeoB.es_consolidado ? costeoB.flete_parte : costeoB.flete_monto) || 0;
                const fleteMoneda = (costeoA.flete_moneda || 'USD').toUpperCase();
                const tcFleteA = fleteMoneda === 'EUR' ? (parseFloat(costeoA.tc_eur)||0) : fleteMoneda === 'GBP' ? (parseFloat(costeoA.tc_gbp)||0) : (parseFloat(costeoA.tc_usd)||0);
                const tcFleteB = fleteMoneda === 'EUR' ? (parseFloat(costeoB.tc_eur)||0) : fleteMoneda === 'GBP' ? (parseFloat(costeoB.tc_gbp)||0) : (parseFloat(costeoB.tc_usd)||0);
                const fleteArsA = fleteMontoA * tcFleteA;
                const fleteArsB = fleteMontoB * tcFleteB;
                const varFleteDiv = pctDif(fleteMontoA, fleteMontoB);
                const varFleteArs = pctDif(fleteArsA, fleteArsB);
                html += '<tr>';
                html += '<td style="padding:5px 8px;border-bottom:1px solid #333;">Flete Internacional</td>';
                html += '<td style="padding:5px 8px;text-align:center;border-bottom:1px solid #333;">' + fleteMoneda + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + fmtNum(fleteMontoA) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + fmtNum(fleteMontoB) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varFleteDiv) + ';font-weight:bold;">' + fmtPct(varFleteDiv) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(fleteArsA) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(fleteArsB) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varFleteArs) + ';font-weight:bold;">' + fmtPct(varFleteArs) + '</td>';
                html += '</tr>';

                // Seguro
                const segMontoA = parseFloat(costeoA.es_consolidado ? costeoA.seguro_parte : costeoA.seguro_monto) || 0;
                const segMontoB = parseFloat(costeoB.es_consolidado ? costeoB.seguro_parte : costeoB.seguro_monto) || 0;
                const segMoneda = (costeoA.seguro_moneda || 'USD').toUpperCase();
                const tcSegA = segMoneda === 'EUR' ? (parseFloat(costeoA.tc_eur)||0) : segMoneda === 'GBP' ? (parseFloat(costeoA.tc_gbp)||0) : (parseFloat(costeoA.tc_usd)||0);
                const tcSegB = segMoneda === 'EUR' ? (parseFloat(costeoB.tc_eur)||0) : segMoneda === 'GBP' ? (parseFloat(costeoB.tc_gbp)||0) : (parseFloat(costeoB.tc_usd)||0);
                const segArsA = segMontoA * tcSegA;
                const segArsB = segMontoB * tcSegB;
                const varSegDiv = pctDif(segMontoA, segMontoB);
                const varSegArs = pctDif(segArsA, segArsB);
                html += '<tr>';
                html += '<td style="padding:5px 8px;border-bottom:1px solid #333;">Seguro</td>';
                html += '<td style="padding:5px 8px;text-align:center;border-bottom:1px solid #333;">' + segMoneda + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + fmtNum(segMontoA) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">' + fmtNum(segMontoB) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varSegDiv) + ';font-weight:bold;">' + fmtPct(varSegDiv) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(segArsA) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;">$' + fmtNum(segArsB) + '</td>';
                html += '<td style="padding:5px 8px;text-align:right;border-bottom:1px solid #333;color:' + colorPct(varSegArs) + ';font-weight:bold;">' + fmtPct(varSegArs) + '</td>';
                html += '</tr>';

                // Total Base Aduana
                const totalBaseA = fobArsBA + fleteArsA + segArsA;
                const totalBaseB = fobArsBB + fleteArsB + segArsB;
                const varTotalBase = pctDif(totalBaseA, totalBaseB);
                html += '<tr style="background:#1a1a2e;font-weight:bold;">';
                html += '<td colspan="5" style="padding:6px 8px;border-top:2px solid #444;">TOTAL BASE ADUANA (ARS)</td>';
                html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;">$' + fmtNum(totalBaseA) + '</td>';
                html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;">$' + fmtNum(totalBaseB) + '</td>';
                html += '<td style="padding:6px 8px;text-align:right;border-top:2px solid #444;color:' + colorPct(varTotalBase) + ';">' + fmtPct(varTotalBase) + '</td>';
                html += '</tr>';
                html += '</tbody></table>';
                html += '</div>';

                document.getElementById('compPvsDefBody').innerHTML = html;
                document.getElementById('compPvsDefTitle').textContent = 'Comparativo: ' + costeoA.nombre_costeo + ' vs ' + costeoB.nombre_costeo;
                document.getElementById('compPvsDefModal').classList.add('show');
            } catch (err) {
                console.error(err);
                alert('Error al generar comparativo');
            }
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { cerrarModal('detalleModal'); cerrarModal('recalcularModal'); cerrarModal('cargaManualModal'); cerrarModal('compPvsDefModal'); } });
function abrirCargaManual() {
            window.costeoEditandoId = null;
            articulosManual = [];
            gastosManual = [];
            proveedoresConsolidado = [];
            document.getElementById('cm_nombre').value = '';
            document.getElementById('cm_proveedor').value = '';
            document.getElementById('cm_tieneIntermediaria').checked = false;
            document.getElementById('cm_intermediaria').value = '';
            document.getElementById('cm_intermediariaGroup').style.display = 'none';
           document.getElementById('cm_facturaIntermGroup').style.display = 'none';
            document.getElementById('cm_fechaFacturaIntermGroup').style.display = 'none';
            document.getElementById('cm_fechaVencIntermGroup').style.display = 'none';
            document.getElementById('cm_facturaInterm').value = '';
            document.getElementById('cm_fechaVencInterm').value = '';
            document.getElementById('cm_fechaFacturaInterm').value = '';
            document.getElementById('cm_esConsolidado').checked = false;
            document.getElementById('cm_consolidadoSection').style.display = 'none';
            document.getElementById('cm_volumenM3').value = '';
            document.getElementById('cm_pesoKg').value = '';
            const thConsolidado = document.getElementById('thConsolidado');
            if (thConsolidado) thConsolidado.style.display = 'none';
            document.getElementById('cm_facturaNro').value = '';
            document.getElementById('cm_moneda').value = 'USD';
            document.getElementById('cm_monto').value = '';
            document.getElementById('cm_fechaFactura').value = '';
            document.getElementById('cm_fechaVenc').value = '';
            document.getElementById('cm_fechaDespacho').value = '';
            document.getElementById('cm_nroDespacho').value = '';
            document.getElementById('cm_tcUsd').value = '';
            document.getElementById('cm_tcEur').value = '';
            document.getElementById('cm_tcGbp').value = '';
            document.getElementById('cm_fobMoneda').value = 'USD';
            document.getElementById('cm_fobMonto').value = '';
            document.getElementById('cm_fleteMoneda').value = 'USD';
            document.getElementById('cm_fleteMonto').value = '';
            document.getElementById('cm_seguroMoneda').value = 'USD';
            document.getElementById('cm_seguroMonto').value = '';
            
            
            agregarArticulo();
            agregarGasto();
            cambiarTab('datosGenerales');
            document.getElementById('cargaManualModal').classList.add('show');
        }
        function toggleIntermediaria() {
            const tiene = document.getElementById('cm_tieneIntermediaria').checked;
            document.getElementById('cm_intermediariaGroup').style.display = tiene ? 'block' : 'none';
            document.getElementById('cm_facturaIntermGroup').style.display = tiene ? 'block' : 'none';
            document.getElementById('cm_fechaFacturaIntermGroup').style.display = tiene ? 'block' : 'none';
            document.getElementById('cm_fechaVencIntermGroup').style.display = tiene ? 'block' : 'none';
            
            renderizarArticulos();
        }
        
        // Variables para consolidado
        let proveedoresConsolidado = [];
        
        function toggleConsolidado() {
            const esConsolidado = document.getElementById('cm_esConsolidado').checked;
            document.getElementById('cm_consolidadoSection').style.display = esConsolidado ? 'block' : 'none';
            const thConsolidado = document.getElementById('thConsolidado');
const thMontoProrrateado = document.getElementById('thMontoProrrateado');
            if (thConsolidado) thConsolidado.style.display = esConsolidado ? 'table-cell' : 'none';
if (thMontoProrrateado) thMontoProrrateado.style.display = esConsolidado ? 'table-cell' : 'none';
const btnVerComparativo = document.getElementById('btnVerComparativo'); if (btnVerComparativo) btnVerComparativo.style.display = esConsolidado ? 'inline-block' : 'none';
const fobParteGroup = document.getElementById('fobParteGroup'); if (fobParteGroup) fobParteGroup.style.display = esConsolidado ? 'block' : 'none';
const fleteParteGroup = document.getElementById('fleteParteGroup'); if (fleteParteGroup) fleteParteGroup.style.display = esConsolidado ? 'block' : 'none';
            const seguroParteGroup = document.getElementById('seguroParteGroup'); if (seguroParteGroup) seguroParteGroup.style.display = esConsolidado ? 'block' : 'none';
            if (esConsolidado) calcularPartesBaseAduana();
            if (esConsolidado && proveedoresConsolidado.length === 0) {
                agregarProveedorConsolidado();
            }
            renderizarProveedoresConsolidado();
            renderizarGastos();
        }
        
        function agregarProveedorConsolidado() {
            proveedoresConsolidado.push({ nombre: '', fob_total: '', moneda: 'USD', volumen_m3: '', peso_kg: '' });
            renderizarProveedoresConsolidado();
        }
        
        function eliminarProveedorConsolidado(idx) {
            proveedoresConsolidado.splice(idx, 1);
            renderizarProveedoresConsolidado();
        }
        
        function renderizarProveedoresConsolidado() {
            const container = document.getElementById('consolidadoProveedoresBody');
            if (!container) return;
            container.innerHTML = proveedoresConsolidado.map((p, idx) => {
                return '<div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; background:#252538; padding:10px; border-radius:5px;">' +
                    '<input type="text" value="' + (p.nombre || '') + '" onchange="proveedoresConsolidado[' + idx + '].nombre=this.value" placeholder="Nombre Proveedor" style="flex:2;">' +
                    '<input type="number" step="0.01" value="' + (p.fob_total || '') + '" onchange="proveedoresConsolidado[' + idx + '].fob_total=this.value" placeholder="FOB Total" style="flex:1;">' +
                    '<select onchange="proveedoresConsolidado[' + idx + '].moneda=this.value" style="flex:0.5;">' +
                        '<option value="USD" ' + (p.moneda === 'USD' ? 'selected' : '') + '>USD</option>' +
                        '<option value="EUR" ' + (p.moneda === 'EUR' ? 'selected' : '') + '>EUR</option>' +
                        '<option value="GBP" ' + (p.moneda === 'GBP' ? 'selected' : '') + '>GBP</option>' +
                    '</select>' +
                    '<input type="number" step="0.01" value="' + (p.volumen_m3 || '') + '" onchange="proveedoresConsolidado[' + idx + '].volumen_m3=this.value" placeholder="m¬≥" style="flex:0.7;">' +
                    '<input type="number" step="0.01" value="' + (p.peso_kg || '') + '" onchange="proveedoresConsolidado[' + idx + '].peso_kg=this.value" placeholder="Kg" style="flex:0.7;">' +
                    '<button class="btn btn-danger btn-sm" onclick="eliminarProveedorConsolidado(' + idx + ')">X</button>' +
                '</div>';
            }).join('');
        }

        function cambiarTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[onclick*="' + tabId + '"]').classList.add('active');
            document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
if (tabId === 'baseAduana') calcularPartesBaseAduana();
        }
function mapearArticuloDesdeDB(a) {
            const dRaw = parseFloat(a.derechos_porcentaje) || 0;
            const iRaw = parseFloat(a.impuesto_interno_porcentaje) || 0;
            return {
                codigo_goodies: a.codigo_goodies || '',
                codigo_proveedor: a.codigo_proveedor || '',
                nombre: a.nombre || '',
                cajas: a.cantidad_cajas || '',
                und_caja: a.unidades_por_caja || '',
                valor_fabrica: (a.valor_proveedor_origen != null && parseFloat(a.valor_proveedor_origen) > 0) ? a.valor_proveedor_origen : '',
                valor_origen: (a.valor_unitario_origen != null && a.valor_unitario_origen !== '') ? a.valor_unitario_origen : '',
                derechos: dRaw > 0 ? (dRaw <= 1 ? +(dRaw * 100).toFixed(4) : dRaw) : '',
                imp_interno: iRaw > 0 ? (iRaw <= 1 ? +(iRaw * 100).toFixed(4) : iRaw) : '',
                aplica_anmat: a.aplica_anmat !== false,
                grupo: a.grupo || ''
            };
        }
function agregarArticulo() {
            const idx = articulosManual.length;
            articulosManual.push({ codigo_goodies: '', codigo_proveedor: '', nombre: '', cajas: '', und_caja: '', valor_fabrica: '', valor_origen: '', derechos: '', imp_interno: '', aplica_anmat: true, grupo: '' });
            renderizarArticulos();
        }

        function eliminarArticulo(idx) {
            articulosManual.splice(idx, 1);
            renderizarArticulos();
        }

        function renderizarArticulos() {
            const tbody = document.getElementById('articulosBody');
            const tieneDatosFabrica = document.getElementById('cm_tieneIntermediaria').checked;
            tbody.innerHTML = articulosManual.map((art, idx) => {
                const aplicaAnmat = art.aplica_anmat !== false;
                return '<tr>' +
                    '<td>' + (idx + 1) + '</td>' +
                    '<td><input type="text" value="' + (art.codigo_goodies || '') + '" onchange="articulosManual[' + idx + '].codigo_goodies=this.value" onblur="buscarEnMaestro(' + idx + ', this.value)" style="width:120px;"></td>' +
                    '<td><input type="text" value="' + (art.codigo_proveedor || '') + '" onchange="articulosManual[' + idx + '].codigo_proveedor=this.value" style="width:100px;"></td>' +
                    '<td><input type="text" value="' + (art.nombre || '') + '" onchange="articulosManual[' + idx + '].nombre=this.value" style="width:100%;min-width:280px;"></td>' +
                    '<td><input type="number" step="0.01" value="' + (art.cajas || '') + '" onchange="articulosManual[' + idx + '].cajas=this.value" style="width:60px;"></td>' +
                    '<td><input type="number" step="0.01" value="' + (art.und_caja || '') + '" onchange="articulosManual[' + idx + '].und_caja=this.value" style="width:60px;"></td>' +
                    '<td><input type="number" step="0.01" value="' + (art.valor_fabrica || '') + '" onchange="actualizarValorFabrica(' + idx + ', this.value)" style="width:80px;"></td>' +
                    '<td><input type="number" step="0.01" value="' + (art.valor_origen || '') + '" onchange="articulosManual[' + idx + '].valor_origen=this.value" style="width:80px;"></td>'  +
                    '<td><input type="number" step="0.01" value="' + (art.derechos || '') + '" onchange="articulosManual[' + idx + '].derechos=this.value" style="width:60px;"></td>' +
                    '<td><input type="number" step="0.01" value="' + (art.imp_interno || '') + '" onchange="articulosManual[' + idx + '].imp_interno=this.value" style="width:60px;"></td>' +
                    '<td><input type="checkbox" ' + (aplicaAnmat ? 'checked' : '') + ' onchange="articulosManual[' + idx + '].aplica_anmat=this.checked"></td>' +
                    '<td><input type="text" value="' + (art.grupo || '') + '" onchange="articulosManual[' + idx + '].grupo=this.value" style="width:60px;" placeholder=""></td>' +
                    '<td><button class="btn btn-danger btn-sm" onclick="eliminarArticulo(' + idx + ')">X</button></td>' +
                    '</tr>';
            }).join('');
        }
function actualizarValorFabrica(idx, valor) {
    articulosManual[idx].valor_fabrica = valor;
    const tieneDatosFabrica = document.getElementById('cm_tieneIntermediaria').checked;
    if (tieneDatosFabrica) {
        articulosManual[idx].valor_origen = (parseFloat(valor) / 0.97).toFixed(2);
    } else {
        articulosManual[idx].valor_origen = valor;
    }
    renderizarArticulos();
}
function recalcularValoresOrigen() {
    const tieneDatosFabrica = document.getElementById('cm_tieneIntermediaria')?.checked;
    articulosManual.forEach(art => {
        const valorFabrica = parseFloat(art.valor_fabrica) || 0;
        if (valorFabrica > 0) {
            if (tieneDatosFabrica) {
                art.valor_origen = (valorFabrica / 0.97).toFixed(2);
            } else {
                art.valor_origen = art.valor_fabrica;
            }
        }
    });
    renderizarArticulos();
}
        function calcularValoresIntermediaria() {
            const margen = parseFloat(document.getElementById('cm_margenIntermediaria').value) || 0;
            if (margen <= 0 || margen >= 100) { alert('Ingresa un margen valido (entre 0 y 100)'); return; }
            articulosManual.forEach(art => {
                const origen = parseFloat(art.valor_origen) || 0;
                if (origen > 0) {
                    art.valor_intermediaria = (origen / (1 - margen / 100)).toFixed(4);
                }
            });
            renderizarArticulos();
            alert('Valores Intermediaria calculados con margen ' + margen + '%');
        }
function agregarGasto() {
            gastosManual.push({ descripcion: '', proveedor: '', nro_comprobante: '', moneda: 'USD', monto: '', recargo: '', grupo: '', metodo_prorrateo: 'por_fob', prorratear_consolidado: false, observaciones: '', no_contable: false });
            renderizarGastos();
        }

        function eliminarGasto(idx) {
            gastosManual.splice(idx, 1);
            renderizarGastos();
        }
function renderizarGastos() {
            const tbody = document.getElementById('gastosBody');
            const esConsolidado = document.getElementById('cm_esConsolidado')?.checked || false;
            tbody.innerHTML = gastosManual.map((g, idx) => {
                const metodo = g.metodo_prorrateo || 'por_fob';
                // Fix recargo display: if stored as decimal (< 1 and != 0), convert to percentage
                let recargoDisplay = g.recargo || '';
                if (recargoDisplay !== '' && parseFloat(recargoDisplay) !== 0 && Math.abs(parseFloat(recargoDisplay)) < 1) {
                    recargoDisplay = (parseFloat(recargoDisplay) * 100).toFixed(2);
                    gastosManual[idx].recargo = recargoDisplay; // fix in memory too
                }
                return '<tr' + (g.no_contable ? ' style="opacity:0.6;"' : '') + '>' +
                    '<td>' + (idx + 1) + '</td>' +
                    '<td><input type="text" value="' + (g.descripcion || '') + '" onchange="gastosManual[' + idx + '].descripcion=this.value"></td>' +
                    '<td><input type="text" value="' + (g.proveedor || '') + '" onchange="gastosManual[' + idx + '].proveedor=this.value" style="width:100px;"></td>' +
                    '<td><input type="text" value="' + (g.nro_comprobante || '') + '" onchange="gastosManual[' + idx + '].nro_comprobante=this.value" style="width:100px;"></td>' +
                    '<td><select onchange="gastosManual[' + idx + '].moneda=this.value"><option value="USD" ' + (g.moneda === 'USD' ? 'selected' : '') + '>USD</option><option value="EUR" ' + (g.moneda === 'EUR' ? 'selected' : '') + '>EUR</option><option value="GBP" ' + (g.moneda === 'GBP' ? 'selected' : '') + '>GBP</option><option value="ARS" ' + (g.moneda === 'ARS' ? 'selected' : '') + '>ARS</option></select></td>' +
                    '<td><input type="number" step="0.01" value="' + (g.monto || '') + '" onchange="gastosManual[' + idx + '].monto=this.value" style="width:100px;"></td>' +
                    '<td><input type="number" step="0.01" value="' + recargoDisplay + '" onchange="gastosManual[' + idx + '].recargo=this.value" style="width:60px;"></td>' +
                    '<td><input type="text" value="' + (g.grupo || '') + '" onchange="gastosManual[' + idx + '].grupo=this.value" style="width:60px;" placeholder=""></td>' +
                    (esConsolidado ? '<td><select onchange="gastosManual[' + idx + '].metodo_prorrateo=this.value; renderizarGastos();" style="width:100px;"><option value="por_fob" ' + (metodo === 'por_fob' ? 'selected' : '') + '>Por FOB</option><option value="por_volumen" ' + (metodo === 'por_volumen' ? 'selected' : '') + '>Por Volumen</option><option value="por_peso" ' + (metodo === 'por_peso' ? 'selected' : '') + '>Por Peso</option><option value="no_prorratear" ' + (metodo === 'no_prorratear' ? 'selected' : '') + '>No Prorratear</option></select></td>' : '') +
                    (esConsolidado ? '<td style="text-align:right;color:#4CAF50;font-weight:bold;">' + calcularMontoProrrateado(g) + '</td>' : '') +
                    '<td style="text-align:center;"><input type="checkbox" ' + (g.no_contable ? 'checked' : '') + ' onchange="gastosManual[' + idx + '].no_contable=this.checked; renderizarGastos();" title="Excluir de revaluaci√≥n contable"></td>' +
                    '<td><input type="text" value="' + (g.observaciones || '') + '" onchange="gastosManual[' + idx + '].observaciones=this.value" style="width:120px;"></td>' +
                    '<td><button class="btn btn-danger btn-sm" onclick="eliminarGasto(' + idx + ')">X</button></td>' +
                    '</tr>';
            }).join('');
        }
function calcularPartesBaseAduana() {
            const esConsolidado = document.getElementById('cm_esConsolidado')?.checked || false;
            if (!esConsolidado) return;
            const p = calcularParticipaciones();
const fobMonto = parseFloat(document.getElementById('cm_fobMonto').value) || 0;           
const fleteMonto = parseFloat(document.getElementById('cm_fleteMonto').value) || 0;
            const seguroMonto = parseFloat(document.getElementById('cm_seguroMonto').value) || 0;
const fobParte = (fobMonto * p.fob / 100).toFixed(2);            
const fleteParte = (fleteMonto * p.fob / 100).toFixed(2);
            const seguroParte = (seguroMonto * p.fob / 100).toFixed(2);
document.getElementById('cm_fobParte').value = fobParte;            
document.getElementById('cm_fleteParte').value = fleteParte;
            document.getElementById('cm_seguroParte').value = seguroParte;
        }
function calcularMontoProrrateado(g) {
            const p = calcularParticipaciones();
            const monto = parseFloat(g.monto) || 0;
            const recargo = parseFloat(g.recargo) || 0;
            const montoConRecargo = monto * (1 + recargo / 100);
            const metodo = g.metodo_prorrateo || 'por_fob';
            let pct = 0;
            if (metodo === 'no_prorratear') pct = 100;
            else if (metodo === 'por_fob') pct = p.fob;
            else if (metodo === 'por_volumen') pct = p.volumen;
            else if (metodo === 'por_peso') pct = p.peso;
            return (montoConRecargo * pct / 100).toFixed(2);
        }
 function calcularParticipaciones() {
            const tcUsd = parseFloat(document.getElementById('cm_tcUsd').value) || 1;
            const tcEur = parseFloat(document.getElementById('cm_tcEur').value) || tcUsd;
            const tcGbp = parseFloat(document.getElementById('cm_tcGbp').value) || tcUsd;
            const monedaPrincipal = (document.getElementById('cm_moneda').value || 'USD').toUpperCase();
            let tcPrincipal = tcUsd;
            if (monedaPrincipal === 'EUR') tcPrincipal = tcEur;
            else if (monedaPrincipal === 'GBP') tcPrincipal = tcGbp;
            const montoFactura = parseFloat(document.getElementById('cm_monto').value) || 0;
            let fobActualDivisa = 0;
            if (montoFactura > 0) {
                fobActualDivisa = montoFactura;
            } else {
                articulosManual.forEach(a => {
                    const cajas = parseFloat(a.cajas) || 0;
                    const undCaja = parseFloat(a.und_caja) || 0;
                    const valorOrigen = parseFloat(a.valor_origen) || 0;
                    fobActualDivisa += cajas * undCaja * valorOrigen;
                });
            }
            const fobActual = fobActualDivisa * tcPrincipal;
            const volumenActual = parseFloat(document.getElementById('cm_volumenM3').value) || 0;
            const pesoActual = parseFloat(document.getElementById('cm_pesoKg').value) || 0;
            let fobTotal = fobActual, volumenTotal = volumenActual, pesoTotal = pesoActual;
            proveedoresConsolidado.forEach(p => {
                let fobProv = parseFloat(p.fob_total) || 0;
                const monedaProv = (p.moneda || 'USD').toUpperCase();
                let tcProv = tcUsd;
                if (monedaProv === 'EUR') tcProv = tcEur;
                else if (monedaProv === 'GBP') tcProv = tcGbp;
                const fobProvARS = fobProv * tcProv;
                fobTotal += fobProvARS;
                volumenTotal += parseFloat(p.volumen_m3) || 0;
                pesoTotal += parseFloat(p.peso_kg) || 0;
            });
            return { fob: fobTotal > 0 ? (fobActual / fobTotal * 100) : 0, volumen: volumenTotal > 0 ? (volumenActual / volumenTotal * 100) : 0, peso: pesoTotal > 0 ? (pesoActual / pesoTotal * 100) : 0, fobActual, fobTotal, volumenActual, volumenTotal, pesoActual, pesoTotal };
        }

     function mostrarComparativoParticipaciones() {
            const p = calcularParticipaciones();
            const provActual = document.getElementById('cm_proveedor').value || 'Proveedor Actual';
            const tcUsd = parseFloat(document.getElementById('cm_tcUsd').value) || 1;
            const tcEur = parseFloat(document.getElementById('cm_tcEur').value) || tcUsd;
            const tcGbp = parseFloat(document.getElementById('cm_tcGbp').value) || tcUsd;
            let html = '<div style="padding:10px;"><table style="width:100%;border-collapse:collapse;"><tr style="background:#333;"><th style="padding:12px;text-align:left;">Proveedor</th><th style="padding:12px;text-align:right;">% Por FOB</th><th style="padding:12px;text-align:right;">% Por Volumen</th><th style="padding:12px;text-align:right;">% Por Peso</th></tr>';
            html += '<tr style="background:#1a3a1a;"><td style="padding:12px;font-weight:bold;">' + provActual + ' (actual)</td><td style="padding:12px;text-align:right;color:#4CAF50;font-weight:bold;">' + p.fob.toFixed(2) + '%</td><td style="padding:12px;text-align:right;color:#2196F3;font-weight:bold;">' + p.volumen.toFixed(2) + '%</td><td style="padding:12px;text-align:right;color:#ff9800;font-weight:bold;">' + p.peso.toFixed(2) + '%</td></tr>';
            proveedoresConsolidado.forEach(prov => {
                let fobProv = parseFloat(prov.fob_total) || 0;
                const monedaProv = (prov.moneda || 'USD').toUpperCase();
                let tcProv = tcUsd;
                if (monedaProv === 'EUR') tcProv = tcEur;
                else if (monedaProv === 'GBP') tcProv = tcGbp;
                const fobProvARS = fobProv * tcProv;
                const pctFob = p.fobTotal > 0 ? (fobProvARS / p.fobTotal * 100) : 0;
                const volProv = parseFloat(prov.volumen_m3) || 0;
                const pctVol = p.volumenTotal > 0 ? (volProv / p.volumenTotal * 100) : 0;
                const pesoProv = parseFloat(prov.peso_kg) || 0;
                const pctPeso = p.pesoTotal > 0 ? (pesoProv / p.pesoTotal * 100) : 0;
                html += '<tr style="border-bottom:1px solid #444;"><td style="padding:12px;">' + (prov.nombre || 'Sin nombre') + '</td><td style="padding:12px;text-align:right;">' + pctFob.toFixed(2) + '%</td><td style="padding:12px;text-align:right;">' + pctVol.toFixed(2) + '%</td><td style="padding:12px;text-align:right;">' + pctPeso.toFixed(2) + '%</td></tr>';
            });
            html += '</table></div>';
            document.getElementById('comparativoModalBody').innerHTML = html;
            document.getElementById('consolidadoCompModal').style.display = 'flex';
        }
function refrescarDatosGenerales() {
            recalcularValoresOrigen();
            renderizarProveedoresConsolidado();
            calcularPartesBaseAduana();
            renderizarArticulos();
            renderizarGastos();
            alert('‚úÖ Datos Generales actualizados');
        }

        function refrescarBaseAduana() {
            calcularPartesBaseAduana();
            renderizarGastos();
            alert('‚úÖ Base Aduana recalculada');
        }

        function refrescarArticulos() {
            recalcularValoresOrigen();
            renderizarArticulos();
            calcularPartesBaseAduana();
            renderizarGastos();
            alert('‚úÖ Art√≠culos y participaciones actualizados');
        }

        function refrescarGastos() {
            calcularPartesBaseAduana();
            renderizarGastos();
            alert('‚úÖ Gastos y prorrateos recalculados');
        }

function descargarTemplateArticulos() {
            const contenido = 'Cod_Goodies\tCod_Proveedor\tNombre\tCajas\tUnd_Caja\tValor_Origen\tValor_Interm\tPct_Derecho\tPct_Imp_Interno\n' +
                'COD001\tPROV001\tProducto Ejemplo\t10\t24\t5.50\t6.00\t18\t0\n';
            const blob = new Blob([contenido], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_articulos.xls';
            a.click();
            URL.revokeObjectURL(url);
        }

        function descargarTemplateGastos() {
            const contenido = 'Descripcion\tProveedor\tNro_Comprobante\tMoneda\tMonto\tPct_Recargo\tObservaciones\tNo_Contable\n' +
                'Flete Internacional\tTransporte SA\tFC-0001\tUSD\t1500\t3\tEjemplo de gasto\t\n';
            const blob = new Blob([contenido], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_gastos.xls';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importarArticulosExcel(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const lines = data.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { alert('El archivo no tiene datos'); return; }
                    const tieneInterm = document.getElementById('cm_tieneIntermediaria').checked;
                    articulosManual = [];
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split('\t');
                        if (cols.length >= 6) {
                            const valorOrigen = cols[5] || '';
                            const valorInterm = cols[6] || valorOrigen;
                            articulosManual.push({
                                codigo_goodies: cols[0] || '',
                                codigo_proveedor: cols[1] || '',
                                nombre: cols[2] || '',
                                cajas: cols[3] || '',
                                und_caja: cols[4] || '',
                                valor_fabrica: cols[5] || '',
                                valor_origen: valorOrigen,
                                derechos: cols[7] || '',
                                imp_interno: cols[8] || ''
                            });
                        }
                    }
                    renderizarArticulos();
                    alert('Se importaron ' + articulosManual.length + ' articulos');
                } catch (err) {
                    alert('Error al leer el archivo: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function importarGastosExcel(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const lines = data.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { alert('El archivo no tiene datos'); return; }
                    gastosManual = [];
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split('\t');
                        if (cols.length >= 5) {
                            gastosManual.push({
                                descripcion: cols[0] || '',
                                proveedor: cols[1] || '',
                                nro_comprobante: cols[2] || '',
                                moneda: cols[3] || 'USD',
                                monto: cols[4] || '',
                                recargo: cols[5] || '',
                                observaciones: cols[6] || '',
                                no_contable: (cols[7] || '').toUpperCase() === 'SI'
                            });
                        }
                    }
                    renderizarGastos();
                    alert('Se importaron ' + gastosManual.length + ' gastos');
                } catch (err) {
                    alert('Error al leer el archivo: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        async function guardarCargaManual() {
            const nombre = document.getElementById('cm_nombre').value.trim();
            const proveedor = document.getElementById('cm_proveedor').value.trim();
            const moneda = document.getElementById('cm_moneda').value;
            if (!nombre) { alert('El nombre del costeo es obligatorio'); cambiarTab('datosGenerales'); return; }
            if (!proveedor) { alert('El proveedor es obligatorio'); cambiarTab('datosGenerales'); return; }
            if (articulosManual.length === 0 || !articulosManual[0].nombre) { alert('Debe agregar al menos un articulo'); cambiarTab('articulos'); return; }
            const tieneIntermediaria = document.getElementById('cm_tieneIntermediaria').checked;
            const articulos = articulosManual.filter(a => a.nombre).map(a => {
                return {
                    codigo_goodies: a.codigo_goodies || 'S/COD',
                    codigo_proveedor: a.codigo_proveedor || '',
                    nombre: a.nombre,
                    cantidad_cajas: parseFloat(a.cajas) || 0,
                    unidades_por_caja: parseFloat(a.und_caja) || 0,
                    valor_fabrica: parseFloat(a.valor_fabrica) || 0,
                    valor_unitario_origen: parseFloat(a.valor_origen) || 0,
                    derechos_porcentaje: (parseFloat(a.derechos) || 0) / 100,
                    impuesto_interno_porcentaje: (parseFloat(a.imp_interno) || 0) / 100,
                    aplica_anmat: a.aplica_anmat !== false,
                    grupo: a.grupo || ''
                };
            });
            const gastos = gastosManual.filter(g => g.descripcion).map(g => ({
                descripcion: g.descripcion,
                proveedor_gasto: g.proveedor || '',
                nro_comprobante: g.nro_comprobante || 'ESTIMADO',
                moneda: g.moneda || 'USD',
                monto: parseFloat(g.monto) || 0,
                recargo: parseFloat(g.recargo) || 0,
                grupo: g.grupo || '',
                prorratear_consolidado: g.prorratear_consolidado || false,
metodo_prorrateo: g.metodo_prorrateo || 'por_fob',
monto_prorrateado: parseFloat(calcularMontoProrrateado(g)) || 0,
                observaciones: g.observaciones || '',
                no_contable: g.no_contable || false
            }));
            const esConsolidado = document.getElementById('cm_esConsolidado').checked;
            const datos = {
                nombre_costeo: nombre,
                proveedor: proveedor,
                tiene_intermediaria: tieneIntermediaria,
                empresa_intermediaria: tieneIntermediaria ? document.getElementById('cm_intermediaria').value : null,
                factura_intermediaria: tieneIntermediaria ? document.getElementById('cm_facturaInterm').value : null,
                fecha_factura_intermediaria: tieneIntermediaria ? document.getElementById('cm_fechaFacturaInterm').value : null,
                fecha_vencimiento_intermediaria: tieneIntermediaria ? document.getElementById('cm_fechaVencInterm').value : null,
                factura_nro: document.getElementById('cm_facturaNro').value,
                moneda_principal: moneda,
                monto_factura: parseFloat(document.getElementById('cm_monto').value) || 0,
                fecha_factura: document.getElementById('cm_fechaFactura').value || null,
                fecha_vencimiento_factura: document.getElementById('cm_fechaVenc').value || null,
                fecha_despacho: document.getElementById('cm_fechaDespacho').value || null,
                nro_despacho: document.getElementById('cm_nroDespacho').value || null,
                tc_usd: parseFloat(document.getElementById('cm_tcUsd').value) || null,
                tc_eur: parseFloat(document.getElementById('cm_tcEur').value) || null,
                tc_gbp: parseFloat(document.getElementById('cm_tcGbp').value) || null,
                fob_moneda: document.getElementById('cm_fobMoneda').value,
                fob_monto: parseFloat(document.getElementById('cm_fobMonto').value) || 0,
                flete_moneda: document.getElementById('cm_fleteMoneda').value,
                flete_monto: parseFloat(document.getElementById('cm_fleteMonto').value) || 0,
                seguro_moneda: document.getElementById('cm_seguroMoneda').value,
                seguro_monto: parseFloat(document.getElementById('cm_seguroMonto').value) || 0,
fob_parte: parseFloat(document.getElementById('cm_fobParte')?.value) || 0,
                flete_parte: parseFloat(document.getElementById('cm_fleteParte')?.value) || 0,
                seguro_parte: parseFloat(document.getElementById('cm_seguroParte')?.value) || 0,
                es_consolidado: esConsolidado,
                volumen_m3: esConsolidado ? parseFloat(document.getElementById('cm_volumenM3').value) || null : null,
                peso_kg: esConsolidado ? parseFloat(document.getElementById('cm_pesoKg').value) || null : null,
                proveedores_consolidado: esConsolidado ? proveedoresConsolidado : [],
                articulos: articulos,
                gastos: gastos
            };
            try {
                let url = API_URL + '/api/costeos/manual';
                let method = 'POST';
                if (window.costeoEditandoId) {
                    url = API_URL + '/api/costeos/' + window.costeoEditandoId + '/actualizar';
                    method = 'PUT';
                }
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                const data = await res.json();
                if (res.ok) {
                    let msgBase = window.costeoEditandoId ? 'Costeo actualizado exitosamente!' : 'Costeo guardado exitosamente!';
                    
                    // Info sobre cat√°logo
                    if (data.catalogo) {
                        if (data.catalogo.nuevosAgregados && data.catalogo.nuevosAgregados.length > 0) {
                            msgBase += '\n\nüì¶ Se agregaron ' + data.catalogo.nuevosAgregados.length + ' art√≠culo(s) nuevos al cat√°logo.';
                        }
                        if (data.catalogo.completados && data.catalogo.completados.length > 0) {
                            msgBase += '\n‚úÖ Se completaron ' + data.catalogo.completados.length + ' dato(s) vac√≠os en el cat√°logo.';
                        }
                    }
                    alert(msgBase);

                    // Mostrar diferencias encontradas y preguntar
                    if (data.catalogo && data.catalogo.diferencias && data.catalogo.diferencias.length > 0) {
                        mostrarDiferenciasCatalogo(data.catalogo.diferencias);
                    }

                    window.costeoEditandoId = null;
                    cerrarModal('cargaManualModal');
                    cargarCosteos();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo guardar'));
                }
            } catch (err) {
                alert('Error de conexion');
                console.error(err);
            }
        }

        // ============ CAT√ÅLOGO MAESTRO ============

        async function cargarStatsMaestro() {
            try {
                const res = await fetch(`${window.location.origin}/api/maestro/stats`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                document.getElementById('totalMaestro').textContent = data.total || 0;
                cargarProveedoresMaestro();
            } catch (e) {
                document.getElementById('totalMaestro').textContent = '0';
            }
        }

        async function cargarProveedoresMaestro() {
            try {
                const res = await fetch(`${window.location.origin}/api/maestro/proveedores`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const proveedores = await res.json();
                const datalist = document.getElementById('listaProveedoresMaestro');
                if (datalist) {
                    datalist.innerHTML = proveedores.map(p => '<option value="' + p + '">').join('');
                }
            } catch (e) {
                console.error('Error cargando proveedores maestro:', e);
            }
        }

        async function cargarMarcasDelProveedor() {
            const proveedor = document.getElementById('cm_proveedor').value;
            const select = document.getElementById('selectMarcaMaestro');
            if (!select) return;

            select.innerHTML = '<option value="">Filtrar por marca...</option>';

            if (!proveedor) return;

            try {
                const res = await fetch(`${window.location.origin}/api/maestro/marcas?proveedor=${encodeURIComponent(proveedor)}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const marcas = await res.json();
                for (const m of marcas) {
                    select.innerHTML += '<option value="' + m + '">' + m + '</option>';
                }
            } catch (e) {
                console.error('Error cargando marcas:', e);
            }
        }

        async function importarCatalogoMaestro(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const formData = new FormData();
            formData.append('archivo', file);

            try {
                // Paso 1: Previsualizar cambios
                const resPrev = await fetch(`${window.location.origin}/api/maestro/previsualizar`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                const preview = await resPrev.json();
                if (!resPrev.ok) { alert('Error: ' + (preview.error || 'No se pudo analizar')); input.value = ''; return; }

                // Armar resumen
                let msg = 'üìã RESUMEN DE IMPORTACI√ìN\n';
                msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
                msg += 'Total en Excel: ' + preview.total_excel + '\n';
                msg += 'üÜï Art√≠culos nuevos: ' + preview.nuevos.length + '\n';
                msg += '‚úÖ Datos a completar (vac√≠os): ' + (preview.completados || 0) + '\n';
                msg += '‚ö° Sin cambios: ' + preview.sin_cambios + '\n';

                if (preview.cambios && preview.cambios.length > 0) {
                    msg += '\n‚ö†Ô∏è DATOS QUE CAMBIAN (' + preview.cambios.length + ' art√≠culos):\n';
                    for (const cambio of preview.cambios.slice(0, 10)) {
                        msg += '\n' + cambio.codigo + ' - ' + cambio.nombre + ':';
                        for (const c of cambio.campos) {
                            if (c.tipo === 'cambio') {
                                msg += '\n  ' + c.campo + ': ' + c.antes + ' ‚Üí ' + c.despues;
                            }
                        }
                    }
                    if (preview.cambios.length > 10) msg += '\n... y ' + (preview.cambios.length - 10) + ' m√°s';
                }

                msg += '\n\n¬øAplicar estos cambios?';

                if (!confirm(msg)) { input.value = ''; return; }

                // Paso 2: Aplicar importaci√≥n
                const formData2 = new FormData();
                formData2.append('archivo', file);
                const res = await fetch(`${window.location.origin}/api/maestro/importar`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData2
                });
                const data = await res.json();
                if (res.ok) {
                    alert('‚úÖ Cat√°logo actualizado:\n- Nuevos: ' + data.importados + '\n- Actualizados: ' + data.actualizados + '\n- Errores: ' + data.errores);
                    cargarStatsMaestro();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo importar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n al importar cat√°logo');
                console.error(e);
            }
            input.value = '';
        }

        async function descargarCatalogo() {
            try {
                const res = await fetch(`${window.location.origin}/api/maestro/descargar`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'CATALOGO_GOODIES.xlsx';
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error al descargar cat√°logo');
                }
            } catch (e) {
                alert('Error de conexi√≥n');
                console.error(e);
            }
        }

        // Mostrar diferencias entre costeo y cat√°logo
        function mostrarDiferenciasCatalogo(diferencias) {
            let msg = '‚ö†Ô∏è DIFERENCIAS CON EL CAT√ÅLOGO\n';
            msg += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            msg += 'Se encontraron datos distintos a los del cat√°logo.\n';
            msg += '¬øQuer√©s actualizar el cat√°logo con los valores del costeo?\n\n';

            const actualizaciones = [];
            for (const dif of diferencias) {
                msg += dif.codigo + ' - ' + dif.nombre + ':\n';
                for (const c of dif.conflictos) {
                    msg += '  ' + c.label + ': cat√°logo=' + c.valor_catalogo + ' ‚Üí costeo=' + c.valor_costeo + '\n';
                    actualizaciones.push({ codigo: dif.codigo, campo: c.campo, valor: c.valor_nuevo_raw });
                }
                msg += '\n';
            }

            if (confirm(msg)) {
                // Aplicar actualizaciones confirmadas
                fetch(`${window.location.origin}/api/catalogo/actualizar-confirmado`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actualizaciones })
                }).then(r => r.json()).then(data => {
                    alert('‚úÖ Cat√°logo actualizado: ' + (data.actualizados || 0) + ' campo(s) modificados.');
                }).catch(e => console.error('Error actualizando cat√°logo:', e));
            }
        }

        async function buscarEnMaestro(idx, codigo) {
            if (!codigo || codigo.length < 3) return;
            codigo = codigo.trim().toUpperCase();
            if (['MUESTRAS','MUESTRA','POS','PENDIENTE','BBB'].includes(codigo)) return;

            try {
                const res = await fetch(`${window.location.origin}/api/maestro/buscar?q=${encodeURIComponent(codigo)}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const articulos = await res.json();
                
                const exacto = articulos.find(a => a.codigo.toUpperCase() === codigo);
                if (exacto) {
                    let cambios = [];
                    // Nombre
                    if (!articulosManual[idx].nombre || articulosManual[idx].nombre === '') {
                        articulosManual[idx].nombre = exacto.nombre;
                        cambios.push('nombre');
                    } else if (articulosManual[idx].nombre.toUpperCase().trim() !== exacto.nombre.toUpperCase().trim()) {
                        const alertaDiv = document.getElementById('maestroAlertas');
                        alertaDiv.style.display = 'block';
                        alertaDiv.innerHTML = '<div style="background:#ff9800;color:#000;padding:8px;border-radius:5px;margin-bottom:5px;">‚ö†Ô∏è ' + codigo + ': nombre actual "' + articulosManual[idx].nombre + '" ‚â† cat√°logo "' + exacto.nombre + '"</div>' + alertaDiv.innerHTML;
                    }
                    // Derechos
                    if ((!articulosManual[idx].derechos || articulosManual[idx].derechos === '') && exacto.derechos_porcentaje != null) {
                        articulosManual[idx].derechos = (parseFloat(exacto.derechos_porcentaje) * 100).toFixed(2);
                        cambios.push('derechos ' + (exacto.derechos_porcentaje * 100).toFixed(1) + '%');
                    }
                    // Imp. Interno
                    if ((!articulosManual[idx].imp_interno || articulosManual[idx].imp_interno === '') && exacto.imp_interno_porcentaje != null) {
                        articulosManual[idx].imp_interno = (parseFloat(exacto.imp_interno_porcentaje) * 100).toFixed(2);
                        cambios.push('imp.int. ' + (exacto.imp_interno_porcentaje * 100).toFixed(2) + '%');
                    }
                    // Und/Caja
                    if ((!articulosManual[idx].und_caja || articulosManual[idx].und_caja === '') && exacto.unidades_por_caja) {
                        articulosManual[idx].und_caja = exacto.unidades_por_caja;
                        cambios.push('und/caja ' + exacto.unidades_por_caja);
                    }
                    // Valor Origen
                    if ((!articulosManual[idx].valor_origen || articulosManual[idx].valor_origen === '') && exacto.ultimo_valor_origen) {
                        articulosManual[idx].valor_origen = exacto.ultimo_valor_origen;
                        cambios.push('valor ' + exacto.ultimo_valor_origen);
                    }
                    // Valor F√°brica
                    if ((!articulosManual[idx].valor_fabrica || articulosManual[idx].valor_fabrica === '') && exacto.ultimo_valor_fabrica) {
                        articulosManual[idx].valor_fabrica = exacto.ultimo_valor_fabrica;
                        cambios.push('val.fab ' + exacto.ultimo_valor_fabrica);
                    }
                    if (cambios.length > 0) {
                        renderizarArticulos();
                        const alertaDiv = document.getElementById('maestroAlertas');
                        alertaDiv.style.display = 'block';
                        alertaDiv.innerHTML = '<div style="background:#4CAF50;color:#fff;padding:8px;border-radius:5px;margin-bottom:5px;">‚úÖ ' + codigo + ': completado ‚Üí ' + cambios.join(', ') + '</div>' + alertaDiv.innerHTML;
                    } else {
                        renderizarArticulos();
                    }
                }
            } catch (e) {
                console.error('Error buscando en cat√°logo:', e);
            }
        }

        async function completarDesdeCatalogo() {
            const articulosConCodigo = articulosManual.filter(a => a.codigo_goodies && a.codigo_goodies.length >= 3);
            if (articulosConCodigo.length === 0) {
                alert('No hay art√≠culos con C√≥digo Goodies para buscar.');
                return;
            }
            let completados = 0;
            let noEncontrados = [];
            const alertaDiv = document.getElementById('maestroAlertas');
            alertaDiv.style.display = 'block';
            alertaDiv.innerHTML = '<div style="background:#2196F3;color:#fff;padding:8px;border-radius:5px;">üîç Buscando ' + articulosConCodigo.length + ' art√≠culos en cat√°logo...</div>';

            for (let i = 0; i < articulosManual.length; i++) {
                const art = articulosManual[i];
                if (!art.codigo_goodies || art.codigo_goodies.length < 3) continue;
                const codigo = art.codigo_goodies.trim().toUpperCase();
                if (['MUESTRAS','MUESTRA','POS','PENDIENTE','BBB'].includes(codigo)) continue;

                try {
                    const resCat = await fetch(`${window.location.origin}/api/catalogo/buscar/${encodeURIComponent(codigo)}`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (resCat.ok) {
                        const cat = await resCat.json();
                        let cambiosArt = [];
                        if ((!art.nombre || art.nombre === '') && cat.nombre) {
                            articulosManual[i].nombre = cat.nombre;
                            cambiosArt.push('nombre');
                        }
                        if ((!art.derechos || art.derechos === '') && cat.derechos_porcentaje != null) {
                            articulosManual[i].derechos = (parseFloat(cat.derechos_porcentaje) * 100).toFixed(2);
                            cambiosArt.push('der ' + (cat.derechos_porcentaje * 100).toFixed(2) + '%');
                        }
                        if ((!art.imp_interno || art.imp_interno === '') && cat.imp_interno_porcentaje != null) {
                            articulosManual[i].imp_interno = (parseFloat(cat.imp_interno_porcentaje) * 100).toFixed(2);
                            cambiosArt.push('imp.int ' + (cat.imp_interno_porcentaje * 100).toFixed(2) + '%');
                        }
                        if ((!art.codigo_proveedor || art.codigo_proveedor === '') && cat.codigo_elaborador) {
                            articulosManual[i].codigo_proveedor = cat.codigo_elaborador;
                            cambiosArt.push('cod.prov');
                        }
                        if ((!art.und_caja || art.und_caja === '') && cat.unidades_por_caja) {
                            articulosManual[i].und_caja = cat.unidades_por_caja;
                            cambiosArt.push('und/caja');
                        }
                        if ((!art.valor_origen || art.valor_origen === '') && cat.ultimo_valor_origen) {
                            articulosManual[i].valor_origen = cat.ultimo_valor_origen;
                            cambiosArt.push('valor');
                        }
                        if ((!art.valor_fabrica || art.valor_fabrica === '') && cat.ultimo_valor_fabrica) {
                            articulosManual[i].valor_fabrica = cat.ultimo_valor_fabrica;
                            cambiosArt.push('val.fab');
                        }
                        if (cambiosArt.length > 0) completados++;
                    } else {
                        noEncontrados.push(codigo);
                    }
                } catch (e) { noEncontrados.push(codigo); }
            }

            renderizarArticulos();
            let msg = '<div style="background:#4CAF50;color:#fff;padding:8px;border-radius:5px;margin-bottom:5px;">‚úÖ Cat√°logo: ' + completados + ' art√≠culos completados</div>';
            if (noEncontrados.length > 0) {
                msg += '<div style="background:#ff9800;color:#000;padding:8px;border-radius:5px;margin-bottom:5px;">‚ö†Ô∏è No encontrados (' + noEncontrados.length + '): ' + noEncontrados.slice(0, 10).join(', ') + (noEncontrados.length > 10 ? '...' : '') + '</div>';
            }
            alertaDiv.innerHTML = msg;
        }

        async function cargarArticulosDelProveedor() {
            const proveedor = document.getElementById('cm_proveedor').value;
            if (!proveedor) {
                alert('Primero ingrese el proveedor en Datos Generales');
                return;
            }

            try {
                const res = await fetch(`${window.location.origin}/api/maestro/por-proveedor?proveedor=${encodeURIComponent(proveedor)}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const articulos = await res.json();

                if (!articulos || articulos.length === 0) {
                    alert('No se encontraron art√≠culos para "' + proveedor + '" en el cat√°logo maestro.\n\nVerifique que el nombre del proveedor coincida con el cat√°logo.');
                    return;
                }

                if (!confirm('Se encontraron ' + articulos.length + ' art√≠culos de "' + proveedor + '".\n\n¬øCargar todos? (COMEX deber√° completar cajas, valores, derechos, etc.)')) {
                    return;
                }

                agregarArticulosDesdeMaestro(articulos);
            } catch (e) {
                alert('Error al cargar art√≠culos del proveedor');
                console.error(e);
            }
        }

        async function cargarArticulosPorMarca() {
            const marca = document.getElementById('selectMarcaMaestro').value;
            if (!marca) {
                alert('Seleccione una marca del desplegable');
                return;
            }

            const proveedor = document.getElementById('cm_proveedor').value;

            try {
                const res = await fetch(`${window.location.origin}/api/maestro/por-marca?marca=${encodeURIComponent(marca)}&proveedor=${encodeURIComponent(proveedor)}`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const articulos = await res.json();

                if (!articulos || articulos.length === 0) {
                    alert('No se encontraron art√≠culos de marca "' + marca + '"');
                    return;
                }

                if (!confirm('Se encontraron ' + articulos.length + ' art√≠culos de marca "' + marca + '".\n\n¬øCargar todos?')) {
                    return;
                }

                agregarArticulosDesdeMaestro(articulos);
            } catch (e) {
                alert('Error al cargar art√≠culos por marca');
                console.error(e);
            }
        }

        function agregarArticulosDesdeMaestro(articulos) {
            const existentes = articulosManual.map(a => (a.codigo_goodies || '').toUpperCase());
            let agregados = 0;

            for (const art of articulos) {
                if (!existentes.includes(art.codigo.toUpperCase())) {
                    articulosManual.push({
                        codigo_goodies: art.codigo,
                        codigo_proveedor: '',
                        nombre: art.nombre,
                        cajas: '',
                        und_caja: '',
                        valor_fabrica: '',
                        valor_origen: '',
                        derechos: '',
                        imp_interno: '',
                        aplica_anmat: true,
                        grupo: ''
                    });
                    agregados++;
                }
            }

            renderizarArticulos();
            alert('Se cargaron ' + agregados + ' art√≠culos nuevos.\n' + (articulos.length - agregados) + ' ya exist√≠an.\n\nComplete cajas, valores y derechos para cada uno.');
        }

        async function validarArticulosContraMaestro() {
            const articulosParaValidar = articulosManual.filter(a => a.codigo_goodies && a.nombre);
            if (articulosParaValidar.length === 0) return;

            try {
                const res = await fetch(`${window.location.origin}/api/maestro/validar`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ articulos: articulosParaValidar })
                });
                const data = await res.json();

                const alertaDiv = document.getElementById('maestroAlertas');
                if (data.alertas && data.alertas.length > 0) {
                    alertaDiv.style.display = 'block';
                    alertaDiv.innerHTML = data.alertas.map(a => 
                        '<div style="background:' + (a.tipo === 'NO_EXISTE' ? '#f44336' : '#ff9800') + ';color:#fff;padding:8px;border-radius:5px;margin-bottom:5px;">‚ö†Ô∏è ' + a.mensaje + '</div>'
                    ).join('');
                } else {
                    alertaDiv.style.display = 'none';
                    alertaDiv.innerHTML = '';
                }
            } catch (e) {
                console.error('Error validando:', e);
            }
        }

    // =============================================
    // NAVEGACI√ìN DE M√ìDULOS
    // =============================================
    function cambiarModulo(modulo) {
        ['comex','comercial','contable','admin'].forEach(m => {
            const div = document.getElementById('mod' + m.charAt(0).toUpperCase() + m.slice(1));
            const btn = document.getElementById('btnMod' + m.charAt(0).toUpperCase() + m.slice(1));
            if (div) div.style.display = m === modulo ? 'block' : 'none';
            if (btn) {
                btn.style.background = m === modulo ? '#4CAF50' : 'transparent';
                btn.style.color = m === modulo ? '#fff' : '#888';
            }
        });
        // Cargar datos del m√≥dulo al entrar
        if (modulo === 'comercial') { cargarListas().then(() => cargarAcuerdos()); }
        if (modulo === 'contable') { cargarHistorialValuaciones(); cargarRevaluacionesDisponibles(); }
    }

    // =============================================
    // M√ìDULO COMERCIAL - LISTAS DE PRECIOS
    // =============================================
    let listasPrecios = [];
    let acuerdosComerciales = [];

    async function cargarListas() {
        try {
            const resp = await fetch(API_URL + '/api/comercial/listas', { headers: { 'Authorization': 'Bearer ' + token } });
            listasPrecios = await resp.json();
            renderListas();
            actualizarSelectsListas();
        } catch(e) { console.error('Error cargando listas:', e); }
    }

    function renderListas() {
        const body = document.getElementById('listasBody');
        if (!body) return;
        body.innerHTML = listasPrecios.map(l => `<tr>
            <td>${l.nombre}</td>
            <td>${l.pct_logistico}%</td><td>${l.pct_iibb}%</td><td>${l.pct_financiero}%</td>
            <td>${l.pct_comision}%</td><td>${l.pct_margen_cliente}%</td>
            <td style="color:${l.activa ? '#4CAF50' : '#f44336'}">${l.activa ? 'S√≠' : 'No'}</td>
            <td class="actions">
                <button class="btn btn-sm btn-secondary" onclick="editarLista('${l.id}')">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-danger" onclick="eliminarLista('${l.id}')">üóëÔ∏è</button>
            </td>
        </tr>`).join('');
    }

    function actualizarSelectsListas() {
        const selects = ['acuerdoListaSelect','simLista'];
        selects.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const val = sel.value;
            sel.innerHTML = '<option value="">Seleccionar Lista...</option>' +
                listasPrecios.filter(l => l.activa).map(l => `<option value="${l.id}">${l.nombre}</option>`).join('');
            if (val) sel.value = val;
        });
    }

    async function cargarListasPorDefecto() {
        try {
            const resp = await fetch(API_URL + '/api/comercial/listas/seed', {
                method: 'POST', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
            });
            const data = await resp.json();
            alert('‚úÖ ' + (data.message || 'Listas creadas'));
            cargarListas();
        } catch(e) { alert('Error: ' + e.message); }
    }

    function abrirNuevaLista() {
        const nombre = prompt('Nombre de la lista:');
        if (!nombre) return;
        const logistico = parseFloat(prompt('% Log√≠stico:', '5')) || 0;
        const iibb = parseFloat(prompt('% IIBB:', '3.5')) || 0;
        const financiero = parseFloat(prompt('% Financiero:', '3')) || 0;
        const comision = parseFloat(prompt('% Comisi√≥n:', '0')) || 0;
        const margen = parseFloat(prompt('% Margen Cliente:', '30')) || 0;

        fetch(API_URL + '/api/comercial/listas', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, pct_logistico: logistico, pct_iibb: iibb, pct_financiero: financiero, pct_comision: comision, pct_margen_cliente: margen })
        }).then(() => cargarListas()).catch(e => alert('Error: ' + e.message));
    }

    async function editarLista(id) {
        const lista = listasPrecios.find(l => l.id === id);
        if (!lista) return;
        const nombre = prompt('Nombre:', lista.nombre);
        if (!nombre) return;
        const logistico = parseFloat(prompt('% Log√≠stico:', lista.pct_logistico)) || 0;
        const iibb = parseFloat(prompt('% IIBB:', lista.pct_iibb)) || 0;
        const financiero = parseFloat(prompt('% Financiero:', lista.pct_financiero)) || 0;
        const comision = parseFloat(prompt('% Comisi√≥n:', lista.pct_comision)) || 0;
        const margen = parseFloat(prompt('% Margen Cliente:', lista.pct_margen_cliente)) || 0;
        const activa = confirm('¬øLista activa?');

        await fetch(API_URL + '/api/comercial/listas/' + id, {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, pct_logistico: logistico, pct_iibb: iibb, pct_financiero: financiero, pct_comision: comision, pct_margen_cliente: margen, activa })
        });
        cargarListas();
    }

    async function eliminarLista(id) {
        if (!confirm('¬øEliminar esta lista?')) return;
        await fetch(API_URL + '/api/comercial/listas/' + id, {
            method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
        });
        cargarListas();
    }

    // =============================================
    // M√ìDULO COMERCIAL - ACUERDOS
    // =============================================
    async function cargarAcuerdos() {
        try {
            const resp = await fetch(API_URL + '/api/comercial/acuerdos', { headers: { 'Authorization': 'Bearer ' + token } });
            acuerdosComerciales = await resp.json();
            renderAcuerdos();
        } catch(e) { console.error('Error cargando acuerdos:', e); }
    }

    function renderAcuerdos() {
        const body = document.getElementById('acuerdosBody');
        if (!body) return;
        body.innerHTML = acuerdosComerciales.map(a => {
            const lista = listasPrecios.find(l => l.id === a.lista_id);
            return `<tr>
                <td>${lista ? lista.nombre : a.lista_id}</td>
                <td>${a.categoria}</td>
                <td>${a.pct_acuerdo}%</td>
                <td><button class="btn btn-sm btn-danger" onclick="eliminarAcuerdo('${a.id}')">üóëÔ∏è</button></td>
            </tr>`;
        }).join('');
    }

    async function agregarAcuerdo() {
        const lista_id = document.getElementById('acuerdoListaSelect').value;
        const categoria = document.getElementById('acuerdoCategoriaSelect').value;
        const pct_acuerdo = parseFloat(document.getElementById('acuerdoPct').value) || 0;
        if (!lista_id) { alert('Seleccion√° una lista'); return; }
        await fetch(API_URL + '/api/comercial/acuerdos', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ lista_id, categoria, pct_acuerdo })
        });
        cargarAcuerdos();
    }

    async function eliminarAcuerdo(id) {
        if (!confirm('¬øEliminar acuerdo?')) return;
        await fetch(API_URL + '/api/comercial/acuerdos/' + id, {
            method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
        });
        cargarAcuerdos();
    }

    // =============================================
    // M√ìDULO COMERCIAL - C√ÅLCULO M√ÅRGENES
    // =============================================
    let articulosPvp = [];
    let articulosPvpTodos = [];

    async function cargarArticulosParaMargen() {
        try {
            const resp = await fetch(API_URL + '/api/costeos/ultimos-costos', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await resp.json();
            articulosPvpTodos = (Array.isArray(data) ? data : []).map(a => ({
                codigo_goodies: a.codigo_goodies || a.codigo,
                nombre: a.nombre,
                proveedor: a.proveedor || '',
                costo_neto: parseFloat(a.costo_unitario_neto_ars || a.costo_neto) || 0,
                pvp: 0
            }));
            const proveedores = [...new Set(articulosPvpTodos.map(a => a.proveedor).filter(p => p))].sort();
            const sel = document.getElementById('filtroMargenProveedor');
            if (sel) sel.innerHTML = '<option value="">Todos los proveedores</option>' + proveedores.map(p => '<option value="' + p + '">' + p + '</option>').join('');
            articulosPvp = [...articulosPvpTodos];
            renderArticulosPvp();
            alert('‚úÖ ' + articulosPvp.length + ' art√≠culos cargados');
        } catch(e) { alert('Error: ' + e.message); }
    }

    function filtrarArticulosPvp() {
        const texto = (document.getElementById('filtroMargenTexto').value || '').toLowerCase();
        const proveedor = document.getElementById('filtroMargenProveedor').value;
        articulosPvp = articulosPvpTodos.filter(a => {
            const matchTexto = !texto || a.codigo_goodies.toLowerCase().includes(texto) || a.nombre.toLowerCase().includes(texto);
            const matchProv = !proveedor || a.proveedor === proveedor;
            return matchTexto && matchProv;
        });
        renderArticulosPvp();
    }

    function renderArticulosPvp() {
        const body = document.getElementById('articulosPvpBody');
        if (!body) return;
        body.innerHTML = articulosPvp.map((a, i) => {
            const idxAll = articulosPvpTodos.findIndex(t => t.codigo_goodies === a.codigo_goodies);
            return `<tr>
            <td>${a.codigo_goodies}</td><td>${a.nombre}</td><td>${a.proveedor}</td>
            <td>$${a.costo_neto.toFixed(2)}</td>
            <td><input type="number" step="0.01" value="${a.pvp || ''}" onchange="actualizarPvp('${a.codigo_goodies}', this.value)" style="width:100px;background:#1e1e2f;border:1px solid #444;color:#fff;padding:4px;border-radius:3px;"></td>
        </tr>`;
        }).join('');
    }

    function actualizarPvp(codigo, valor) {
        const pvp = parseFloat(valor) || 0;
        const art = articulosPvpTodos.find(a => a.codigo_goodies === codigo);
        if (art) art.pvp = pvp;
        const artFilt = articulosPvp.find(a => a.codigo_goodies === codigo);
        if (artFilt) artFilt.pvp = pvp;
    }

    function descargarTemplatePvp() {
        if (articulosPvpTodos.length === 0) { alert('Primero carg√° art√≠culos del cat√°logo'); return; }
        const wsData = [['C√≥digo', 'Nombre', 'Proveedor', 'Costo Neto', 'PVP']];
        articulosPvpTodos.forEach(a => { wsData.push([a.codigo_goodies, a.nombre, a.proveedor, a.costo_neto, '']); });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!cols'] = [{wch:18},{wch:45},{wch:20},{wch:14},{wch:14}];
        XLSX.utils.book_append_sheet(wb, ws, 'PVP');
        XLSX.writeFile(wb, 'Template_PVP_Goodies.xlsx');
    }

    function subirTemplatePvp() {
        const file = document.getElementById('pvpExcelFile').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                let cargados = 0;
                for (let i = 1; i < rows.length; i++) {
                    const codigo = String(rows[i][0] || '').trim();
                    const pvp = parseFloat(rows[i][4]) || 0;
                    if (codigo && pvp > 0) {
                        const art = articulosPvpTodos.find(a => a.codigo_goodies === codigo);
                        if (art) { art.pvp = pvp; cargados++; }
                    }
                }
                articulosPvp = [...articulosPvpTodos];
                filtrarArticulosPvp();
                alert('‚úÖ ' + cargados + ' PVPs cargados desde Excel');
            } catch(err) { alert('Error leyendo Excel: ' + err.message); }
        };
        reader.readAsArrayBuffer(file);
    }

    async function calcularMargenes() {
        const artConPvp = articulosPvpTodos.filter(a => a.pvp > 0);
        if (artConPvp.length === 0) { alert('Ingres√° al menos un PVP'); return; }

        try {
            const resp = await fetch(API_URL + '/api/comercial/calcular-margenes', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ articulos_pvp: artConPvp.map(a => ({ codigo_goodies: a.codigo_goodies, pvp: a.pvp })) })
            });
            const resultados = await resp.json();
            renderResultadoMargenes(resultados);
        } catch(e) { alert('Error: ' + e.message); }
    }

    function renderResultadoMargenes(resultados) {
        const div = document.getElementById('resultadoMargenes');
        if (!div || !resultados.length) return;

        const listas = resultados[0].margenes.map(m => m.lista_nombre);
        let html = '<div class="table-container" style="overflow-x:auto;"><table><thead><tr><th>C√≥digo</th><th>Nombre</th><th>Costo Neto</th><th>PVP</th>';
        listas.forEach(l => { html += '<th style="text-align:center;">' + l + '</th>'; });
        html += '</tr></thead><tbody>';

        resultados.forEach(r => {
            html += '<tr><td>' + r.codigo_goodies + '</td><td>' + r.nombre + '</td><td>$' + r.costo_neto.toFixed(2) + '</td><td>$' + r.pvp.toFixed(2) + '</td>';
            r.margenes.forEach(m => {
                const color = m.margen_pct < 10 ? '#f44336' : m.margen_pct < 20 ? '#ff9800' : '#4CAF50';
                html += '<td style="text-align:center;color:' + color + ';font-weight:bold;">' + m.margen_pct.toFixed(1) + '%<br><span style="font-size:10px;color:#888;">Neto: $' + m.ingreso_neto.toFixed(0) + '</span></td>';
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        div.innerHTML = html;
    }

    function exportarMargenes() {
        alert('Funci√≥n de exportaci√≥n en desarrollo');
    }

    // =============================================
    // M√ìDULO COMERCIAL - SIMULADOR DESCUENTO
    // =============================================
    async function simularDescuento() {
        const codigo = document.getElementById('simArticulo').value;
        const lista_id = document.getElementById('simLista').value;
        const precio = parseFloat(document.getElementById('simPrecio').value) || 0;
        const cantidad = parseInt(document.getElementById('simCantidad').value) || 0;

        if (!codigo || !lista_id || !precio || !cantidad) { alert('Complet√° todos los campos'); return; }

        try {
            const resp = await fetch(API_URL + '/api/comercial/simular-descuento', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ codigo_goodies: codigo, lista_id, precio_actual: precio, cantidad_actual: cantidad })
            });
            const data = await resp.json();
            renderSimulador(data);
        } catch(e) { alert('Error: ' + e.message); }
    }

    function renderSimulador(data) {
        const div = document.getElementById('resultadoSimulador');
        if (!div) return;

        let html = '<div style="background:#2a2a3e;padding:15px;border-radius:8px;margin-bottom:15px;">';
        html += '<p style="color:#4CAF50;font-weight:bold;">' + data.nombre + ' | Lista: ' + data.lista_nombre + '</p>';
        html += '<p style="color:#aaa;">Costo Neto: $' + data.costo_neto.toFixed(2) + ' | Ingreso Neto Actual: $' + data.ingreso_neto_actual.toFixed(2) + '</p>';
        html += '<p style="color:#aaa;">Ganancia Unit: $' + data.ganancia_unit_actual.toFixed(2) + ' | Ganancia Total: $' + data.ganancia_total_actual.toFixed(2) + '</p>';
        html += '</div>';

        html += '<table><thead><tr><th>Aumento Volumen</th><th>Nueva Cantidad</th><th>Precio M√≠nimo</th><th style="color:#4CAF50;">Descuento M√°ximo</th><th>Ganancia Total</th></tr></thead><tbody>';
        data.escenarios.forEach(e => {
            html += '<tr><td>+' + e.aumento_volumen_pct + '%</td><td>' + e.nueva_cantidad + '</td><td>$' + e.precio_minimo.toFixed(2) + '</td>';
            html += '<td style="color:#4CAF50;font-weight:bold;font-size:16px;">' + e.descuento_max_pct.toFixed(1) + '%</td>';
            html += '<td>$' + e.ganancia_total_nueva.toFixed(2) + '</td></tr>';
        });
        html += '</tbody></table>';

        div.innerHTML = html;
    }

    // =============================================
    // M√ìDULO CONTABLE - VALUACIONES
    // =============================================
    async function cargarRevaluacionesDisponibles() {
        try {
            const resp = await fetch(API_URL + '/api/contable/revaluaciones-disponibles', { headers: { 'Authorization': 'Bearer ' + token } });
            const revs = await resp.json();
            const sel = document.getElementById('valRevaluacion');
            if (!sel) return;
            sel.innerHTML = '<option value="">√öltimo costo original</option>' +
                revs.map(r => `<option value="${r.id}">${r.motivo} (${new Date(r.fecha_revaluacion).toLocaleDateString()}) - TC USD: ${r.tc_usd_nuevo}</option>`).join('');
        } catch(e) { console.error('Error:', e); }
    }

    let articulosCentumCargados = [];

    async function parsearExcelCentum() {
        const fileInput = document.getElementById('valExcelFile');
        const file = fileInput.files[0];
        if (!file) { alert('Seleccion√° un archivo Excel'); return; }

        const formData = new FormData();
        formData.append('archivo', file);

        try {
            const resp = await fetch(API_URL + '/api/contable/parsear-excel', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });
            const data = await resp.json();
            if (data.error) { alert('Error: ' + data.error); return; }

            articulosCentumCargados = data.articulos;
            const preview = document.getElementById('valExcelPreview');
            preview.innerHTML = '<div style="background:#1a3a1a;border:1px solid #4CAF50;padding:10px;border-radius:5px;">' +
                '<span style="color:#4CAF50;font-weight:bold;">‚úÖ ' + data.total_articulos + ' art√≠culos cargados desde "' + data.hoja + '"</span>' +
                '<div style="max-height:200px;overflow-y:auto;margin-top:10px;"><table><thead><tr><th>C√≥digo</th><th>Nombre</th><th>Cantidad</th><th>Costo Unit</th><th>Costo Total</th></tr></thead><tbody>' +
                data.articulos.slice(0, 20).map(a => '<tr><td>' + a.codigo_goodies + '</td><td>' + a.descripcion + '</td><td>' + a.cantidad + '</td><td>$' + a.costo_unit_contable.toFixed(2) + '</td><td>$' + a.costo_total_contable.toFixed(2) + '</td></tr>').join('') +
                (data.articulos.length > 20 ? '<tr><td colspan="5" style="color:#888;">... y ' + (data.articulos.length - 20) + ' m√°s</td></tr>' : '') +
                '</tbody></table></div></div>';
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function crearValuacion() {
        const nombre = document.getElementById('valNombre').value;
        if (!nombre) { alert('Ingres√° un nombre para la valuaci√≥n'); return; }

        const revaluacion_id = document.getElementById('valRevaluacion').value || null;
        let articulos_centum = [];

        // Prioridad: datos del Excel cargado, si no, texto pegado
        if (articulosCentumCargados.length > 0) {
            articulos_centum = articulosCentumCargados;
        } else {
            const texto = document.getElementById('valDatosCentum').value.trim();
            if (!texto) { alert('Sub√≠ un Excel de Centum o peg√° los datos manualmente'); return; }
            const lineas = texto.split('\n').filter(l => l.trim());
            articulos_centum = lineas.map(l => {
                const cols = l.split('\t');
                if (cols.length < 4) return null;
                return {
                    codigo_goodies: cols[0].trim(),
                    descripcion: cols[1] ? cols[1].trim() : '',
                    cantidad: parseFloat((cols[2] || '0').replace(',', '.')) || 0,
                    costo_unit_contable: parseFloat((cols[3] || '0').replace(',', '.')) || 0,
                    costo_total_contable: cols[4] ? parseFloat(cols[4].replace(',', '.')) || 0 : 0
                };
            }).filter(a => a && a.codigo_goodies);
        }

        if (articulos_centum.length === 0) { alert('No se encontraron art√≠culos v√°lidos.'); return; }

        try {
            const resp = await fetch(API_URL + '/api/contable/valuaciones', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, revaluacion_id, articulos_centum })
            });
            const data = await resp.json();
            if (data.error) { alert('Error: ' + data.error); return; }
            renderResultadoValuacion(data);
            cargarHistorialValuaciones();
            articulosCentumCargados = [];
        } catch(e) { alert('Error: ' + e.message); }
    }

    function renderResultadoValuacion(data) {
        document.getElementById('resultadoValuacionCard').style.display = 'block';

        const res = data.resumen || data.valuacion;
        const resDiv = document.getElementById('resumenValuacion');
        const totalContable = parseFloat(res.total_contable) || 0;
        const totalRevaluado = parseFloat(res.total_revaluado) || 0;
        const diferencia = parseFloat(res.diferencia) || 0;
        const colorDif = diferencia >= 0 ? '#4CAF50' : '#f44336';

        resDiv.innerHTML = `
            <div style="padding:15px;background:#2a2a3e;border-radius:8px;"><div style="color:#888;font-size:12px;">Total Contable</div><div style="color:#fff;font-size:20px;font-weight:bold;">$${totalContable.toLocaleString('es-AR', {minimumFractionDigits:2})}</div></div>
            <div style="padding:15px;background:#2a2a3e;border-radius:8px;"><div style="color:#888;font-size:12px;">Total Revaluado</div><div style="color:#2196F3;font-size:20px;font-weight:bold;">$${totalRevaluado.toLocaleString('es-AR', {minimumFractionDigits:2})}</div></div>
            <div style="padding:15px;background:#2a2a3e;border-radius:8px;"><div style="color:#888;font-size:12px;">Diferencia (Ajuste)</div><div style="color:${colorDif};font-size:20px;font-weight:bold;">$${diferencia.toLocaleString('es-AR', {minimumFractionDigits:2})}</div></div>
            <div style="padding:15px;background:#2a2a3e;border-radius:8px;"><div style="color:#888;font-size:12px;">Art√≠culos</div><div style="color:#fff;font-size:16px;">‚Üë ${res.art_dif_positiva || 0} positiva / ‚Üì ${res.art_dif_negativa || 0} negativa</div></div>
        `;

        const body = document.getElementById('valuacionDetalleBody');
        body.innerHTML = (data.detalle || []).map(d => {
            const colorPct = d.diferencia_pct > 0 ? '#4CAF50' : d.diferencia_pct < 0 ? '#f44336' : '#888';
            return `<tr>
                <td>${d.codigo_goodies}</td><td>${d.descripcion}</td><td>${d.cantidad}</td>
                <td>$${parseFloat(d.costo_unit_contable).toFixed(2)}</td><td>$${parseFloat(d.costo_total_contable).toFixed(2)}</td>
                <td>$${parseFloat(d.costo_unit_revaluado).toFixed(2)}</td><td>$${parseFloat(d.costo_total_revaluado).toFixed(2)}</td>
                <td style="color:${colorPct}">$${parseFloat(d.diferencia_unit).toFixed(2)}</td>
                <td style="color:${colorPct}">$${parseFloat(d.diferencia_total).toFixed(2)}</td>
                <td style="color:${colorPct};font-weight:bold;">${parseFloat(d.diferencia_pct).toFixed(1)}%</td>
            </tr>`;
        }).join('');
    }

    async function cargarHistorialValuaciones() {
        try {
            const resp = await fetch(API_URL + '/api/contable/valuaciones', { headers: { 'Authorization': 'Bearer ' + token } });
            const valuaciones = await resp.json();
            const body = document.getElementById('historialValuacionesBody');
            if (!body) return;
            body.innerHTML = valuaciones.map(v => `<tr>
                <td>${new Date(v.created_at).toLocaleDateString()}</td>
                <td>${v.nombre}</td>
                <td>$${parseFloat(v.total_contable).toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                <td>$${parseFloat(v.total_revaluado).toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                <td style="color:${parseFloat(v.diferencia) >= 0 ? '#4CAF50' : '#f44336'}">$${parseFloat(v.diferencia).toLocaleString('es-AR', {minimumFractionDigits:2})}</td>
                <td>${v.cantidad_articulos}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-secondary" onclick="verValuacion('${v.id}')">üëÅÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarValuacion('${v.id}')">üóëÔ∏è</button>
                </td>
            </tr>`).join('');
        } catch(e) { console.error('Error:', e); }
    }

    async function verValuacion(id) {
        try {
            const resp = await fetch(API_URL + '/api/contable/valuaciones/' + id, { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await resp.json();
            renderResultadoValuacion({ valuacion: data.valuacion, detalle: data.detalle, resumen: data.valuacion });
        } catch(e) { alert('Error: ' + e.message); }
    }

    async function eliminarValuacion(id) {
        if (!confirm('¬øEliminar esta valuaci√≥n?')) return;
        await fetch(API_URL + '/api/contable/valuaciones/' + id, {
            method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
        });
        cargarHistorialValuaciones();
    }

    function exportarValuacion() {
        alert('Funci√≥n de exportaci√≥n en desarrollo');
    }

    // Cargar art√≠culos en el select del simulador
    async function cargarArticulosSimulador() {
        try {
            const resp = await fetch(API_URL + '/api/costeos/ultimos-costos', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await resp.json();
            const sel = document.getElementById('simArticulo');
            if (!sel) return;
            const arts = Array.isArray(data) ? data : [];
            sel.innerHTML = '<option value="">Seleccionar...</option>' +
                arts.map(a => `<option value="${a.codigo_goodies || a.codigo}">${a.codigo_goodies || a.codigo} - ${a.nombre}</option>`).join('');
        } catch(e) { console.error(e); }
    }

    // Override mostrarApp to also load simulator data
    const _mostrarAppOriginal = mostrarApp;
    function mostrarApp() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('userName').textContent = usuario.nombre;
        cargarCosteos(); cargarUltimosCostos(); cargarHistorialRevaluaciones(); cargarStatsMaestro();
        // Pre-cargar datos para m√≥dulos nuevos
        setTimeout(() => { cargarArticulosSimulador(); }, 2000);
    }

    </script>
<!-- Modal Comparativo Consolidado -->
<div id="modalConsolidado" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; overflow:auto;">
    <div style="background:#1e1e1e; margin:50px auto; padding:30px; max-width:800px; border-radius:10px; border:1px solid #444;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:#4fc3f7;">üì¶ Costeo Consolidado - Comparativo de M√©todos</h2>
            <button onclick="cerrarModalConsolidado()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <div id="consolidadoLoading" style="text-align:center; padding:40px;">
            <p>Cargando comparativo...</p>
        </div>
        
        <div id="consolidadoContenido" style="display:none;">
            <!-- Resumen de proveedores -->
            <div style="background:#2d2d2d; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h3 style="margin-top:0; color:#81c784;">Proveedores en el Consolidado</h3>
                <div id="resumenProveedores"></div>
            </div>
            
            <!-- Tabla comparativa -->
            <div style="background:#2d2d2d; padding:15px; border-radius:8px; margin-bottom:20px;">
                <h3 style="margin-top:0; color:#81c784;">Comparativo de M√©todos de Prorrateo</h3>
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#333;">
                            <th style="padding:12px; text-align:left; border-bottom:2px solid #555;">M√©todo</th>
                            <th style="padding:12px; text-align:center; border-bottom:2px solid #555;">Tu Participaci√≥n</th>
                            <th style="padding:12px; text-align:right; border-bottom:2px solid #555;">Gastos Estimados</th>
                            <th style="padding:12px; text-align:center; border-bottom:2px solid #555;">Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom:1px solid #444;">
                            <td style="padding:12px;"><strong>Por FOB (Valor)</strong><br><small style="color:#888;">Seg√∫n valor de factura</small></td>
                            <td id="partFOB" style="padding:12px; text-align:center; font-size:18px; font-weight:bold;"></td>
                            <td id="gastosFOB" style="padding:12px; text-align:right;"></td>
                            <td style="padding:12px; text-align:center;">
                                <button onclick="calcularConMetodo('fob')" class="btn-metodo" style="background:#4caf50; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Usar FOB</button>
                            </td>
                        </tr>
                        <tr style="border-bottom:1px solid #444;">
                            <td style="padding:12px;"><strong>Por Volumen (m¬≥)</strong><br><small style="color:#888;">Seg√∫n espacio ocupado</small></td>
                            <td id="partVolumen" style="padding:12px; text-align:center; font-size:18px; font-weight:bold;"></td>
                            <td id="gastosVolumen" style="padding:12px; text-align:right;"></td>
                            <td style="padding:12px; text-align:center;">
                                <button id="btnVolumen" onclick="calcularConMetodo('volumen')" class="btn-metodo" style="background:#2196f3; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Usar Volumen</button>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding:12px;"><strong>Por Peso (Kg)</strong><br><small style="color:#888;">Seg√∫n peso de mercader√≠a</small></td>
                            <td id="partPeso" style="padding:12px; text-align:center; font-size:18px; font-weight:bold;"></td>
                            <td id="gastosPeso" style="padding:12px; text-align:right;"></td>
                            <td style="padding:12px; text-align:center;">
                                <button id="btnPeso" onclick="calcularConMetodo('peso')" class="btn-metodo" style="background:#ff9800; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Usar Peso</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Info gastos -->
            <div style="background:#1a3a1a; padding:15px; border-radius:8px; border:1px solid #2d5a2d;">
                <p style="margin:0;"><strong>üí° Gastos a prorratear:</strong> <span id="gastosAProrratear">$0</span></p>
                <p style="margin:5px 0 0 0; color:#888;"><small>Solo los gastos marcados con "Consol." se dividen entre proveedores. El resto se asigna 100% a este costeo.</small></p>
            </div>
        </div>
    </div>
</div>
<!-- Modal Comparativo Participaciones -->
<div id="consolidadoCompModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3000; justify-content:center; align-items:center;">
    <div style="background:#1e1e2f; padding:25px; border-radius:10px; max-width:600px; width:90%; border:1px solid #4CAF50;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:#4CAF50;">üìä Comparativo de Participaciones</h3>
            <button onclick="document.getElementById('consolidadoCompModal').style.display='none'" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div id="comparativoModalBody"></div>
    </div>
</div>
</body>
</html>
